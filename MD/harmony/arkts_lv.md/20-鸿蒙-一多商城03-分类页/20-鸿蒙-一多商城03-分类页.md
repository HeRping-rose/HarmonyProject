# 三、分类模块

# 1. 分类

## 1.1. 整合页面结构

实现分类页的效果

 

**需求：**

1. 顶部导航栏抽取
2. 数据渲染
3. 交互效果

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717514933892-b2f6a4b0-315c-4b4f-80d8-367724de6e48.png)

1. **注：**

   1. 需要导入 common/basic才可以保证颜色正常解析

   ```ts
   features/category/oh-package.json5
   
   {
     "name": "category",
     "version": "1.0.0",
     "description": "Please describe the basic information.",
     "main": "Index.ets",
     "author": "",
     "license": "Apache-2.0",
     "packageType": "InterfaceHar",
     "dependencies": {
       "basic": "file:../../commons/basic"
     }
   }
   ```

   

   ```ts
   features/category/src/main/ets/views/CategoryView.ets
   
   import { AppBreakPoint, AppSafeArea, CategoryItem, CategoryItemChild } from 'basic'
   import { AppStorageV2 } from '@kit.ArkUI'
   
   @ComponentV2
   export struct CategoryView {
     breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
     safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
     //  Mock分类数据
     categories: CategoryItem[] = new Array(10).fill({
       id: "1181622001",
       name: "气质女装",
       picture: "https://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/meikou/c1/qznz.png"
     })
     @Local activeIndex: number = 0
   
     build() {
       Column() {
         // MkNavbar({
         // })
         //   .border({ width: { bottom: 0.5 }, color: $r('[basic].color.under') })
   
         Row() {
           Column() {
             ForEach(this.categories, (item: CategoryItem, i) => {
               Text(item.name)// 文本
                 .backgroundColor(this.activeIndex === i ? $r('[basic].color.black') : $r('[basic].color.white'))
                 .fontSize(14)
                 .fontColor(this.activeIndex === i ? $r('[basic].color.white') : $r('[basic].color.black'))
                 .textAlign(TextAlign.Center)
                 .width('100%')
                 .height(56)
                 .onClick(() => {
                   this.activeIndex = i
                 })
   
             })
           }
           .width(88)
           .border({ width: { right: 0.5 }, color: $r('[basic].color.under') })
   
           Scroll() {
             Column() {
               // 顶部图片
               Image('https://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/meikou/c1/qznz.png')
                 .width('100%')
                 .height(136)
                 .objectFit(ImageFit.Contain)
                 .backgroundColor('#f6f6f6')
                 .borderRadius(8)
                 .margin({ bottom: 8 })
               GridRow({ columns: 2, gutter: 8 }) {
                 // 子分类
                 ForEach(Array.from({ length: 10 }), (sub: CategoryItemChild) => {
                   GridCol() {
                     Column() {
                       // 图片
                       Image('https://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/meikou/c2/qznz_bq.png?quality=95&imageView')
                         .width(64)
                         .aspectRatio(1)
                       Text('半裙')// 文本
                         .fontSize(14)
                         .fontColor($r('[basic].color.text'))
                         .margin({ top: 8 })
                     }
                     .height('100%')
                     .justifyContent(FlexAlign.Center)
                   }
                   .aspectRatio(1)
                   .backgroundColor('#f6f6f6')
                   .borderRadius(8)
                 })
               }
             }
             .padding(8)
           }
           .layoutWeight(1)
           .scrollBar(BarState.Off)
           .edgeEffect(EdgeEffect.Spring)
         }
         .layoutWeight(1)
         .alignItems(VerticalAlign.Top)
       }
       .width('100%')
       .height('100%')
     }
   }
   ```

   - 将ForEach换成Repeat

   ```typescript
     Repeat<CategoryItem>(this.categories)
               .each((obj: RepeatItem<CategoryItem>) => {
                 Text(obj.item.name)// 文本
                   .backgroundColor(this.activeIndex === obj.index ? $r('[basic].color.black') : $r('[basic].color.white'))
                   .fontSize(14)
                   .fontColor(this.activeIndex === obj.index ? $r('[basic].color.white') : $r('[basic].color.black'))
                   .textAlign(TextAlign.Center)
                   .width('100%')
                   .height(56)
                   .onClick(() => {
                     this.activeIndex = obj.index
                   })
               })
   ```

   ![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743123679796-9787347d-8ca4-4d89-836f-3243a23c1a3f.png)



## 1.2. HDMNavBar抽取

来完成顶部的结构，将他抽取为组件

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717514270018-d897d7e9-5fc9-4855-8131-3f6d6eb07f7f.png)

1. 组件抽取到哪里？

1. 1. common

1. 定义哪些属性让外部传入？

1. 1. 标题
   2. 左侧图标及是否显示
   3. 左侧的点击事件
   4. 右侧图标及是否显示
   5. 右侧的点击事件
   6. builderParams,用来接收结构（UI）



![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717517114209-4c1efb57-6ab8-45b4-af2f-8436cb445d53.png)



| **属性名**    | **类型**      | **说明**           | **默认值**      |
| ------------- | ------------- | ------------------ | --------------- |
| title         | string        | 标题               | 空字符串        |
| leftIcon      | ResourceStr   | 左侧图标           | ic_public_left  |
| rightIcon     | ResourceStr   | 右侧图标           | ic_public_more  |
| showLeftIcon  | boolean       | 是否显示左侧图标   | true            |
| showRightIcon | boolean       | 是否显示右侧图标   | false           |
| color         | ResourceColor | 文字+图标颜色      | app.color.black |
| bgColor       | ResourceColor | 背景颜色           | app.color.white |
| onLeftClick   | ()=>void      | 点击左侧图标逻辑   | ()=>{}          |
| onRightClick  | ()=>void      | 点击右侧图标逻辑   | ()=>{}          |
| customTitle   | BuilderParam  | 自定义中间标题区域 | 文本标题        |

- 先声明属性

```ts
 // 引入安全区高度
  appSafe: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  @Param
  title: string = ""
  @Param
  leftIcon: ResourceStr = $r("app.media.ic_public_left")
  @Param
  rightIcon: ResourceStr = $r("app.media.ic_public_more")
  @Param
  showLeftIcon: boolean = true
  @Param
  showRightIcon: boolean = false
  @Param
  color: ResourceColor = $r("app.color.black")
  @Param
  bgColor: ResourceColor = $r("app.color.white")
  @Event
  onLeftClick: () => void = () => {
  }
  @Event
  onRightClick: () => void = () => {
  }
  @BuilderParam
  customTitle: () => void = this.defaultBuilder

  @Builder
  defaultBuilder() {
  }
```

![image.png](https://cdn.nlark.com/yuque/0/2025/png/38706227/1747206616736-c6c4bfa1-c7b4-4009-9b5a-1fb957d53307.png?x-oss-process=image%2Fformat%2Cwebp)



**参考代码:**

```ts
commons/basic/src/main/ets/components/HDMNavBar.ets

import { AppSafeArea } from "../viewmodels"
import { AppStorageV2 } from "@kit.ArkUI"

@Preview
@ComponentV2
export struct HDMNavBar {
  // 引入安全区高度
  appSafe: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  @Param
  title: string = "标题"
  @Param
  leftIcon: ResourceStr = $r("app.media.ic_public_left")
  @Param
  rightIcon: ResourceStr = $r("app.media.ic_public_more")
  @Param
  showLeftIcon: boolean = true
  @Param
  showRightIcon: boolean = true
  @Param
  color: ResourceColor = $r("app.color.black")
  @Param
  bgColor: ResourceColor = $r("app.color.white")
  @Event
  onLeftClick: () => void = () => {
  }
  @Event
  onRightClick: () => void = () => {
  }
  @BuilderParam
  customTitle: () => void = this.defaultBuilder

  @Builder
  defaultBuilder() {
  }

  build() {
    RelativeContainer() {
      if (this.showLeftIcon) {
        Image(this.leftIcon)
          .fillColor(this.color)
          .width(30)
          .aspectRatio(1)
          .alignRules({
            center: {
              anchor: "__container__",
              align: VerticalAlign.Center
            }
          })
          .onClick(() => {
            this.onLeftClick()
          })
      }
      if (this.showRightIcon) {
        Image(this.rightIcon)
          .width(30)
          .aspectRatio(1)
          .fillColor(this.color)
          .alignRules({
            center: {
              anchor: "__container__",
              align: VerticalAlign.Center
            },
            right: {
              anchor: "__container__",
              align: HorizontalAlign.End
            }
          })
          .onClick(() => {
            this.onRightClick()
          })
      }
      if (this.title) {
        Text(this.title)
          .fontColor(this.color)
          .alignRules({
            center: {
              anchor: "__container__",
              align: VerticalAlign.Center
            },
            middle: {
              anchor: "__container__",
              align: HorizontalAlign.Center
            }
          })
          .fontWeight(FontWeight.Bold)
      }
      if (this.customTitle) {
        this.customTitle() // 传入的UI结构
      }
    }
    .padding({
      top: this.appSafe.topHeight,
      left: 10,
      right: 10
    })
    .width("100%")
    .height(50 + this.appSafe.topHeight)
    .backgroundColor(this.bgColor)

  }
}
```

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1730790921103-5519c70a-8091-4374-9d2c-b54d6eaef107.png)

```typescript
features/category/src/main/ets/views/CategoryView.ets

import { AppBreakPoint, AppSafeArea, CategoryItem, CategoryItemChild, HDMNavBar } from 'basic'
import { AppStorageV2, PersistenceV2 } from '@kit.ArkUI'

@ComponentV2
export struct CategoryView {
  breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  //  Mock分类数据
  categories: CategoryItem[] = new Array(10).fill({
    id: "1181622001",
    name: "气质女装",
    picture: "https://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/meikou/c1/qznz.png"
  })
  @Local activeIndex: number = 0

  build() {
    Column() {
      HDMNavBar({
        title: '分类',
        showLeftIcon: false,
        showRightIcon: true,
        rightIcon: $r("[basic].media.ic_public_search")
      })
      Row() {
        Column() {
          Repeat<CategoryItem>(this.categories)
            .each((obj: RepeatItem<CategoryItem>) => {
              Text(obj.item.name)// 文本
                .backgroundColor(this.activeIndex === obj.index ? $r('[basic].color.black') : $r('[basic].color.white'))
                .fontSize(14)
                .fontColor(this.activeIndex === obj.index ? $r('[basic].color.white') : $r('[basic].color.black'))
                .textAlign(TextAlign.Center)
                .width('100%')
                .height(56)
                .onClick(() => {
                  this.activeIndex = obj.index
                })
            })
          // ForEach(this.categories, (item: CategoryItem, i) => {
          //
          //
          // })
        }
        .width(88)
        .border({ width: { right: 0.5 }, color: $r('[basic].color.under') })

        Scroll() {
          Column() {
            // 顶部图片
            Image('https://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/meikou/c1/qznz.png')
              .width('100%')
              .height(136)
              .objectFit(ImageFit.Contain)
              .backgroundColor('#f6f6f6')
              .borderRadius(8)
              .margin({ bottom: 8 })
            GridRow({ columns: 2, gutter: 8 }) {
              // 子分类
              ForEach(Array.from({ length: 10 }), (sub: CategoryItemChild) => {
                GridCol() {
                  Column() {
                    // 图片
                    Image('https://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/meikou/c2/qznz_bq.png?quality=95&imageView')
                      .width(64)
                      .aspectRatio(1)
                    Text('半裙')// 文本
                      .fontSize(14)
                      .fontColor($r('[basic].color.text'))
                      .margin({ top: 8 })
                  }
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                }
                .aspectRatio(1)
                .backgroundColor('#f6f6f6')
                .borderRadius(8)
              })
            }
          }
          .padding(8)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .height('100%')
  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743127033161-06b18c07-f1d3-4767-b12b-d0be28d94f4c.png)





## 1.3. 数据获取及交互效果

**需求：**

1. 将 Home 获取到的分类数据渲染到分类页

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717517176400-e8d1dfa1-d422-4871-9782-60c3afcd5cb2.png)

1. 数据在 features/home中已经获取，如何在 features/category 中拿到？
2. 数据和页面的对应关系较为繁琐，渲染时需注意
3. 高亮效果已经实现，切换数据即可

- 定义全局状态class

```typescript
commons/basic/src/main/ets/viewmodels/common.ets

// 存储当前共享的分类数据
@ObservedV2
export class AppCategory {
  @Trace
  category: CategoryItem[] = []
}
```

- 在HomeView中获取分类数据共享到全局状态

```ts
  features/home/src/main/ets/views/HomeView.ets
  
  async getHomeData(first?: boolean) {
    this.loading = !!first
    // this.banners = await getBannerAPI()
    // this.categories = await getCategoryAPI()
    // const result = await getHotResultAPI()
    // this.saleGoods = result.subTypes?.[0]?.goodsItems?.items || []
    // this.hotGoods = (await getInVogueAPI()).subTypes?.[0]?.goodsItems?.items || []
    // this.oneGoods = (await getOneStopAPI()).subTypes?.[0]?.goodsItems?.items || []
    // this.newGoods = await getHomeNewAPI()
    // Promise.all(所有的都成功)
    // Promise.allSettled(所有的都有结果)
    // pending fulfilled rejected
    const result =
      await Promise.allSettled([getBannerAPI(), getCategoryAPI(), getHotResultAPI(), getInVogueAPI(), getOneStopAPI(),
        getHomeNewAPI()])
    if (result[0].status === "fulfilled") {
      this.banners = result[0].value
    }
    if (result[1].status === "fulfilled") {
      this.categories = result[1].value
      const app = AppStorageV2.connect(AppCategory, () => new AppCategory())!
      app.category = result[1].value // 赋值数据
    }
    if (result[2].status === "fulfilled") {
      this.saleGoods = result[2].value?.subTypes?.[0]?.goodsItems?.items || []
      //this.saleGoods = result[2].value
    }
    if (result[3].status === "fulfilled") {
      this.hotGoods = result[3].value?.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[4].status === "fulfilled") {
      this.oneGoods = result[4].value?.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[5].status === "fulfilled") {
      this.newGoods = result[5].value
    }
    this.loading = false
  }
```

- 在分类组件中实现替换数据

ForEach换成了Repeat

```ts
features/category/src/main/ets/views/CategoryView/CategoryView.ets

import { AppBreakPoint, AppCategory, AppSafeArea, CategoryItem, CategoryItemChild, HDMNavBar } from 'basic'
import { AppStorageV2, PersistenceV2 } from '@kit.ArkUI'

@ComponentV2
export struct CategoryView {
  breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  //  Mock分类数据
  appCategory: AppCategory = AppStorageV2.connect(AppCategory, () => new AppCategory())!
  @Local activeIndex: number = 0 // 当前有个数组 {} 当前激活选项

  build() {
    Column() {
      HDMNavBar({
        title: '分类',
        showLeftIcon: false,
        showRightIcon: true,
        rightIcon: $r("[basic].media.ic_public_search")
      })
      Row() {
        Column() {
          Repeat<CategoryItem>(this.appCategory.category)
            .each((obj: RepeatItem<CategoryItem>) => {
              Text(obj.item.name)// 文本
                .backgroundColor(this.activeIndex === obj.index ? $r('[basic].color.black') : $r('[basic].color.white'))
                .fontSize(14)
                .fontColor(this.activeIndex === obj.index ? $r('[basic].color.white') : $r('[basic].color.black'))
                .textAlign(TextAlign.Center)
                .width('100%')
                .height(56)
                .onClick(() => {
                  this.activeIndex = obj.index
                })
            })
          // ForEach(this.categories, (item: CategoryItem, i) => {
          //
          //
          // })
        }
        .width(88)
        .border({ width: { right: 0.5 }, color: $r('[basic].color.under') })

        Scroll() {
          Column() {
            // 顶部图片
            Image(this.appCategory.category[this.activeIndex].picture)
              .width('100%')
              .height(136)
              .objectFit(ImageFit.Contain)
              .backgroundColor('#f6f6f6')
              .borderRadius(8)
              .margin({ bottom: 8 })
            GridRow({ columns: 2, gutter: 8 }) {
              // 子分类
              Repeat<CategoryItemChild>(this.appCategory.category[this.activeIndex]?.children || [])
                .each((obj: RepeatItem<CategoryItemChild>) => {
                  GridCol() {
                    Column() {
                      // 图片
                      Image(obj.item.picture)
                        .width(64)
                        .aspectRatio(1)
                      Text(obj.item.name)// 文本
                        .fontSize(14)
                        .fontColor($r('[basic].color.text'))
                        .margin({ top: 8 })
                    }
                    .height('100%')
                    .justifyContent(FlexAlign.Center)
                  }
                  .aspectRatio(1)
                  .backgroundColor('#f6f6f6')
                  .borderRadius(8)
                })
              // ForEach(this.appCategory.category[this.activeIndex]?.children || [], (sub: CategoryItemChild) => {
              //   GridCol() {
              //     Column() {
              //       // 图片
              //       Image(sub.picture)
              //         .width(64)
              //         .aspectRatio(1)
              //       Text(sub.name)// 文本
              //         .fontSize(14)
              //         .fontColor($r('[basic].color.text'))
              //         .margin({ top: 8 })
              //     }
              //     .height('100%')
              //     .justifyContent(FlexAlign.Center)
              //   }
              //   .aspectRatio(1)
              //   .backgroundColor('#f6f6f6')
              //   .borderRadius(8)
              // })
            }
          }
          .padding(8)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .height('100%')
  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743128882559-d039fbbe-80bb-4bd8-b916-730d775ced5b.png)



## 1.4. 界面适配

**需求：**

1. 顶部图片：

1. 1. sm:136
   2. md，lg：316

1. 图片列数：

1. 1. sm:2
   2. md,lg:4(或者 md 设置为 3)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717780752839-a93c1f19-12b7-4fa4-8f1f-0475bf0ee0a7.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717550539476-8b7b2ac4-185e-4de6-b4dc-fb09fdca03c3.png)![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717550554591-02aad285-b896-4205-b20f-f33891dcf49c.png)

```ts
features/category/src/main/ets/views/CategoryView.ets

import {
  AppBreakPoint,
  AppCategory,
  AppSafeArea,
  BreakPointType,
  CategoryItem,
  CategoryItemChild,
  HDMNavBar
} from 'basic'
import { AppStorageV2, PersistenceV2 } from '@kit.ArkUI'

@ComponentV2
export struct CategoryView {
  breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  //  Mock分类数据
  appCategory: AppCategory = AppStorageV2.connect(AppCategory, () => new AppCategory())!
  @Local activeIndex: number = 0 // 当前有个数组 {} 当前激活选项

  build() {
    Column() {
      HDMNavBar({
        title: '分类',
        showLeftIcon: false,
        showRightIcon: true,
        rightIcon: $r("[basic].media.ic_public_search")
      })
      Row() {
        Column() {
          Repeat<CategoryItem>(this.appCategory.category)
            .each((obj: RepeatItem<CategoryItem>) => {
              Text(obj.item.name)// 文本
                .backgroundColor(this.activeIndex === obj.index ? $r('[basic].color.black') : $r('[basic].color.white'))
                .fontSize(14)
                .fontColor(this.activeIndex === obj.index ? $r('[basic].color.white') : $r('[basic].color.black'))
                .textAlign(TextAlign.Center)
                .width('100%')
                .height(56)
                .onClick(() => {
                  this.activeIndex = obj.index
                })
            })
          // ForEach(this.categories, (item: CategoryItem, i) => {
          //
          //
          // })
        }
        .width(88)
        .border({ width: { right: 0.5 }, color: $r('[basic].color.under') })

        Scroll() {
          Column() {
            // 顶部图片
            Image(this.appCategory.category[this.activeIndex].picture)
              .width('100%')
              .height(new BreakPointType({
                sm: 136,
                md: 316,
                lg: 316
              }).getValue(this.breakPointClass.breakPoint))
              .objectFit(ImageFit.Contain)
              .backgroundColor('#f6f6f6')
              .borderRadius(8)
              .margin({ bottom: 8 })
            GridRow({
              columns: {
                sm: 2,
                md: 4,
                lg: 4
              }, gutter: 8
            }) {
              // 子分类
              Repeat<CategoryItemChild>(this.appCategory.category[this.activeIndex]?.children || [])
                .each((obj: RepeatItem<CategoryItemChild>) => {
                  GridCol() {
                    Column() {
                      // 图片
                      Image(obj.item.picture)
                        .width(64)
                        .aspectRatio(1)
                      Text(obj.item.name)// 文本
                        .fontSize(14)
                        .fontColor($r('[basic].color.text'))
                        .margin({ top: 8 })
                    }
                    .height('100%')
                    .justifyContent(FlexAlign.Center)
                  }
                  .aspectRatio(1)
                  .backgroundColor('#f6f6f6')
                  .borderRadius(8)
                })
              // ForEach(this.appCategory.category[this.activeIndex]?.children || [], (sub: CategoryItemChild) => {
              //   GridCol() {
              //     Column() {
              //       // 图片
              //       Image(sub.picture)
              //         .width(64)
              //         .aspectRatio(1)
              //       Text(sub.name)// 文本
              //         .fontSize(14)
              //         .fontColor($r('[basic].color.text'))
              //         .margin({ top: 8 })
              //     }
              //     .height('100%')
              //     .justifyContent(FlexAlign.Center)
              //   }
              //   .aspectRatio(1)
              //   .backgroundColor('#f6f6f6')
              //   .borderRadius(8)
              // })
            }
          }
          .padding(8)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Top)
    }
    .width('100%')
    .height('100%')
  }
}
```

