# 七、云端购物车

 ![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718609833595-5fb44e62-1301-467c-b82f-5e8d97610d7a.png?x-oss-process=image%2Fformat%2Cwebp)

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718609880945-e5b14177-cd04-40f0-8104-58f0689d77cf.png?x-oss-process=image%2Fformat%2Cwebp)



# 1. 购物车

## 1.1. 购物车素材整合

整合购物车相关素材

- 基础模块中放入类型

```ts
commons/basic/src/main/ets/viewmodels/business.ets

// 购物车单品的数据类型
export interface CartGoods {
  count: number;
  id: string;
  name: string;
  picture: string;
  price: number;
  selected: boolean;
  skuId: string;
  stock: number;
  attrsText: string;
}

@ObservedV2
export class CartGoodsModel implements CartGoods {
  @Trace
  count: number = 0
  id: string = ''
  name: string = ''
  picture: string = ''
  price: number = 0
  @Trace
  selected: boolean = false
  skuId: string = ''
  stock: number = 0
  attrsText: string = ''

  constructor(model: CartGoods) {
    this.count = model.count
    this.id = model.id
    this.name = model.name
    this.picture = model.picture
    this.price = model.price
    this.selected = model.selected
    this.skuId = model.skuId
    this.stock = model.stock
    this.attrsText = model.attrsText
  }
}
```

- 安装对于basic的依赖

```ts
features/cart/oh-package.json5

{
  "name": "cart",
  "version": "1.0.0",
  "description": "Please describe the basic information.",
  "main": "Index.ets",
  "author": "",
  "license": "Apache-2.0",
  "packageType": "InterfaceHar",
  "dependencies": {
    "basic": 'file:../../commons/basic'
  }
}
```

- CartView的模板

```typescript
features/cart/src/main/ets/views/CartView.ets

import { HDMGuessGoods, HDMNavBar, HDMUser, CartGoodsModel, AppBreakPoint, AppSafeArea } from 'basic'
import { CartItem } from '../components'
import { HMRouterMgr } from '@hadss/hmrouter'
import { AppStorageV2, PersistenceV2 } from '@kit.ArkUI'

@ComponentV2
export struct CartView {
  // 用户信息
  user: HDMUser = PersistenceV2.connect(HDMUser, () => new HDMUser())!
  // 商品信息
  breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  @Local cartList: CartGoodsModel[] = []

  aboutToAppear(): void {

  }

  @Builder
  DeleteBuilder(cart: CartGoodsModel) {
    Text('删除')
      .fontSize(14)
      .width(60)
      .height(100)
      .backgroundColor($r('[basic].color.red'))
      .fontColor($r('[basic].color.white'))
      .textAlign(TextAlign.Center)
      .onClick(() => {

      })
  }

  onCheckOrder() {
    AlertDialog.show({
      message: '去结算'
    })
  }

  build() {
    Column() {
      HDMNavBar({
        onLeftClick: () => {
          // this.stackPath.pop()
          HMRouterMgr.pop()
        },
        title: '购物袋',
        showRightIcon: true
      })
        .border({
          width: { bottom: 0.5 },
          color: '#e4e4e4'
        })

      List() {
        if (this.user.token) {

          if (this.cartList.length) {
            ForEach(this.cartList, (cart: CartGoodsModel) => {
              ListItem() {
                CartItem({
                  cart: cart,
                  onChangeSelected: async selected => {

                  }
                })
              }
              .backgroundColor($r('[basic].color.under'))
              .padding({ left: 8, right: 8 })
              .transition({ type: TransitionType.Delete, opacity: 0 })
              .swipeAction({
                end: this.DeleteBuilder(cart)
              })
            })
          } else {
            ListItem() {

            }
          }
        } else {
          // 未登录
          ListItem() {


          }
        }
        ListItem() {
          HDMGuessGoods()
            .margin({ top: 8, bottom: 8 })
        }

      }
      .contentStartOffset(8)
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      if (this.cartList.length) {
        Row() {
          Checkbox()
            .selectedColor($r('[basic].color.red'))
            .onClick(async () => {

            })
          Text('全选')
            .fontSize(14)
            .fontColor($r('[basic].color.black'))
            .margin({ right: 20 })
          Text('合计:')
            .fontSize(14)
            .fontColor($r('[basic].color.black'))
            .margin({ right: 2 })
          Text("0.00")
            .fontSize(16)
            .fontWeight(500)
            .fontColor($r('[basic].color.red'))
            .layoutWeight(1)
          Button('去结算')
            .enabled(this.cartList.some(item => item.selected))
            .fontSize(14)
            .height(36)
            .backgroundColor($r('[basic].color.red'))
            .onClick(() => {

            })
        }
        .height(50)
        .width('100%')
        .backgroundColor($r('[basic].color.white'))
        .border({
          width: { top: 0.5, bottom: 0.5 },
          color: '#e4e4e4'
        })
        .padding({ left: 16, right: 16 })
      }
    }
    .height('100%')
    .width('100%')
    .backgroundColor($r('[basic].color.under'))

  }
}
```

- 封装CartItem组件

```ts
features/cart/src/main/ets/components/CartItem.ets

import { CartGoods, CartGoodsModel } from "basic"

@ComponentV2
export struct CartItem {
  @Param
  cart: CartGoodsModel = new CartGoodsModel({} as CartGoods) //
  @Event
  onChangeSelected: (selected: boolean) => void = () => {

  }
  @Event
  onChangeCount: (count: number) => void = () => {

  }

  build() {
    Row({ space: 10 }) {

      Checkbox()
        .selectedColor($r('[basic].color.red'))
        .size({ width: 14, height: 14 })
        .select(this.cart.selected)// 和上级的item公用的是一个数据
        .onClick(() => {
          // 取反

        })
      Image(this.cart.picture)
        .width(80)
        .height(80)
        .syncLoad(true)
      Column({ space: 8 }) {
        Text(this.cart.name)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
          .fontSize(14)
          .fontColor($r('[basic].color.black'))
          .width('100%')
        Row() {
          Text(this.cart.attrsText)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .maxLines(1)
            .fontSize(12)
            .fontColor($r('[basic].color.text'))
            .layoutWeight(1)
          Image($r('sys.media.ohos_ic_public_arrow_down'))
            .fillColor($r('[basic].color.gray'))
            .width(16)
            .height(16)
        }
        .padding({ left: 6, right: 4 })
        .width(100)
        .height(24)
        .backgroundColor($r('[basic].color.under'))
        .borderRadius(2)

        Row() {
          Text(`¥${this.cart.price}`)
            .fontSize(14)
            .fontWeight(500)
          Counter() {
            Text(this.cart.count.toString())
          }
          .enableDec(this.cart.count > 1)
          .onInc(() => {
            this.cart.count++
            this.onChangeCount(this.cart.count)
          })
          .onDec(() => {
            this.cart.count--
            this.onChangeCount(this.cart.count)
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .height(100)
    .padding(10)
    .border({ width: { bottom: 0.5 }, color: '#e4e4e4' })
    .backgroundColor($r('[basic].color.white'))
  }
}
```



## 1.2. HDMEmpty 组件封装

先来搞定购物车中间部分的显示效果，通过组件来完成

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718609833595-5fb44e62-1301-467c-b82f-5e8d97610d7a.png)![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718609841763-8d67dd66-c96f-4df4-906f-6bed3c6aac67.png)

**核心步骤：**

1. 创建组件并暴露
2. 根据文档实现功能
3. 页面中导入并测试使用

1. 1. 已登录，无商品，点击去第一个 Tab(下一节做)
   2. 未登录，点击去登录页

基础模版

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1728726828389-c645bdfb-4328-4c0d-b729-088e73b59f04.png)

```ts
commons/basic/src/main/ets/components/HDMEmpty.ets

@Preview
@ComponentV2
export struct HDMEmpty {
  @Param
  icon: ResourceStr = $r("app.media.ic_public_empty")
  @Param
  tip: string = "空空如也"
  @Param
  buttonText: string = "去逛逛"
  @Event
  onBtnClick: () => void = () => {
  }

  build() {
    Column({ space: 20 }) {
      Image(this.icon)
        .width(120)
        .aspectRatio(1)
      Text(this.tip)
        .fontSize(12)
        .fontColor($r("app.color.gray"))
      Button(this.buttonText)
        .height(30)
        .fontSize(12)
        .padding({ left: 10, right: 10 })
        .fontColor($r("app.color.white"))
        .linearGradient({
          angle: 90,
          colors: [['#FD3F8F', 0], ['#FF773C', 1]]
        })
        .onClick(() => {
          this.onBtnClick()
        })
    }
    .justifyContent(FlexAlign.Center)
    .width("100%")
    .padding({
      top: 20,
      bottom: 80
    })
  }
}
```

- 改动原来的HDMUser为AppUser

```typescript
  appUser: AppUser = PersistenceV2.connect(AppUser, () => new AppUser())!
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743478124706-5296ad76-b5f7-494c-ac62-4957bca6cb23.png)

- 放置到空购物车和未登录位置

```typescript
HDMEmpty({
  tip: '空空如也',
  buttonText: '去逛逛',
  onBtnClick: ()=>{
    // 切换到首页
    emitter.emit(GlobalVariable.SWITCH_TAB, {data: {index: 0}})
  }
})


HDMEmpty({
  tip: '您还未登录',
  buttonText: '去登录',
  onBtnClick: ()=>{
    HMRouterMgr.push({
      pageUrl: PAGE_PATH.LOGIN_PAGE
    })
  }
})
```

- 切换SwitchTab的常量

```typescript
commons/basic/src/main/ets/constants/GlobalVariable.ets

export class GlobalVariable {
  static readonly BASE_URL: string = "https://meikou-api.itheima.net" // 网络请求基础地址
  // code成功标识
  static readonly SUCCESS_CODE: string = "1" // 成功标识
  static readonly TIME_OUT: number = 60000 // 超时时间
  static readonly TIP_MESSAGE: string = "sound.mp3"
  static readonly SWITCH_TAB: string = "switch_tab" // 切换tab的名称
}
```

- 在入口页面监听事件

```typescript
  products/phone/src/main/ets/pages/Index.ets

  controller: TabsController = new TabsController()

  aboutToAppear(): void {
    this.registerEvent() // 注册监听事件
  }

  // 监听switch
  registerEvent() {
    emitter.on(GlobalVariable.SWITCH_TAB, (event) => {
      if (event.data) {
        // 直接切换
        // this.activeIndex = event.data.index as number
        // 过渡切换
        this.controller.changeIndex(event.data.index as number)
      }
    })
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743478209324-d9bb7b16-4a9b-4263-a95f-05a998766285.png)





## 1.3. 商品详情页加入购物车

所有的电商业务，支付业务价格都是以后台服务器为准

安全- 如果以前台的价格为准，极其容器造成特别大的漏洞

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356232)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718811710651-92b39923-0c07-4910-8905-7e978bdaf151.png)

- 判断是否登录
- 判断是否选择了SKU
- 在basic中封装加入购物车方法
- 发现问题- 请求工具的注入token有问题，需要改正
- 调用接口-调用前设置loading，调用后关闭loading
- 关闭弹层

- 在basic中定义加入购物车参数类型

```typescript
commons/basic/src/main/ets/viewmodels/business.ets

// 加入购物车的参数类型
export interface AddCartParams {
  skuId: string
  count: number
}
```

- 在basic中声明类型和封装请求API

```ts
commons/basic/src/main/ets/api/cart.ets

import { RequestRcp } from "../utils";
import { AddCartParams } from "../viewmodels";


export const addCartAPI = (data: AddCartParams) => RequestRcp.post<null>("/member/cart", data)
```

- 导出

```typescript
commons/basic/src/main/ets/api/index.ets

export * from './guess'
export * from './cart'
```

- 导出外层

```typescript
commons/basic/Index.ets

export * from './src/main/ets/viewmodels' // 向外暴露类型

export * from './src/main/ets/utils' // 工具使用

export * from './src/main/ets/constants' // 常量

export * from './src/main/ets/components' // 组件

export * from './src/main/ets/api' // 导出公共请求
```

- 加入购物车逻辑

判断有没有登录- 去登录

判断有没有选中sku

加入购物车-弹层 关闭

```typescript
features/home/src/main/ets/views/GoodsView.ets

// 加入购物车
  async addCart() {
    const user = auth.getUser()
    if (user.token) {
      if (this.sku.id) {

        //进度加载类弹出框
        const key =  DialogHelper.showLoadingDialog({
          loadType: SpinType.spinP,
          loadColor: Color.White,
          loadSize: 50,
          backgroundColor: '#b5000000',
          content: "正在加入…",
          fontSize: 18,
          padding: { top: 30, right: 50, bottom: 30, left: 50 },
          autoCancel: true
        })

        // 此时才可以加入购物车
        await addCartAPI({
          skuId: this.sku.id,
          count: this.count
        })
        promptAction.showToast({ message: '加入购物车' })
        DialogHelper.closeDialog(key)
        this.showSheet = false // 关闭半模态
      } else {
        promptAction.showToast({ message: '请选择对应的规格商品' })
      }

    } else {
      promptAction.showToast({ message: '您还未登录' })
      this.showSheet = false // 关闭半模态
      // 去登录
      HMRouterMgr.push({
        pageUrl: PAGE_PATH.LOGIN_PAGE
      })
    }
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743479981228-296c8f9a-e67a-4c85-8710-ea01cb1aca41.png)



## 1.4. 购物车个数及页面跳转

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718812211359-0e980d47-8b8a-49fe-bb81-ef6089f3877e.png)![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718812220929-d7002566-5e98-4f62-be30-d5be2cd9cefa.png)

### 1.4.1. 详情页面个数更新

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718812909601-d095c8f4-dfc4-4e8d-b946-b347091b5f5f.png)

- 封装获取个数的API
- 封装抽提一个购物车管理的工具
- 应用初始化/登录/退出登录 调用更新数量
- 首页底部tabBar用徽标包裹实现数量的显示

- 定义返回类型

```typescript
commons/basic/src/main/ets/viewmodels/business.ets

export interface CartCount {
  count: number
}
```

- 封装获取购物车数量API

```ts
commons/basic/src/main/ets/api/cart.ets

import { RequestRcp } from "../utils";
import { AddCartParams, CartCount } from "../viewmodels";


export const addCartAPI = (data: AddCartParams) => RequestRcp.post<null>("/member/cart", data)


export const getCartCountAPI = () => RequestRcp.get<CartCount>("/member/cart/count")
```

- 定义全局购物车存储对象

```typescript
commons/basic/src/main/ets/viewmodels/common.ets

@ObservedV2
export class AppCart {
  @Trace
  count: number = 0
}
```

- 封装抽提一个购物车数量管理类

```typescript
commons/basic/src/main/ets/utils/AuthCart.ets

import { auth } from "."
import { getCartCountAPI } from "../api"
import { AppStorageV2 } from "@kit.ArkUI"
import { AppCart } from "../viewmodels"

export class AuthCart {
  // 方法的目的 是更新全局状态的购物车数量
  async updateCartCount() {
    // 调用api 获取购物车数量 更新到全局状态中去
    const user = auth.getUser()
    const appCart = AppStorageV2.connect(AppCart, () => new AppCart())!
    if (user.token) {
      const res = await getCartCountAPI()
      appCart.count = res.count // 赋值全局购物车数量状态
    } else {
      appCart.count = 0
    }
  }
}

export const authCart = new AuthCart()
```

- 入口-初始化项目时更新数量

```ts
products/entry/src/main/ets/pages/Index.ets

aboutToAppear(): void {
    this.registerEvent()
    this.getCartCount()
  }

  getCartCount() {
    authCart.updateCartCount() // 更新购物车数量
  }
```



- 登录成功时更新数量

```ts
features/mine/src/main/ets/views/LoginView/LoginView.ets

async onSubmit() {
    if (!this.agree) {
      return promptAction.showToast({ message: '请先勾选协议' })
    }
    const user = await loginAPI(this.loginForm)
    auth.setUser(user) // 写入用户
    await authCart.updateCartCount()
    HMRouterMgr.pop() // 返回上一层
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743490921430-5fbbf3e2-c016-469c-8fb8-7142d97e9be0.png)

- 退出登录时更新数量

```ts
 features/mine/src/main/ets/views/SettingView.ets

 DialogHelper.showAlertDialog({
    content: "确认退出登录吗？",
    onAction: async (action) => {
      if (action == DialogAction.CANCEL) {
        // ..
      } else if (action == DialogAction.SURE) {
        auth.setUser({} as HDMUser)
        await authCart.updateCartCount()
        HMRouterMgr.pop()
      }
    }
  })
```

- 使用徽标组件包裹内容跟新数据

```ts
src/main/ets/pages/Index.ets

appCart: AppCart = AppStorageV2.connect(AppCart, () => new AppCart())!
 
@Builder
getTabItemBuilder(item: TabItem, index: number) {
  Column() {
    if (index === 2) {
      Badge({ count: this.appCart.count, style: {} }) {
        Column({ space: 4 }) {
          Image(this.activeIndex === index ? item.active : item.normal)
            .width(24)
            .aspectRatio(1)
          Text(item.text)// 跨 HSP 访问资源，需要在 oh-package.json5中导入
            .fontColor($r("[basic].color.black"))
            .fontSize(12)
        }
      }
    } else {
      Image(this.activeIndex === index ? item.active : item.normal)
        .width(24)
        .aspectRatio(1)
      Text(item.text)// 跨 HSP 访问资源，需要在 oh-package.json5中导入
        .fontColor($r("[basic].color.black"))
        .fontSize(12)
    }

  }
  .justifyContent(FlexAlign.SpaceEvenly)
  .height(50)
}
```

- 商品详情页显示购物车数量

```typescript
features/home/src/main/ets/views/GoodsView.ets
  
appCart: AppCart = AppStorageV2.connect(AppCart, () => new AppCart())!
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1742402961213-2aa30124-4763-4977-ba99-8275b37e6c7c.png)

- 加入购物车时换成抽提的方法

```ts
features/home/src/main/ets/views/GoodsView.ets

async addCart() {
    const user = auth.getUser()
    if (user.token) {
      if (this.sku.id) {

        //进度加载类弹出框
        const key =  DialogHelper.showLoadingDialog({
          loadType: SpinType.spinP,
          loadColor: Color.White,
          loadSize: 50,
          backgroundColor: '#b5000000',
          content: "正在加入…",
          fontSize: 18,
          padding: { top: 30, right: 50, bottom: 30, left: 50 },
          autoCancel: true
        })

        // 此时才可以加入购物车
        await addCartAPI({
          skuId: this.sku.id,
          count: this.count
        })
        promptAction.showToast({ message: '加入购物车' })
        await authCart.updateCartCount()
        DialogHelper.closeDialog(key)
        this.showSheet = false // 关闭半模态
      } else {
        promptAction.showToast({ message: '请选择对应的规格商品' })
      }

    } else {
      promptAction.showToast({ message: '您还未登录' })
      this.showSheet = false // 关闭半模态
      // 去登录
      HMRouterMgr.push({
        pageUrl: PAGE_PATH.LOGIN_PAGE
      })
    }
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743491000936-b5e4a54d-b8e7-49d6-83fd-ec73d528c9dc.png)



### 1.4.2. 去购物车页

- 详情页的购物车图标点击要跳转到购物车

  

![image.png](https://cdn.nlark.com/yuque/0/2024/png/8435673/1728808950217-b3838129-79e6-4166-969a-d1a3e17f2e41.png?x-oss-process=image%2Fformat%2Cwebp)

![image.png](https://cdn.nlark.com/yuque/0/2024/png/8435673/1728808966168-dd5ddac4-c5dc-4997-8c28-a06858feb576.png?x-oss-process=image%2Fformat%2Cwebp)



- 将购物车的Name的常量放入到页面路径中

```ts
commons/basic/src/main/ets/constants/PagePath.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView" // 搜索页面
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView" // 搜索结构页面
  static readonly LOGIN_PAGE: string = "LoginView" // 搜索结构页面
  static readonly AI_CUSTOMER_PAGE: string = "AICustomerView" // 搜索结构页面
  static readonly SETTING_PAGE: string = "SettingView" // 设置页面
  static readonly GOODS_PAGE: string = "GoodsView" // 商品详情页面
  static readonly CART_PAGE: string = "CartView" // 购物车页面
}
```

- 使用HmRouter装饰器装饰CartView

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1742402139586-0b4e0960-2040-4268-8d4d-f8a28b6575c4.png)

- 详情页点击购物车图标跳转到购物车

```ts
features/home/src/main/ets/views/GoodsView/GoodsView.ets

 Badge({
      count: this.cartCount,
      style: {},
      position: { x: 30, y: 4 }
    }) {
      Image($r('[basic].media.ic_public_cart'))
        .iconButton()
        .onClick(() => {
          HMRouterMgr.push({
            pageUrl: PAGE_PATH.CART_PAGE,
            param: true
          })
        })
    }
```

- 改造返回按钮显示

```typescript
 features/cart/src/main/ets/views/CartView.ets
 
 @Local
  showLeftIcon: boolean = false

  aboutToAppear(): void {
    this.showLeftIcon = HMRouterMgr.getCurrentParam() as boolean
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743492777893-f6b8e15a-ec9c-4d80-8514-35f0f2907f6a.png)



## 1.5. 购物车列表渲染

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356230)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718817781743-69318a77-47cb-4db8-bdf7-8f1e3678667b.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718818185434-18c07f0c-24ef-41ca-b8db-e4d1643c913a.png)

- 封装获取购物车列表的API

```ts
commons/basic/src/main/ets/api/cart.ets
// 获取购物车列表
export const getCartListAPI = () => RequestRcp.get<CartGoodsModel[]>("/member/cart")
```

问题？

- 首次进入项目要获取购物车
- 登录要获取购物车
- 退出要清空购物车

- 在原来购物车状态上添加一个全局状态

```typescript
commons/basic/src/main/ets/viewmodels/common.ets

@ObservedV2
export class AppCartCount {
  @Trace
  count: number = 0
  @Trace
  cartList: CartGoodsModel[] = [] // 全局购物车
}
```

- 更新购物车数量的同时更新购物车列表

```ts
src/main/ets/utils/AuthCart.ets

export class AuthCart {
  // 方法的目的 是更新全局状态的购物车数量
  async updateCartCount() {
    // 调用api 获取购物车数量 更新到全局状态中去
    const user = auth.getUser()
    const appCart = AppStorageV2.connect(AppCart, () => new AppCart())!
    if (user.token) {
      const res = await getCartCountAPI() // 购物车数量
      // Observed(class) ObjectLink ObservedV2都必须通过new才具备响应式
      appCart.cartList =
        (await getCartListAPI()).map(item => new CartGoodsModel(item)) // [{} 不具备响应式, {}] - new CartGoodsModel()
      appCart.count = res.count // 赋值全局购物车数量状态
    } else {
      appCart.count = 0
      appCart.cartList = []
    }

  }
}

export const authCart = new AuthCart()
```

- 购物车页面获取购物车列表

```typescript
features/cart/src/main/ets/views/CartView.ets

import {
  HDMGuessGoods,
  HDMNavBar,
  HDMUser,
  CartGoodsModel,
  AppBreakPoint,
  AppSafeArea,
  AppUser,
  HDMEmpty,
  PAGE_PATH,
  GlobalVariable,
  AppCart
} from 'basic'
import { CartItem } from '../components'
import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'
import { AppStorageV2, PersistenceV2 } from '@kit.ArkUI'
import { emitter } from '@kit.BasicServicesKit'

@HMRouter({ pageUrl: PAGE_PATH.CART_PAGE })
@ComponentV2
export struct CartView {
  // 用户信息
  appUser: AppUser = PersistenceV2.connect(AppUser, () => new AppUser())!
  // 商品信息
  breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  // @Local cartList: CartGoodsModel[] = []
  appCart: AppCart = AppStorageV2.connect(AppCart, () => new AppCart())!
  @Local
  showLeftIcon: boolean = false

  aboutToAppear(): void {
    this.showLeftIcon = HMRouterMgr.getCurrentParam() as boolean
  }

  @Builder
  DeleteBuilder(cart: CartGoodsModel) {
    Text('删除')
      .fontSize(14)
      .width(60)
      .height(100)
      .backgroundColor($r('[basic].color.red'))
      .fontColor($r('[basic].color.white'))
      .textAlign(TextAlign.Center)
      .onClick(() => {

      })
  }

  onCheckOrder() {
    AlertDialog.show({
      message: '去结算'
    })
  }

  build() {
    Column() {
      HDMNavBar({
        onLeftClick: () => {
          // this.stackPath.pop()
          HMRouterMgr.pop()
        },
        title: '购物袋',
        showRightIcon: true,
        showLeftIcon: this.showLeftIcon,
      })
        .border({
          width: { bottom: 0.5 },
          color: '#e4e4e4'
        })

      List() {
        if (this.appUser.user.token) {

          if (this.appCart.cartList.length) {
            Repeat<CartGoodsModel>(this.appCart.cartList)
              .each((obj: RepeatItem<CartGoodsModel>) => {
                ListItem() {
                  CartItem({
                    cart: obj.item,
                    onChangeSelected: async selected => {

                    }
                  })
                }
                .backgroundColor($r('[basic].color.under'))
                .padding({ left: 8, right: 8 })
                .transition({ type: TransitionType.Delete, opacity: 0 })
                .swipeAction({
                  end: this.DeleteBuilder(obj.item)
                })
              })
              .virtualScroll()
            // ForEach(this.cartList, (cart: CartGoodsModel) => {
            //
            // })
          } else {
            ListItem() {
              HDMEmpty({
                tip: '空空如也',
                buttonText: '去逛逛',
                onBtnClick: () => {
                  // 切换到首页
                  emitter.emit(GlobalVariable.SWITCH_TAB, { data: { index: 0 } })
                }
              })

            }
          }
        } else {
          // 未登录
          ListItem() {
            HDMEmpty({
              tip: '您还未登录',
              buttonText: '去登录',
              onBtnClick: () => {
                HMRouterMgr.push({
                  pageUrl: PAGE_PATH.LOGIN_PAGE
                })
              }
            })

          }
        }
        ListItem() {
          HDMGuessGoods()
            .margin({ top: 8, bottom: 8 })
        }

      }
      .contentStartOffset(8)
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      if (this.appCart.cartList.length) {
        Row() {
          Checkbox()
            .selectedColor($r('[basic].color.red'))
            .onClick(async () => {

            })
          Text('全选')
            .fontSize(14)
            .fontColor($r('[basic].color.black'))
            .margin({ right: 20 })
          Text('合计:')
            .fontSize(14)
            .fontColor($r('[basic].color.black'))
            .margin({ right: 2 })
          Text("0.00")
            .fontSize(16)
            .fontWeight(500)
            .fontColor($r('[basic].color.red'))
            .layoutWeight(1)
          Button('去结算')
            .fontSize(14)
            .height(36)
            .backgroundColor($r('[basic].color.red'))
            .onClick(() => {

            })
        }
        .height(50)
        .width('100%')
        .backgroundColor($r('[basic].color.white'))
        .border({
          width: { top: 0.5, bottom: 0.5 },
          color: '#e4e4e4'
        })
        .padding({ left: 16, right: 16 })
      }
    }
    .height('100%')
    .width('100%')
    .backgroundColor($r('[basic].color.under'))

  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743494880943-965b1c05-bf7a-491d-b47e-6c4f839af644.png)

- 完成购物车列表的获取
- git提交

## 1.6. 加减购物车

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1728811673888-0ada68c1-e2de-4c7d-ae39-a6d81cf7c122.png)



- 实现加减购物车

```ts
  features/cart/src/main/ets/components/CartItem.ets

  Row() {
          Text(`¥${this.cart.price}`)
            .fontSize(14)
            .fontWeight(500)
          Counter() {
            Text(this.cart.count.toString())
          }
          .enableDec(this.cart.count > 1)
          .onInc(() => {
            this.cart.count++
            this.onChangeCount(this.cart.count)
          })
          .onDec(() => {
            this.cart.count--
            this.onChangeCount(this.cart.count)
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
```

- 在basic中声明请求参数的类型

```ts
// 更新购物车数量的参数
commons/basic/src/main/ets/viewmodels/business.ets

export interface UpdateCartParams {
  selected: boolean
  count: number
}
```

- 封装更新商品的API

```ts
commons/basic/src/main/ets/api/cart.ets

export const updateCartAPI =
  (skuId: string, data: UpdateCartParams) => RequestRcp.put<null>(`/member/cart/${skuId}`, data)
```

- 父组件进行操作

```ts
 features/cart/src/main/ets/views/CartView.ets

 Repeat<CartGoodsModel>(this.appCart.cartList)
              .each((obj: RepeatItem<CartGoodsModel>) => {
                ListItem() {
                  CartItem({
                    cart: obj.item,
                    onChangeSelected: async selected => {

                    },
                    onChangeCount: async count => {
                      // count 要更新到云端的数量
                        const key =  DialogHelper.showLoadingDialog({
                        loadType: SpinType.spinP,
                        loadColor: Color.White,
                        loadSize: 50,
                        backgroundColor: '#BB000000',
                        content: "更新中…",
                        fontSize: 18,
                        padding: { top: 30, right: 50, bottom: 30, left: 50 },
                        autoCancel: true
                      })
                      await updateCartAPI(obj.item.skuId, { count , selected: obj.item.selected })
                      await authCart.updateCartCount() // 更新整体购物车
                      DialogHelper.closeDialog(key)
                    }
                  })
                }
                .backgroundColor($r('[basic].color.under'))
                .padding({ left: 8, right: 8 })
                .transition({ type: TransitionType.Delete, opacity: 0 })
                .swipeAction({
                  end: this.DeleteBuilder(obj.item)
                })
              })
              .virtualScroll()
```

注意: [Repeat一定要加key](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-rendering-control-repeat#键值生成函数)

![img](https://cdn.nlark.com/yuque/0/2025/png/38706227/1747790199326-a91cc692-c20a-477a-92f7-ce71d6b4a80f.png)



![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743496336627-de0d996e-c12f-4fb8-a7bd-0a40574a6e60.png)



git 记录

## 1.7. 勾选/取消勾选/全选-计算属性

- 勾选和取消勾选操作

```ts
 features/cart/src/main/ets/views/CartView/components/CartItem.ets

 Checkbox()
        .selectedColor($r('[basic].color.red'))
        .size({ width: 14, height: 14 })
        .select(this.cart.selected)// 和上级的item公用的是一个数据
        .onClick(() => {
          // 取反
          this.cart.selected = !this.cart.selected // 改的是本地的
          this.onChangeSelected(this.cart.selected)

        })
```

- 父组件执行更新数据的操作

```ts
 features/cart/src/main/ets/views/CartView.ets

 Repeat<CartGoodsModel>(this.appCart.cartList)
              .each((obj: RepeatItem<CartGoodsModel>) => {
                ListItem() {
                  CartItem({
                    cart: obj.item,
                    onChangeSelected: async selected => {
                       const key = DialogHelper.showLoadingDialog({
                        loadType: SpinType.spinP,
                        loadColor: Color.White,
                        loadSize: 50,
                        backgroundColor: '#BB000000',
                        content: "更新中…",
                        fontSize: 18,
                        padding: { top: 30, right: 50, bottom: 30, left: 50 },
                        autoCancel: true
                      })
                      await updateCartAPI(obj.item.skuId, { count: obj.item.count, selected })
                      await authCart.updateCartCount() // 更新整体购物车
                      DialogHelper.closeDialog(key)
                    },
                    onChangeCount: async count => {
                      // count 要更新到云端的数量
                      const key = await hdmDialogHelper.showLoadingDialog({ title: '更新中...' })
                      await updateCartAPI(obj.item.skuId, { count, selected: obj.item.selected })
                      await authCart.updateCartCount() // 更新整体购物车
                      hdmDialogHelper.closeConfirmDialog(key)
                    }
                  })
                }
                .backgroundColor($r('[basic].color.under'))
                .padding({ left: 8, right: 8 })
                .transition({ type: TransitionType.Delete, opacity: 0 })
                .swipeAction({
                  end: this.DeleteBuilder(obj.item)
                })
              })
              .virtualScroll()
              .key((item: CartGoodsModel, index: number) => `${index}_${JSON.stringify(item)}`)
```

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356245)

https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/every

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718837503905-635a01a0-5a90-482e-bcf6-0e398fc7b128.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718838402131-9230d49d-b52a-45f7-b75a-a95bace69724.png)



- 封装全选或者取消全选API

```ts
commons/basic/src/main/ets/api/cart.ets

export const selectOrUnSelectAPI = (data: UpdateCartParams) => RequestRcp.put<null>("/member/cart/selected", data)
```

- 使用计算属性计算是否已经全部选中

```arkts
// 检查是否全选中
  @Computed
  get isCheckAll() {
    return this.appCart.cartList.every(item => item.selected)
  }
```

- 实现正向反向选中

```ts
 features/cart/src/main/ets/views/CartView/CartView.ets

 Checkbox()
            .select(this.isCheckAll)
            .selectedColor($r('[basic].color.red'))
            .onClick(async () => {
              const key = await hdmDialogHelper.showLoadingDialog({ title: '更新中...' })
              await selectOrUnSelectAPI({ selected: !this.isCheckAll } as UpdateCartParams)
              await authCart.updateCartCount() // 更新购物车列表 因为货物有可能下架 价格变了 沽清(没库存)
              // 更新本地
              // this.appCart.cartList.forEach(item => {
              //   item.selected = !this.isCheckAll
              // })
              hdmDialogHelper.closeConfirmDialog(key)

            })
```



## 1.8. 购物车-总价格-V2计算属性

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718841835548-c2331b6e-1eb6-40e1-9ae5-b2eac140196a.png)



- 使用计算属性计算总价格

```arkts
// 总价格
  @Computed
  get allPrice() {
    return this.appCart.cartList.filter(item => item.selected).reduce((preValue: number, item: CartGoodsModel) => {
      return preValue + item.count * item.price
    }, 0)
  }

  // 至少有一个选中
  @Computed
  get atLeastOne() {
    return this.appCart.cartList.some(item => item.selected)
  }
```

- 显示在页面上

```arkts
   Text(this.allPrice.toFixed(2))
              .fontSize(16)
              .fontWeight(500)
              .fontColor($r('[basic].color.red'))
              .layoutWeight(1)
```

- 控制去结算的可点击项

```arkts
  Button('去结算')
              .enabled(this.atLeastOne)
              .fontSize(14)
              .height(36)
              .backgroundColor($r('[basic].color.red'))
              .onClick(() => {

              })
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743502766859-d3491b5d-4d12-40d1-bf24-dfc42942ecb6.png)



## 1.9. 删除购物车

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356231)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718842017290-17911c36-b284-407a-ac08-b116f4df957f.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718842254933-c7e68bcc-5d24-4db0-a850-e61658bc0c1d.png)

- 声明删除参数的类型

```typescript
// 编译 类型  运行
commons/basic/src/main/ets/viewmodels/business.ets

export interface DeleteCartParams {
  ids: string[]
}
```

- 封装删除接口

```typescript
commons/basic/src/main/ets/api/cart.ets

export const delCartAPI =
  (data: DeleteCartParams) => RequestRcp.delete<null>("/member/cart", undefined, data)
```

- 点击删除操作-记录删除的skuId-弹出确认框

```typescript
 features/cart/src/main/ets/views/CartView.ets

@Builder
  DeleteBuilder(cart: CartGoodsModel) {
    Text('删除')
      .fontSize(14)
      .width(60)
      .height(100)
      .backgroundColor($r('[basic].color.red'))
      .fontColor($r('[basic].color.white'))
      .textAlign(TextAlign.Center)
      .onClick(() => {
        // 删除
        DialogHelper.showAlertDialog({
          content: "确认删除该商品吗？",
          onAction: async (action) => {
            if (action == DialogAction.CANCEL) {

            } else if (action == DialogAction.SURE) {
              await delCartAPI({ ids: [cart.skuId] })
              await authCart.updateCartCount()
            }
          }
        })

      })
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743503894680-ffa2bf09-06e5-4b00-a2d2-a8b3e093e907.png)

- 点击确认删除
