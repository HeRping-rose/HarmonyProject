# 八、订单模块

# 1. 订单

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718945290078-653f5d8d-76db-4388-96a4-42aa5fcf3cac.png?x-oss-process=image%2Fformat%2Cwebp)

## 1.1. 搭建订单页面

1. 数据模型

```ts
commons/basic/src/main/ets/viewmodels/business.ets

// 地址
export interface AddressItem {
  address: string
  contact: string
  fullLocation: string
  id: string
  isDefault: 0 | 1
  receiver: string
  provinceCode: number
  cityCode: number
  countyCode: number
}

// 订单
export interface OrderGoodsItem {
  attrsText: string;
  count: number;
  id: string;
  name: string;
  payPrice: string;
  picture: string;
  price: string;
  skuId: string;
  totalPayPrice: string;
  totalPrice: string;
}

// 摘要
export interface Summary {
  discountPrice: number;
  goodsCount: number;
  postFee: number;
  totalPayPrice: number;
  totalPrice: number;
}

// 结算信息
export interface PreOrder {
  goods: OrderGoodsItem[]
  userAddresses: AddressItem[]
  summary: Summary
}

// 创建订单商品信息
export interface CreateOrderParamsGoods {
  skuId: string
  count: number
}

// 生成订单参数
export interface CreateOrderParams {
  deliveryTimeType: number
  payType: number
  buyerMessage: string
  payChannel: number
  goods: CreateOrderParamsGoods[]
  addressId: string
}

// 创建订单结果
export interface CreateOrderResult {
  id: string
}

// 订单
export interface OrderItem {
  countdown: number;
  createTime: string;
  id: string;
  orderState: 1 | 2 | 3 | 4 | 5 | 6;
  payChannel: number;
  payLatestTime: string;
  payMoney: number;
  payType: number;
  postFee: number;
  skus: OrderSku[];
  totalMoney: number;
  totalNum: number;
}

// 订单 sku
export interface OrderSku {
  attrsText: string;
  curPrice: number;
  id: string;
  image: string;
  name: string;
  properties: Property[];
  quantity: number;
  realPay: number;
  spuId: string;
}

// 属性
export interface Property {
  propertyMainName: string;
  propertyValueName: string;
}
```

1. 新建核对订单页面

```typescript
commons/basic/src/main/ets/constants/PAGE_PATH.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView"
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView"
  static readonly LOGIN_PAGE: string = "LoginView" // 搜索结构页面
  static readonly AI_CUSTOMER_PAGE: string = "AICustomerView" // 搜索结构页面
  static readonly SETTING_PAGE: string = "SettingView" // 设置页面
  static readonly GOODS_PAGE: string = "GoodsView" // 商品详情页面
  static readonly CART_PAGE: string = "CartView" // 购物车页面
  static readonly CHECK_PAGE: string = "CheckPageView" // 核对订单页面
}
```

- 封装API

```ts
commons/basic/src/main/ets/api/cart.ets
// 获取结算信息

export const getPreOrderAPI = () => {
  return RequestRcp.get<PreOrder>(`/member/order/pre`)
}
```

搭建视图页面

```ts
features/cart/src/main/ets/views/CheckView.ets

import {
  HDMCell,
  HDMNavBar,
  AddressItem,
  OrderGoodsItem,
  Summary,
  GlobalVariable,
  getPreOrderAPI,
  CreateOrderParamsGoods,
  PAGE_PATH,
  authCart,
  AppSafeArea
} from 'basic'
import { AppStorageV2, promptAction } from '@kit.ArkUI'
import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'


@HMRouter({ pageUrl: PAGE_PATH.CHECK_PAGE })
@ComponentV2
export struct CheckView {
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  // 商品列表
  @Local goodsList: OrderGoodsItem[] = []
  // 地址
  @Local addressList: AddressItem[] = []
  // 摘要
  @Local summary: Summary = {} as Summary
  // 弹框
  @Local showPaySheet: boolean = false
  // 支付渠道
  @Local payChannel: number = 1
  // 地址 id
  @Local addressId: string = ''
  // 是否 loading
  @Local loading: boolean = false

  async submitOrder() {
    if (this.payChannel !== 1) {
      return promptAction.showToast({ message: '暂不支持该支付方式' })
    }
    if (!this.addressId) {
      return promptAction.showToast({ message: '未选择收货地址' })
    }
    this.loading = true
    // 调用创建订单接口
  }

  @Builder
  GoodsItemBuilder(goods: OrderGoodsItem) {
    Row({ space: 10 }) {
      Image(goods.picture)
        .width(80)
        .height(80)
      Column({ space: 8 }) {
        Text(goods.name)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .maxLines(1)
          .fontSize(14)
          .fontColor($r('[basic].color.black'))
          .width('100%')
        Row({ space: 8 }) {
          Text(goods.attrsText)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .maxLines(1)
            .fontSize(12)
            .fontColor($r('[basic].color.text'))
            .layoutWeight(1)
          Text('x' + goods.count)
            .fontSize(14)
            .fontColor($r('[basic].color.gray'))
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        Text('¥' + goods.payPrice)
          .width('100%')
          .fontSize(16)
          .fontColor($r('[basic].color.black'))
      }
      .layoutWeight(1)
    }
    .padding({ top: 10, bottom: 10 })
    .border({
      width: { bottom: 0.5 },
      color: '#e4e4e4'
    })
  }

  payChannels = ['支付宝', '微信支付', '华为支付']

  // 半模态
  @Builder
  PaySheetBuilder() {
    Column() {
      Text('¥' + this.summary.totalPayPrice?.toString())
        .fontSize(20)
        .fontWeight(500)
        .fontColor($r('[basic].color.black'))
        .height(50)
        .width('100%')
        .border({
          width: { bottom: 0.5 },
          color: $r('[basic].color.under')
        })
      ForEach(this.payChannels, (label: string, index) => {
        CheckCell({
          label: label, checked: this.payChannel === index + 1, onClickBox: () => {
            this.payChannel = index + 1
          }
        })
          .onClick(() => {
            this.payChannel = index + 1
          })
      })
      Row() {
        Button(this.loading ? '提交中...' : '立即支付')
          .width('100%')
          .height(36)
          .fontSize(14)
          .backgroundColor($r('[basic].color.red'))
          .onClick(() => {
            this.submitOrder()
          })
      }
      .height(50)
    }
    .padding({ left: 16, right: 16, bottom: this.safeArea.bottomHeight })
  }

  aboutToAppear(): void {
    this.getPreOrder()
  }

  async getPreOrder() {
    const result = await getPreOrderAPI()
    this.goodsList = result.goods
    this.addressList = result.userAddresses
    this.summary = result.summary
  }

  build() {
    // NavDestination() {
    Column() {
      HDMNavBar({
        title: '结算', onLeftClick: () => {
          // this.stackPath.pop()
          HMRouterMgr.pop()
        }
      })
        .border({
          width: { bottom: 0.5 },
          color: '#e4e4e4'
        })
      List() {
        ListItem() {
          ChangeAddressComp({
            addressList: this.addressList, onChangeAddress: (addr) => {
              this.addressId = addr?.id
            }
          })
        }

        ListItem() {
          Row() {
            Column() {
              ForEach(this.goodsList, (goods: OrderGoodsItem) => {
                this.GoodsItemBuilder(goods)
              })
            }
            .padding({ left: 8, right: 8 })
            .backgroundColor($r('[basic].color.white'))
          }
          .padding({ top: 8, left: 8, right: 8 })
        }

        ListItem() {
          Row() {
            Column() {
              HDMCell({ title: '配送时间', value: '时间不限' })
              HDMCell({ title: '留言', value: '建议留言前先和卖家沟通' })
            }
            .padding({ left: 8, right: 8 })
            .backgroundColor($r('[basic].color.white'))
          }
          .padding({ top: 8, left: 8, right: 8 })
        }

        ListItem() {
          Row() {
            Column() {
              PriceCell({ label: '商品总价', price: this.summary.totalPrice })
              PriceCell({ label: '运费', price: this.summary.postFee })
              PriceCell({ label: '实付金额', price: this.summary.totalPayPrice, isRed: true })
            }
            .padding({ left: 8, right: 8 })
            .backgroundColor($r('[basic].color.white'))
          }
          .padding({ top: 8, left: 8, right: 8 })
        }

        ListItem() {
          Row() {
            Column() {
              CheckCell({ label: '在线支付', checked: true })
              CheckCell({ label: '货到付款' })
            }
            .padding({ left: 8, right: 8 })
            .backgroundColor($r('[basic].color.white'))
          }
          .padding(8)
        }

      }
      .width('100%')
      .height('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      Row() {
        Column() {
          Text() {
            Span('¥')
              .fontSize(14)
            Span(this.summary.totalPayPrice?.toFixed(2))
              .fontSize(20)
          }
          .fontColor($r('[basic].color.red'))
          .fontWeight(500)

          Text() {
            Span('共减')
              .fontColor($r('[basic].color.gray'))
            Span('¥00.00')
              .fontColor($r('[basic].color.red'))
              .fontWeight(500)
          }
          .fontSize(8)
        }
        .alignItems(HorizontalAlign.Start)

        Blank()
        Button('提交订单')
          .fontSize(14)
          .height(36)
          .backgroundColor($r('[basic].color.red'))
          .onClick(() => {
            this.showPaySheet = true
          })
      }
      .height(50 + this.safeArea.bottomHeight)
      .width('100%')
      .backgroundColor($r('[basic].color.white'))
      .border({
        width: { top: 0.5 },
        color: '#e4e4e4'
      })
      .padding({ left: 16, right: 16, bottom: this.safeArea.bottomHeight })
    }
    .backgroundColor($r('[basic].color.under'))
    .bindSheet($$this.showPaySheet, this.PaySheetBuilder(), {
      title: {
        title: '支付方式',
        subtitle: '请选择一种支付方式进行付款'
      }, height: SheetSize.FIT_CONTENT, backgroundColor: $r('[basic].color.white')
    })

  }
}

@ComponentV2
struct ChangeAddressComp {
  @Param addressList: AddressItem[] = []
  @Local currentAddress: AddressItem = {} as AddressItem
  @Event
  onChangeAddress: (address: AddressItem) => void = () => {

  }

  @Monitor("addressList")
  onAddressListChange() {
    const defAddress = this.addressList.find(addr => addr.isDefault === 0)
    if (defAddress) {
      this.currentAddress = defAddress
    } else {
      this.currentAddress = this.addressList[0]
    }
    this.onChangeAddress(this.currentAddress)
  }

  aboutToAppear() {
    this.onChangeAddress(this.currentAddress)
  }

  @Builder
  AddressTipBuilder() {
    if (this.addressList.length) {
      Column({ space: 8 }) {
        Row({ space: 4 }) {
          if (this.currentAddress.isDefault === 0) {
            Text('默认')
              .fontSize(14)
              .width(40)
              .height(20)
              .borderRadius(4)
              .fontColor($r('[basic].color.white'))
              .textAlign(TextAlign.Center)
              .linearGradient({
                angle: 90,
                colors: [[$r('[basic].color.linear_begin'), 0], [$r('[basic].color.linear_end'), 1]]
              })
          }
          Text(this.currentAddress.fullLocation)
            .fontSize(14)
            .fontColor($r('[basic].color.text'))
        }

        Text(this.currentAddress.address)
          .fontWeight(500)
          .fontSize(16)
          .fontColor($r('[basic].color.black'))
        Text(`${this.currentAddress.receiver} ${this.currentAddress.contact}`)
          .fontSize(13)
          .fontColor($r('[basic].color.text'))
      }
      .alignItems(HorizontalAlign.Start)
      .padding({ top: 10, bottom: 10 })
    } else {
      Text('请填写收货地址')
        .fontSize(14)
        .fontColor($r('[basic].color.gray'))
    }
  }

  build() {
    Row() {
      HDMCell({
        customLabel: () => {
          this.AddressTipBuilder()
        }
      })
    }
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('[basic].color.white'))
    .width('100%')
    .onAppear(() => {
      this.onChangeAddress(this.currentAddress)
    })
  }
}

@ComponentV2
struct PriceCell {
  @Param label: string = ""
  @Param price: number = 0
  @Param isRed: boolean = false

  @Builder
  PriceBuilder() {
    Text('¥' + this.price)
      .fontSize(this.isRed ? 16 : 14)
      .fontColor(this.isRed ? $r('[basic].color.red') : $r('[basic].color.gray'))
  }

  build() {
    HDMCell({
      title: this.label, customIcon: () => {
        this.PriceBuilder()
      }
    })
  }
}

@Component
struct CheckCell {
  @Prop label: string
  @Prop checked: boolean = false
  onClickBox: () => void = () => {

  }

  @Builder
  CheckBuilder() {
    Checkbox()
      .selectedColor($r('[basic].color.red'))
      .select(this.checked)
      .onClick(() => {
        this.onClickBox()
      })
  }

  build() {
    HDMCell({
      title: this.label, customIcon: () => {
        this.CheckBuilder()
      }
    })
  }
}
```

1. 跳转

1. 1. features/cart/src/main/ets/views/CartView.ets
   2. 判断是否选中商品，进行跳转

```ts
features/cart/src/main/ets/views/CartView/CartView.ets
 
 Button('去结算')
  .fontSize(14)
  .height(36)
  .backgroundColor($r('[basic].color.red'))// .enabled(this.allPrice > 0)
  .enabled(this.cartList.some(item => item.selected))
  .onClick(() => {
      HMRouterMgr.push({
        pageUrl: PAGE_PATH.CHECK_PAGE
      })
  })
```



## 1.2. 创建订单

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356243)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718946762070-fcf70b75-b177-46e6-80ca-41280df988c1.png)

1. 抽取 api

```ts
commons/basic/src/main/ets/api/cart.ets

// 下单API
export const createOrderAPI = (data: CreateOrderParams) => {
  return RequestRcp.post<CreateOrderResult>("/member/order", data)
}
```

2.点击立即支付创建订单

3.获取 id+打印

4.更新购物车

```ts
features/cart/src/main/ets/views/CheckView/CheckView.ets

async submitOrder() {
    if (this.payChannel !== 1) {
      return promptAction.showToast({ message: '暂不支持该支付方式' })
    }
    if (!this.addressId) {
      return promptAction.showToast({ message: '未选择收货地址' })
    }

    // 调用创建订单接口
    const result = await createOrderAPI({
      goods: this.goodsList,
      deliveryTimeType: 1,
      payType: 1,
      buyerMessage: '', // 买家留言
      payChannel: 1,
      addressId: this.addressId
    })
    promptAction.showToast({ message: result.id }) // 唤起支付宝支付 -支付宝支付没有沙箱环境的sdk h5支付
  }
```

5.支付页下一步再创建，这一步获取到 id 即可



# 九、支付模块

- 提交订单
- 服务器生成一个订单记录(待支付状态)-id-对应金额- 中间表-支付宝 /微信 /华为
- 拿到id- 唤起各种支付的支付-把订单号传递给平台
- 平台根据id去中间表拿到金额
- 相应的支付
- 支付宝/微信/华为/... 改写订单状态- 成功/失败/取消支付
- 没有对应沙箱操作-支付宝没有提供沙箱验证-h5版本沙箱支付
- 微信-sdk需要各类的认证-后台没有对接
- 华为支付审核极其严苛- 支付牌照- 没办法做



# 1. 支付

## 1.1. 混合(hybrid)开发

arkts-99.9%

仓颉-未来可能用在一些专业软件

鸿蒙原生

混合开发- 原生 + 前端（html + javascript+ css）

原生提供能力

   混合开发的劣势- 性能和动画不如原生的丝滑，交互和产品体验不好

追求产品体验的公司还是用原生开发，打开频率多的用原生，频率少的用混合

Web组件-相当于安卓的webview- 相当于一个浏览器

![image.png](https://cdn.nlark.com/yuque/0/2024/png/274425/1716452526053-efb4f18a-3d4d-4d5a-a650-853b2139d669.png?x-oss-process=image%2Fformat%2Cwebp)

| **技术类型** | **特点**           | **场景**                               |
| ------------ | ------------------ | -------------------------------------- |
| 原生         | 性能好、上架审核慢 | 性能敏感场景、高安全性性场景，比如支付 |
| web          | 性能一般、上线快   | 对时间敏感的场景，比如营销活动         |

## 1.2. 支付宝三方支付

[支付宝开放平台首页](https://open.alipay.com/)，[沙箱账号页面](https://auth.alipay.com/login/ant_sso_index.htm?goto=https%3A%2F%2Fopen.alipay.com%2Fdevelop%2Fsandbox%2Faccount)

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1710490062642-7c45181a-eb23-49e2-be90-a8e5dc6ee925.png)

当前我们有现成的支付宝H5端支付能力，所以需要我们采用**混合开发**的模式进行操作，所谓混合开发就是鸿蒙原生内嵌一个支付宝的h5页面，经过互相通信实现整个支付流程

1. 使用Web组件通过src发起支付宝接口请求（携带订单id参数）
2. 监听Web组件的网络请求变化，如果发现`/pay/redirect` 关键标识，证明支付已经完成
3. 解析回调参数（如果`payResult`参数为true，即为成功）

支付宝沙箱账号，也可以自己注册一个

| 账号                   | 密码   |
| ---------------------- | ------ |
| jpymhk2810@sandbox.com | 111111 |
| fukuvb7569@sandbox.com | 111111 |
| calhno6482@sandbox.com | 111111 |

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718947491151-169ab874-a893-45d7-aac6-dbf8a7c44781.png)



## 1.3. 使用 web 组件发起支付

 [web 组件](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/web-page-loading-with-web-components-V5)

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356249)

- 创建支付页面常量

```typescript
commons/basic/src/main/ets/constants/PAGE_PATH.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView" // 搜索页面
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView" // 搜索结构页面
  static readonly LOGIN_PAGE: string = "LoginView" // 搜索结构页面
  static readonly AI_CUSTOMER_PAGE: string = "AICustomerView" // 搜索结构页面
  static readonly SETTING_PAGE: string = "SettingView" // 设置页面
  static readonly GOODS_PAGE: string = "GoodsView" // 商品详情页面
  static readonly CART_PAGE: string = "CartView" // 购物车页面
  static readonly CHECK_PAGE: string = "CheckView" // 核对订单页面
  static readonly PAY_PAGE: string = "PayView" // 支付页面
}
```



```ts
import { HMRouter, HMRouterMgr } from "@hadss/hmrouter";
import { AppSafeArea, GlobalVariable, hdmDialogHelper, PAGE_PATH } from "basic";
import { webview } from "@kit.ArkWeb";
import { AppStorageV2 } from "@kit.ArkUI";

@HMRouter({ pageUrl: PAGE_PATH.PAY_PAGE })
@ComponentV2
export struct PayView {
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  controller: webview.WebviewController = new webview.WebviewController()
  orderId: string = "" // 订单号

  aboutToAppear(): void {
    this.orderId = HMRouterMgr.getCurrentParam() as string
  }

  build() {
    Column() {
      Web({
        src: `${GlobalVariable.BASE_URL}/pay/wap/aliPay?orderId=${this.orderId}`,
        controller: this.controller
      })
    }
    .width("100%")
    .height("100%")
    .padding({
      top: this.safeArea.topHeight,
      bottom: this.safeArea.bottomHeight
    })

  }
}
```

- 创建支付页面-配置路由

```ts
features/cart/src/main/ets/views/PayView.ets

import { HMRouter, HMRouterMgr } from "@hadss/hmrouter";
import { AppSafeArea, GlobalVariable, PAGE_PATH } from "basic";
import { webview } from "@kit.ArkWeb";
import { AppStorageV2 } from "@kit.ArkUI";
import { DialogHelper, SpinType } from "@pura/harmony-dialog";

@HMRouter({ pageUrl: PAGE_PATH.PAY_PAGE })
@ComponentV2
export struct PayView {
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  controller: webview.WebviewController = new webview.WebviewController()
  orderId: string = "" // 订单号
  dialogKey: string = "" // 弹层的key

  aboutToAppear(): void {
    this.orderId = HMRouterMgr.getCurrentParam() as string
    this.openDialog()
  }

  async openDialog() {
    this.dialogKey = DialogHelper.showLoadingDialog({
      loadColor: Color.White,
      loadSize: 40,
      backgroundColor: '#BB000000',
      content: "正在唤起支付…",
      fontSize: 18,
    })
  }

  build() {
    Column() {
      Web({
        src: `${GlobalVariable.BASE_URL}/pay/wap/aliPay?orderId=${this.orderId}`,
        controller: this.controller
      }).onPageEnd(() => {
        DialogHelper.closeDialog(this.dialogKey)
      })

    }
    .width("100%")
    .height("100%")
    .padding({
      top: this.safeArea.topHeight,
      bottom: this.safeArea.bottomHeight
    })
  }
}
```

- 拿到订单id之后进行跳转

```typescript
features/cart/src/main/ets/views/CheckView.ets

async submitOrder() {
    if (this.payChannel !== 1) {
      return promptAction.showToast({ message: '暂不支持该支付方式' })
    }
    if (!this.addressId) {
      return promptAction.showToast({ message: '未选择收货地址' })
    }

    // 调用创建订单接口
    const result = await createOrderAPI({
      goods: this.goodsList,
      deliveryTimeType: 1,
      payType: 1,
      buyerMessage: '', // 买家留言
      payChannel: 1,
      addressId: this.addressId
    })
    promptAction.showToast({ message: result.id }) // 唤起支付宝支付 -支付宝支付没有沙箱环境的sdk h5支付
    // 跳转到一个支付页面 套壳h5
    HMRouterMgr.push({
      pageUrl: PAGE_PATH.PAY_PAGE,
      param: result.id
    })
    this.showPaySheet = false // 关闭原来的半模态
  }
```



## 1.4. 监听地址变化

[onPageBegin](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-basic-components-web-V5#onpagebegin)

后续所有的操作都是在 web 页面完成的，支付部分在【支付宝】，支付完毕之后会返回

**支付完成最终返回的地址为：**

```
https://meikou-api.itheima.net/pay/redirect?payResult=true&orderId=订单 id
```

1. 监听当前的网页是否包含/pay/redirect
2. 解析参数做支付结果的展示和后续的逻辑处理:

1. 1. payResult的值
   2. orderId的值

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718950809198-2a313e52-fdff-4e52-8de4-c1737888bcb8.png)

- 添加支付结果常量

- 添加支付结果常量

```typescript
commons/basic/src/main/ets/constants/PAGE_PATH.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView" // 搜索页面
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView" // 搜索结构页面
  static readonly LOGIN_PAGE: string = "LoginView" // 搜索结构页面
  static readonly AI_CUSTOMER_PAGE: string = "AICustomerView" // 搜索结构页面
  static readonly SETTING_PAGE: string = "SettingView" // 设置页面
  static readonly GOODS_PAGE: string = "GoodsView" // 商品详情页面
  static readonly CART_PAGE: string = "CartView" // 购物车页面
  static readonly CHECK_PAGE: string = "CheckView" // 核对订单页面
  static readonly PAY_PAGE: string = "PayView" // 支付页面
  static readonly PAY_RESULT_PAGE: string = "PayResultView" // 支付页面
}
```

1. 添加页面，配置路由

```ts
features/cart/src/main/ets/views/PayResultView.ets

import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'
import { HDMGuessGoods, HDMNavBar, PAGE_PATH } from 'basic'

interface PayResultParams {
  orderId: string
  payResult: boolean
}

@HMRouter({ pageUrl: PAGE_PATH.PAY_RESULT_PAGE })
@ComponentV2
export struct PayResultView {
  @Local
  payResult: boolean = false
  @Local
  orderId: string = ''

  aboutToAppear(): void {
    const params = HMRouterMgr.getCurrentParam() as PayResultParams
    if (params) {
      this.orderId = params.orderId
      this.payResult = params.payResult
      // 清空路由栈
      
    }
  }

  build() {
    Column() {
      HDMNavBar({
        title: this.payResult ? '付款成功' : '付款失败', onLeftClick: () => {
          HMRouterMgr.pop()
        }
      })
      List() {
        ListItem() {
          Column({ space: 20 }) {
            Image(this.payResult ? $r('[basic].media.ic_public_check_filled') :
            $r('[basic].media.ic_public_close_filled'))
              .width(60)
              .height(60)
              .fillColor(this.payResult ? '#00C1BF' : '#B0171F')
            Text(this.payResult ? '付款成功' : '付款失败')
            Row({ space: 20 }) {
              Button('返回首页')
                .backgroundColor($r('[basic].color.black'))
                .fontSize(14)
                .height(36)
                .onClick(() => {

                })
              Button('查看订单')
                .fontSize(14)
                .height(36)
                .backgroundColor($r('[basic].color.white'))
                .fontColor($r('[basic].color.black'))
                .border({ width: 0.5, color: $r('[basic].color.border') })
                .onClick(() => {

                })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
          }
          .padding(40)
          .backgroundColor($r('[basic].color.under'))
        }

        ListItem() {
          HDMGuessGoods()
            .height("100%")
        }
      }
      .layoutWeight(1)
      .height('100%')
      .width('100%')
      .scrollBar(BarState.Off)
    }

  }
}
```

2.支付页解析当符合条件时跳转



**参考代码：**

```ts
 products/phone/src/main/ets/pages/PayPage.ets

 Web({
        src: `${GlobalVariable.BASE_URL}/pay/wap/aliPay?orderId=${this.orderId}`,
        controller: this.controller
      }).onPageBegin((event) => {
        // 页面加载前触发
        if (event.url.includes("pay/redirect?payResult")) {
          // 监听回跳
          HMRouterMgr.getPathStack(PAGE_PATH.MAIN_PAGE_ID)?.clear() // HmRouter基于Navigation改造的
          HMRouterMgr.push({
            pageUrl: PAGE_PATH.PAY_RESULT_PAGE,
            param: {
              orderId: this.orderId,
              payResult: event.url.includes("payResult=true")
            }
          })
        }
      })
```



# 十、我的订单模块(作业)

 ![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1719157203604-baf62e24-a8af-4a60-bcea-ee6656181eb9.png?x-oss-process=image%2Fformat%2Cwebp)

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1719157224947-e90bcf7c-51d9-4d6e-991e-ea2c3ef0c4a7.png?x-oss-process=image%2Fformat%2Cwebp)

# 1. 订单

 

## 1.1. 素材整合

 

features/my/src/main/ets/views/OrderView.ets

```ts
import { MkEmpty, MkNavbar, MkDialogLoading, MKPullToRefresh } from '@mk/basic/Index'
import { promptAction, router } from '@kit.ArkUI'
import { OrderItem, OrderSku } from '../viewmodel'

@Builder
function OrderViewBuilder() {
  OrderView()
}

// 顶级组件
@Component
export struct OrderView {
  @StorageProp('safeBottom') safeBottom: number = 0
  @State activeIndex: number = 0
  @State list: OrderItem[] = []
  @State isEmpty: boolean = false
  @Consume
  pageStack: NavPathStack
  page: number = 1
  totalPage: number = 0
  scroller = new Scroller()
  // 自定义 dialog
  dialog = new CustomDialogController({
    builder: MkDialogLoading(),
    customStyle: true,
    alignment: DialogAlignment.Center,
    maskColor: '22000000',
    autoCancel: false
  })

  @Builder
  ListBuilder() {
    List({ scroller: this.scroller }) {
      ListItem()
      ForEach(this.list, (order: OrderItem) => {
        ListItem() {
          OrderItemComp({ order })
        }
      })
      ListItem() {
        Row()
          .height(this.safeBottom - 8)
      }
    }
    .divider({
      strokeWidth: 8,
      color: $r('[basic].color.under')
    })
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.None)
  }

  build() {
    NavDestination() {
      Column() {
        MkNavbar({ title: '我的订单', bg: $r('[basic].color.under') })
        Row() {
          // MKTabs({
          //   activeIndex: this.activeIndex,
          //   tabConfig: [
          //     { name: '全部' },
          //     { name: '待付款' },
          //     { name: '待发货' },
          //     { name: '待收货' },
          //     { name: '待评价' }
          //   ],
          //   spaceBetween: true,
          //   onTabChange: (_item, index) => {
          //     promptAction.showToast({
          //       message: `index:${index},item${JSON.stringify(_item)}`
          //     })
          //   }
          // })
        }
        .height(40)

        if (this.isEmpty) {
          MkEmpty()
        }
        // 下拉组件 触底组件
        MKPullToRefresh({
          data: this.list,
          scroller: this.scroller,
          customList: () => {
            this.ListBuilder()
          },
          onLoadMore: async () => {
            return undefined
          },
          customRefresh: null,
          customLoad: null,
        })
          .width('100%')
          .height('100%')
          .layoutWeight(1)
      }
      .backgroundColor($r('[basic].color.under'))
    }
    .hideTitleBar(true)

  }
}

// 列表项
@Component
struct OrderItemComp {
  @Prop order: OrderItem
  timer: number = 0
  @State countDown: string = ''

  @Builder
  StateBuilder() {
    if (this.order.orderState === 1) {
      Row() {
        Text('待付款')
          .textAlign(TextAlign.Center)
          .width(50)
          .fontColor($r('[basic].color.white'))
          .fontSize(11)
          .height(18)
          .borderRadius({ bottomRight: 9 })
          .linearGradient({
            angle: 90,
            colors: [[$r('[basic].color.linear_begin'), 0], [$r('[basic].color.linear_end'), 1]]
          })
        Text(this.countDown)
          .textAlign(TextAlign.Center)
          .width(60)
          .fontSize(11)
          .fontColor($r('[basic].color.red'))
      }
      .backgroundColor('#FFDEE2')
      .height(18)
      .borderRadius(9)
      .clip(true)
    } else if (this.order.orderState === 2) {
      Text('待发货')
        .fontSize(12)
        .fontColor($r('[basic].color.red'))
    } else if (this.order.orderState === 3) {
      Text('待收货')
        .fontSize(12)
        .fontColor($r('[basic].color.red'))
    } else if (this.order.orderState === 4) {
      Text('待评价')
        .fontSize(12)
        .fontColor($r('[basic].color.black'))
    } else if (this.order.orderState === 5) {
      Text('已完成')
        .fontSize(12)
        .fontColor($r('[basic].color.black'))
    } else if (this.order.orderState === 6) {
      Text('已取消')
        .fontSize(12)
        .fontColor($r('[basic].color.gray'))
    }
  }

  @Builder
  ButtonBuilder() {
    Row({ space: 10 }) {
      if ([5, 6].includes(this.order.orderState)) {
        Button('删除订单')
          .whiteStyle()
          .onClick(() => {
            // TODO
          })
      }
      if ([5].includes(this.order.orderState)) {
        Button('查看评价')
          .whiteStyle()
          .onClick(() => {
            // TODO
          })
      }
      if ([3, 4, 5].includes(this.order.orderState)) {
        Button('查看物流')
          .whiteStyle()
          .onClick(() => {
            router.pushUrl({ url: 'pages/OrderLogisticsPage' })
          })
      }
      if ([1].includes(this.order.orderState)) {
        Button('取消订单')
          .whiteStyle()
          .onClick(() => {
            // TODO
          })
      }
      if ([1].includes(this.order.orderState)) {
        Button('立即付款')
          .redStyle()
          .onClick(() => {
            // TODO
          })
      }
      if ([2, 5, 6].includes(this.order.orderState)) {
        Button('再次购买')
          .redStyle()
          .onClick(() => {
            // TODO
          })
      }
      if ([3].includes(this.order.orderState)) {
        Button('确认收货')
          .redStyle()
          .onClick(() => {
            // TODO
          })
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.End)
  }

  build() {
    Row() {
      Column() {
        Row() {
          Text(this.order.createTime)
            .fontSize(12)
            .fontColor($r('[basic].color.gray'))
          this.StateBuilder()
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)

        ForEach(this.order.skus, (sku: OrderSku) => {
          OrderSkuComp({ goods: sku })
        })

        Text('实付款：¥' + this.order.payMoney)
          .fontWeight(500)
          .fontColor($r('[basic].color.black'))
          .alignSelf(ItemAlign.End)
          .padding({ top: 10, bottom: 10 })

        this.ButtonBuilder()
      }
      .padding(10)
      .borderRadius(8)
      .backgroundColor($r('[basic].color.white'))
    }
    .padding({ left: 8, right: 8 })
  }
}

// 订单信息
@Component
struct OrderSkuComp {
  @Prop goods: OrderSku

  build() {
    Row({ space: 10 }) {
      Image(this.goods.image)
        .width(80)
        .height(80)
      Column({ space: 10 }) {
        Text(this.goods.name)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .fontColor($r('[basic].color.black'))
          .fontSize(14)
          .width('100%')
        Text(this.goods.attrsText)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .fontColor($r('[basic].color.text'))
          .fontSize(14)
      }
      .justifyContent(FlexAlign.Start)
      .layoutWeight(1)
      .height(80)

      Column({ space: 10 }) {
        Text('¥' + this.goods.curPrice)
          .fontSize(14)
          .fontColor($r('[basic].color.black'))
        Text('x' + this.goods.quantity)
          .fontSize(14)
          .fontColor($r('[basic].color.gray'))
      }
      .justifyContent(FlexAlign.Start)
      .alignItems(HorizontalAlign.End)
      .width(70)
      .height(80)
    }
    .padding({ top: 10, bottom: 10 })
  }
}

// 扩展按钮
@Extend(Button)
function whiteStyle() {
  .fontWeight(400)
  .fontSize(14)
  .height(30)
  .backgroundColor($r('[basic].color.white'))
  .fontColor($r('[basic].color.black'))
  .padding({
    left: 10,
    right: 10,
    top: 0,
    bottom: 0
  })
  .border({ width: 0.5, color: $r('[basic].color.border') })
}

@Extend(Button)
function redStyle() {
  .fontWeight(400)
  .fontSize(14)
  .height(30)
  .padding({
    left: 10,
    right: 10,
    top: 0,
    bottom: 0
  })
  .backgroundColor($r('[basic].color.red'))
}


```

1. 数据模型

```ts
features/my/src/main/ets/viewmodel/index.ets

export interface OrderItem {
  countdown: number;
  createTime: string;
  id: string;

  // 1为待付款、2为待发货、3为待收货、4为待评价、5为已完成、6为已取消，未传该参数或0为全部
  orderState: 1 | 2 | 3 | 4 | 5 | 6;
  payChannel: number;
  payLatestTime: string;
  payMoney: number;
  payType: number;
  postFee: number;
  skus: OrderSku[];
  totalMoney: number;
  totalNum: number;
}

export interface OrderSku {
  attrsText: string;
  curPrice: number;
  id: string;
  image: string;
  name: string;
  properties: Property[];
  quantity: number;
  realPay: number;
  spuId: string;
}

export interface Property {
  propertyMainName: string;
  propertyValueName: string;
}

export interface GetOrderParams {
  page: number
  pageSize: number
  orderState: number
}

export interface GetOrderResult {
  counts: number
  pageSize: number
  pages: number
  page: number
  items: OrderItem[]
}
```

1. 跳转逻辑:,携带不同参数跳转到订单页

```ts
features/my/src/main/ets/views/MyView.ets
 
 Column() {
              Text('我的订单')
                .fontSize(14)
                .width('100%')
                .padding({ left: 8, top: 8 })
                .lineHeight(22)
                .fontWeight(500)
                .fontColor($r('[basic].color.black'))
              GridRow({ columns: 5 }) {
                GridCol() {
                  NavComp({ icon: $r('app.media.ic_user_order'), text: '全部订单' })
                    .onClick(() => {
                      // TODO 订单页，无参数
                      this.pageStack.pushPathByName('OrderView', 0)
                    })
                }

                GridCol() {
                  NavComp({ icon: $r('app.media.ic_user_obligation'), text: '待付款' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=1
                      this.pageStack.pushPathByName('OrderView', 1)
                    })
                }

                GridCol() {
                  NavComp({ icon: $r('app.media.ic_user_unreceived'), text: '待发货' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=2
                      this.pageStack.pushPathByName('OrderView', 2)
                    })
                }

                GridCol() {
                  NavComp({ icon: $r('app.media.ic_user_unshipped'), text: '待收货' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=3
                      this.pageStack.pushPathByName('OrderView', 3)
                    })
                }

                GridCol() {
                  NavComp({ icon: $r('app.media.ic_user_unevaluated'), text: '待评价' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=4
                      this.pageStack.pushPathByName('OrderView', 4)
                    })
                }
              }
              .width('100%')
            }
            .backgroundColor($r('[basic].color.white'))
            .borderRadius(10)
```

git 记录

Order-素材整合

## 1.2. MkTabs 组件

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1719182513143-62cefac2-a775-4c39-a380-46e2c9456d74.png)

[onAreaChange事件](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-universal-component-area-change-event-V5)

**需求:**

1. 高亮文本切换
2. 底部指示线条移动
3. 利用 onAreaChange 事件来完成

接下来完成一个自定义的Tabs组件

1. 素材整合

```ts
commons/basic/src/main/ets/components/MKTabs.ets

export interface MKTabItem {
  name: string
  value?: string | number
}

@Component
export struct MKTabs {
  @Prop
  @Watch('onActiveIndexChange')
  activeIndex: number = 0
  @Prop
  tabConfig: MKTabItem[] = []
  @Prop
  lineWidth: number = 20
  @Prop
  lineHeight: number = 2
  @Prop
  tabHeight: number = 40
  @Prop
  gutter: number = 20
  @Prop
  paddingLeft: number = this.gutter
  @Prop
  paddingRight: number = this.gutter
  @State
  left: number = 0
  // cb
  onTabClick?: (tab: MKTabItem, index: number) => void
  onTabChange?: (tab: MKTabItem, index: number) => void
  list: Area[] = []
  spaceBetween: boolean = false

  // 设置线位置
  setLineLeft(area: Area) {
    // TODO
  }

  onActiveIndexChange() {
    this.setLineLeft(this.list?.[this.activeIndex])
  }

  @Builder
  TabBuilder(tab: MKTabItem, index: number) {
    Text(tab.name)
      .fontSize(15)
      .fontColor(this.activeIndex === index ? $r('app.color.black') : $r('app.color.gray'))
      .fontWeight(this.activeIndex === index ? 500 : 400)
      .animation({
        duration: 300
      })
      .onClick((e) => {
        if (this.activeIndex !== index) {
          this.activeIndex = index
        }
      })
      .onAreaChange((_o, n) => {
        this.list[index] = n
        if (this.activeIndex === index) {
          this.setLineLeft(n)
        }
      })
  }

  build() {
    Row() {
      Row({ space: this.gutter }) {
        ForEach(this.tabConfig, (item: MKTabItem, index) => {
          this.TabBuilder(item, index)
        })
      }
      .width('100%')
      .padding({ left: this.paddingLeft, right: this.paddingRight })
      .height(this.tabHeight)
      .border({
        width: { bottom: 0.5 },
        color: $r('app.color.under')
      })
      .justifyContent(this.spaceBetween ? FlexAlign.SpaceBetween : FlexAlign.Start)

      // 移动的文本
      Text()
        .width(this.lineWidth)
        .height(this.lineHeight)
        .backgroundColor($r('app.color.black'))
        .position({ x: this.left, y: this.tabHeight - this.lineHeight })
    }
    .layoutWeight(1)
  }
}
```



参考代码：

```ts
commons/basic/src/main/ets/components/MKTabs.ets

export interface MKTabItem {
  name: string
  value?: string | number
}

@Component
export struct MKTabs {
  @Prop
  @Watch('onActiveIndexChange')
  activeIndex: number = 0
  @Prop
  tabConfig: MKTabItem[] = []
  @Prop
  lineWidth: number = 20
  @Prop
  lineHeight: number = 2
  @Prop
  tabHeight: number = 40
  @Prop
  gutter: number = 20
  @Prop
  paddingLeft: number = this.gutter
  @Prop
  paddingRight: number = this.gutter
  @State
  left: number = 0
  // cb
  onTabClick?: (tab: MKTabItem, index: number) => void
  onTabChange?: (tab: MKTabItem, index: number) => void
  list: Area[] = []
  spaceBetween: boolean = false

  // 设置线位置
  setLineLeft(area: Area) {
    const width = area.width as number
    const x = area.position.x as number
    this.lineWidth = area.width as number
    animateTo({ duration: 300 }, () => {
      this.left = x + (width - this.lineWidth) / 2
    })
  }

  onActiveIndexChange() {
    this.setLineLeft(this.list?.[this.activeIndex])
  }

  @Builder
  TabBuilder(tab: MKTabItem, index: number) {
    Text(tab.name)
      .fontSize(15)
      .fontColor(this.activeIndex === index ? $r('app.color.black') : $r('app.color.gray'))
      .fontWeight(this.activeIndex === index ? 500 : 400)
      .animation({
        duration: 300
      })
      .onClick((e) => {
        if (this.activeIndex !== index) {
          this.activeIndex = index
          // 改变才触发
          this.onTabChange && this.onTabChange(tab, index)
        }
        // 点了就触发
        this.onTabClick && this.onTabClick(tab, index)
      })
      .onAreaChange((_o, n) => {
        this.list[index] = n
        if (this.activeIndex === index) {
          this.setLineLeft(n)
        }
      })
  }

  build() {
    Row() {
      Row({ space: this.gutter }) {
        ForEach(this.tabConfig, (item: MKTabItem, index) => {
          this.TabBuilder(item, index)
        })
      }
      .width('100%')
      .padding({ left: this.paddingLeft, right: this.paddingRight })
      .height(this.tabHeight)
      .border({
        width: { bottom: 0.5 },
        color: $r('app.color.under')
      })
      .justifyContent(this.spaceBetween ? FlexAlign.SpaceBetween : FlexAlign.Start)

      // 移动的文本
      Text()
        .width(this.lineWidth)
        .height(this.lineHeight)
        .backgroundColor($r('app.color.black'))
        .position({ x: this.left, y: this.tabHeight - this.lineHeight })
    }
    .layoutWeight(1)
  }
}
```

git 记录

Order-MkTabs 组件

## 1.3. 路由参数解析及高亮切换

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1719182529654-2029633b-5e0e-4b0d-97a7-f2d0c464450b.png)

需求：

1.  解析跳转而来的【状态 id】
2. 切换 Tabs 组件的【高亮索引】

核心步骤：

1. aboutToAppear 中解析
2. 设置高亮状态即可

```ts
features/my/src/main/ets/views/OrderView.ets

aboutToAppear(): void {
  this.activeIndex = this.pageStack.getParamByName('OrderView')[0] as number
}
```

git 记录

Order-路由参数解析及高亮切换

## 1.4. 初始数据获取

[接口文档](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356242)

需求：

1. 页面打开根据【状态】获取数据

1. 1. （5 条一次）
   2. 【考虑触底加载】

1. 记录总页数
2. 考虑数据的情况

核心步骤：

1. 抽取 api
2. 生命周期钩子中获取数据

1. 抽取 api

```ts
features/my/src/main/ets/api/index.ets

export const getOrderAPI = (params: GetOrderParams) => {
  return RequestAxios.get<GetOrderResult>('/member/order', {
    params
  })
}
```

2.

```ts
features/my/src/main/ets/views/OrderView.ets

aboutToAppear(): void {
  this.activeIndex = this.pageStack.getParamByName('OrderView')[0] as number
}

async getData() {
  this.dialog.open()
  const res = await getOrderAPI({
    page: this.page,
    pageSize: 5,
    orderState: this.activeIndex
  })
  this.totalPage = res.data.result.pages
  // 连接到一起 之后触底加载公用这个逻辑
  this.list = this.list.concat(res.data.result.items)
  if (this.list.length === 0) {
    this.isEmpty = true
  }
  this.dialog.close()
}
```



## 1.5. 数据切换

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1719185790109-c1f4b552-3966-4662-b6b8-078500846110.png)

**需求：**

1. MkTabs 实现回传索引及当前数据项
2. 切换索引改变时重新获取数据

核心步骤：

1. 实现回调函数逻辑
2. 回调函数中重新获取数据即可

```ts
commons/basic/src/main/ets/components/MKTabs.ets

.onClick((e) => {
  if (this.activeIndex !== index) {
    // this.setLineLeft(e.target.area)
    this.activeIndex = index
    this.onTabChange && this.onTabChange(tab, index)
  }
  this.onTabClick && this.onTabClick(tab, index)
})
onTabChange: (_item, index) => {
  this.list = []
  this.activeIndex = index
  this.page = 1
  this.totalPage = 0
  this.getData()
}

// 空组件调整
MKEmpty({
  tip: '该分类为空',
  buttonText: '去逛逛',
  onClickButton: () => {
    this.pageStack.popToIndex(-1)
  }
})
```



## 1.6. 下拉刷新及触底加载更多

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1719186639820-a978157b-bc3e-476b-9fb0-a3ece16bc369.png)![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1719186656872-15896605-8f1e-4d77-8a7d-4b4f0f0eb2a8.png)

需求：

1. 下拉刷新
2. 触底加载更多

核心步骤：

1. 实现 PullToRefresh 组件的【下拉】和【触底】逻辑即可

1. 1. 下拉：重置数据，重新获取
   2. 触底：到底判断-》累加页码-》获取更多

1. 可以视情况自行增加 LazyForEach

```ts
MKPullToRefresh({
  data: this.list,
  scroller: this.scroller,
  customList: () => {
    this.ListBuilder()
  },
  onRefresh: async () => {
    this.list = []
    this.totalPage = 0
    await this.getData()
    return '刷新成功'
  },
  onLoadMore: async () => {
    if (this.page < this.totalPage) {
      this.page++
      await this.getData()
    } else {
      promptAction.showToast({
        message: '没有更多啦'
      })
    }
    return undefined
  },
  customRefresh: null,
  customLoad: null,
})
  .width('100%')
  .height('100%')
  .layoutWeight(1)
```

