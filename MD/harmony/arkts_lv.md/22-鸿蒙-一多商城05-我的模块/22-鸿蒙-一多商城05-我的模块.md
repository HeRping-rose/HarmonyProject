# 五、我的模块

 

# 1. 我的

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718056795194-98e01aa9-0b36-4c27-9ce9-16bf8c0476f3.png?x-oss-process=image%2Fformat%2Cwebp)

## 1.1. 我的页面基本页面结构

首先将素材整合进来

**核心步骤：**

1. 整合图片资源
2. 整合视图
3. 引用 Commons/basic

- 在basic模块下建立components/HDMNavCol组件

```ts
commons/basic/src/main/ets/components/HDMNavCol.ets

@ComponentV2
export struct HDMNavCol {
  @Param
  icon: ResourceStr = ''
  @Param
  text: string = ''
  @Param
  color: ResourceColor = $r('app.color.black')

  build() {
    GridCol() {
      Column() {
        Image(this.icon)
          .width(24)
          .aspectRatio(1)
        Text(this.text)
          .fontColor(this.color)
          .fontSize(12)
          .lineHeight(22)
          .margin({ top: 4 })
      }
      .padding({ top: 16, bottom: 10 })
    }
  }
}
```

- 替换MineView组件

```ts
features/mine/src/main/ets/views/MineView.ets

import { AppSafeArea, HDMNavCol, PAGE_PATH } from "basic"
import { AppStorageV2 } from "@kit.ArkUI"


@ComponentV2
export struct MineView {
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!

  build() {
    Column() {
      Scroll() {
        Column() {
          // header
          Column() {
            Row() {
              Blank()
              if (true) {
                Image($r('[basic].media.ic_public_settings'))
                  .width(24)
                  .aspectRatio(1)
                  .onClick(() => {
                   
                  })
              }


            }
            .width('100%')
            .height(50)

            Row({ space: 16 }) {
              // 头像
              Image($r('app.media.ic_user_avatar'))
                .width(40)
                .aspectRatio(1)
                .borderRadius(20)
              if (true) {
                Text("张三")
                  .fontColor($r('[basic].color.black'))
                  .fontWeight(500)
              } else {
                Text('立即登录')
                  .fontColor($r('[basic].color.black'))
                  .fontWeight(500)
                  .onClick(() => {

                  })
              }
            }
            .width('100%')
            .height(72)

            Row({ space: 8 }) {
              Image($r('app.media.ic_user_vip'))
                .width(24)
                .aspectRatio(1)
              Text('升级美蔻商城会员，尊享无限免邮')
                .fontSize(12)
                .fontColor('#7E2C1A')
                .layoutWeight(1)
              Button('立即开通')
                .width(64)
                .height(24)
                .fontSize(10)
                .padding(0)
                .backgroundColor('#7E2C1A')
            }
            .padding({ left: 8, right: 8 })
            .width('100%')
            .height(40)
            .borderRadius({ topLeft: 10, topRight: 10 })
            .linearGradient({
              angle: 110,
              colors: [['#F9D8AB', 0], ['#F9E3CC', 1]]
            })

          }
          .padding({ left: 16, right: 16, top: this.safeArea.topHeight })
          .linearGradient({
            angle: 180,
            colors: [['#FFF1E5', 0], [$r('[basic].color.under'), 1]]
          })

          // nav
          Column({ space: 8 }) {
            GridRow({ columns: 3 }) {
              GridCol() {
                HDMNavCol({ icon: $r('app.media.ic_user_collect'), text: '我的收藏', color: $r('[basic].color.text') })
              }

              GridCol() {
                HDMNavCol({ icon: $r('app.media.ic_user_history'), text: '我的足迹', color: $r('[basic].color.text') })
                  .onClick(() => {

                  })
              }

              GridCol() {
                HDMNavCol({ icon: $r('app.media.ic_user_service'), text: '我的客服', color: $r('[basic].color.text') })
              }
            }
            .width('100%')
            .linearGradient({
              angle: 180,
              colors: [['#FFF1E5', 0], [$r('[basic].color.white'), 0.15], [$r('[basic].color.white'), 1]]
            })
            .borderRadius(10)

            Column() {
              Text('我的订单')
                .fontSize(14)
                .width('100%')
                .padding({ left: 8, top: 8 })
                .lineHeight(22)
                .fontWeight(500)
                .fontColor($r('[basic].color.black'))
              GridRow({ columns: 5 }) {
                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_order'), text: '全部订单' })
                    .onClick(() => {
                      // TODO 订单页，无参数
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_obligation'), text: '待付款' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=1
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_unreceived'), text: '待发货' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=2
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_unshipped'), text: '待收货' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=3
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_unevaluated'), text: '待评价' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=4
                    })
                }
              }
              .width('100%')
            }
            .backgroundColor($r('[basic].color.white'))
            .borderRadius(10)
          }
          .padding({ left: 8, right: 8 })

          // guess

        }
      }
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('[basic].color.under'))
  }
}
```

- 在mine模块添加于basic的依赖

```ts
{
  "name": "mine",
  "version": "1.0.0",
  "description": "Please describe the basic information.",
  "main": "Index.ets",
  "author": "",
  "license": "Apache-2.0",
  "packageType": "InterfaceHar",
  "dependencies": {
    "basic": "file:../../commons/basic"
  }
}
```



## 1.2. 猜你喜欢-组件

猜你喜欢用的位置挺多的，咱们将他实现为组件

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718057315216-a52c82f0-116b-4613-b542-6ba2306df991.png)

- 将HDMGoods挪入到basic模块

```ts
commons/basic/src/main/ets/components/HDMGoods.ets

import { HDMGoodsItem } from "../viewmodels"

@ComponentV2
export struct HDMGoods {
  @Param
  goods: HDMGoodsItem = {} as HDMGoodsItem
  @Param
  smallImage: boolean = false

  build() {
    Column({ space: 10 }) {
      if (this.smallImage) {
        Row() {
          Image(this.goods.picture)
            .alt($r("app.media.empty"))
            .width('100%')
            .aspectRatio(1)
        }
        .width('100%')
        .padding(20)
      } else {
        Image(this.goods.picture)
          .alt($r("app.media.empty"))
          .width('100%')
          .aspectRatio(1)
      }
      Text(this.goods.name)
        .fontSize(14)
        .fontColor($r('app.color.text'))
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .width('100%')
        .padding({ left: 10, right: 10 })
      Row({ space: 4 }) {
        Text('¥' + Number(this.goods.price))
          .fontSize(14)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.black'))
        Text('¥999')
          .fontSize(8)
          .fontColor($r('app.color.gray'))
          .decoration({ type: TextDecorationType.LineThrough, color: $r('app.color.gray') })
        Blank()
        Text('2.9万+人付款')
          .fontSize(10)
          .fontColor($r('app.color.gray'))
      }
      .alignItems(VerticalAlign.Bottom)
      .width('100%')
      .margin({ bottom: 10 })
      .padding({ left: 10, right: 10 })
    }
    .width('100%')
    .backgroundColor($r('app.color.white'))
    .borderRadius(8)
    .clip(true)
  }
}
```

- 在components/index.ets中注册

```ts
commons/basic/src/main/ets/components/index.ets

export * from './HDMGoods'
```

将原来home模块的应用换成basic

需要把home中的类型提到basic

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743239312171-66dc39e6-600b-4bde-8214-452b2dced910.png)

- 实现类型

```typescript
commons/basic/src/main/ets/viewmodels/business.ets

// 猜你喜欢的参数
export interface GuessParams {
  page: number
  pageSize: number
}

// 搜索和猜你喜欢的返回类型
export interface GoodsItems {
  counts: number;
  items: HDMGoodsItem[];
  page: number;
  pages: number;
  pageSize: number;
}
```

- 在basic模块下封装api

```ts
commons/basic/src/main/ets/api/guess.ets

import { RequestRcp } from '../utils'
import { GoodsItems } from '../viewmodels'

// 获取猜你喜欢的API
export const getGuessDataAPI = (params: object) => {
  return RequestRcp.get<GoodsItems>("/home/goods/guessLike", params)
}
```

- 在我的组件中显示

```ts
features/mine/src/main/ets/views/MineView.ets

HDMGuessGoods()
```

- 利用自己封装的HDMGuess组件，实现底部猜我喜欢的复用

```ts
commons/basic/src/main/ets/components/HDMGuessGoods.ets

import { HDMGoods } from "."
import { getGuessDataAPI } from "../api/guess"
import { AppBreakPoint, AppSafeArea, BreakPointType, GuessParams, HDMGoodsItem } from "../viewmodels"
import { AppStorageV2 } from "@kit.ArkUI"

@ComponentV2
export struct HDMGuessGoods {
  breakObj: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  appSafe: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  @Param
  title: string = "猜你喜欢"
  @Local
  list: HDMGoodsItem[] = []
  @Local
  loading: boolean = false
  @Local
  finished: boolean = false
  params: GuessParams = {
    page: 1,
    pageSize: 8
  }

  aboutToAppear(): void {
    this.getGuessList()
  }

  async getGuessList() {
    const res = await getGuessDataAPI(this.params) // 10
    this.list.push(...res.items)
    if (this.params.page >= res.pages) {
      this.finished = true
    } else {
      this.params.page++
    }

  }

  @Builder
  getFootBuilder() {
    Row({ space: 10 }) {
      if (this.loading) {
        Text("加载中...")
          .fontSize(12)
          .fontColor($r("app.color.gray"))
        LoadingProgress()
          .width(20)
          .aspectRatio(1)
      } else {
        if (this.finished) {
          Text("没有啦")
            .fontSize(12)
            .fontColor($r("app.color.gray"))
        }
      }

    }
    .width("100%")
    .height(50)
    .justifyContent(FlexAlign.Center)
  }

  build() {
    Column() {
      Row() {
        Text(this.title)
          .fontColor($r("app.color.black"))
      }
      .width("100%")
      .height(50 + this.appSafe.topHeight)
      .justifyContent(FlexAlign.Center)
      .backgroundColor($r("app.color.white"))
      .margin({
        bottom: 10,
      })
      .padding({
        top: this.appSafe.topHeight
      })

      WaterFlow({ footer: this.getFootBuilder }) {
        Repeat<HDMGoodsItem>(this.list)
          .each((obj: RepeatItem<HDMGoodsItem>) => {
            FlowItem() {
              HDMGoods({ goods: obj.item })
            }
          })
          .virtualScroll()
          .key((item: HDMGoodsItem, index: number) => `${index}_${JSON.stringify(item)}`)

      }
      .cachedCount(1)
      .nestedScroll({
        scrollForward: NestedScrollMode.PARENT_FIRST, // 父组件先滚动
        scrollBackward: NestedScrollMode.SELF_FIRST
      })
      .columnsTemplate(
        new BreakPointType({
          sm: '1fr 1fr',
          md: '1fr 1fr 1fr',
          lg: '1fr 1fr 1fr 1fr',
        }).getValue(this.breakObj.breakPoint)
      )
      .rowsGap(10)
      .columnsGap(10)
      .onReachEnd(async () => {
        if (!this.loading && !this.finished) {
          this.loading = true
          await this.getGuessList()
          this.loading = false
        }
      })
    }
    .height("100%")
    // .height(`calc(100% - ${this.appSafe.topHeight}vp)`) // calc
    .padding(10)

  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743240852599-ebf9c2ee-135f-4571-9fcc-f8907da3e14d.png)





## 1.3. 登录

C端产品-抖音/快手/京东/b站/美团/支付宝

C端B端产品- 抖音审核员/外卖配送员/审核app 给某一类人员特用

B端产品-银行/给一些企业/单位

G端产品

军工类

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718059183202-ebf351df-8da9-440d-99dc-fe446b53a14a.png)

### 1.3.1. 登录页基本结构搭建

**核心步骤：**

- 准备登录的基本页面

- 路径常量-登录页写入到变量中-basic

```ts
commons/basic/src/main/ets/constants/PagePath.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView" // 搜索页面
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView" // 搜索结构页面
  static readonly LOGIN_PAGE: string = "LoginView" // 搜索结构页面

}
```

**LoginView基础模版**

```ts
features/mine/src/main/ets/views/LoginView.ets

import { AppSafeArea, HDMNavBar, PAGE_PATH } from 'basic'
import { AppStorageV2, promptAction } from '@kit.ArkUI'

import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'

@Preview
@HMRouter({ pageUrl: PAGE_PATH.LOGIN_PAGE })
@ComponentV2
export struct LoginView {
  @Local account: string = '13200000010'
  @Local password: string = '123456'
  @Local agree: boolean = false
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!

  aboutToAppear(): void {

  }

  async onSubmit() {
    if (!this.agree) {
      return promptAction.showToast({ message: '请先勾选协议' })
    }
  }

  @Styles
  form() {
    .width('100%')
    .height(42)
    .padding({
      left: 16,
      right: 16,
      top: 0,
      bottom: 0
    })
  }

  build() {
    Column() {
      HDMNavBar({
        title: '华优购登录',
        onLeftClick: () => {
          HMRouterMgr.pop()
        }
      })
      Column({ space: 16 }) {
        Text('账号密码登录')
          .fontSize(18)
          .fontColor($r('[basic].color.black'))
          .width('100%')
          .fontWeight(500)
          .margin({ bottom: 10 })
        TextInput({ placeholder: '请输入账号', text: $$this.account })
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .form()
        TextInput({ placeholder: '请输入密码', text: $$this.password })
          .type(InputType.Password)
          .showPasswordIcon(false)
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .form()

        Row({ space: 4 }) {
          Checkbox()
            .select($$this.agree)
            .width(12)
            .aspectRatio(1)
            .selectedColor($r('[basic].color.black'))
            .mark({ size: 10, strokeWidth: 1 })
          Text() {
            Span('查看并同意')
            Span('《隐私条款》')
              .fontColor('#007DFB')
            Span('和')
            Span('《用户协议》')
              .fontColor('#007DFB')
          }
          .width('100%')
          .fontSize(12)
          .fontColor($r('[basic].color.gray'))
        }

        Button('登录')// .backgroundColor(this.valid ? $r('[basic].color.black') : '#D4D2D9')
          .fontColor($r('[basic].color.white'))
          .form()
          .onClick(() => {
            this.onSubmit()
          })

        Row() {
          Blank()
          Text('忘记密码')
            .fontColor('#007DFB')
            .fontSize(12)
        }
        .width('100%')

        Column({ space: 16 }) {
          Stack() {
            Text()
              .width(200)
              .height(1)
              .backgroundColor($r('[basic].color.under'))
            Text('其他登录方式')
              .width(100)
              .fontSize(12)
              .backgroundColor($r('[basic].color.white'))
              .fontColor($r('[basic].color.text'))
              .textAlign(TextAlign.Center)
          }

          Row() {
            // 后续放置华为登录
          }
        }
        .margin({ top: 200 })
      }
      .padding(30)
    }
    .width('100%')
    .height('100%')

  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/38706227/1747447481287-896381a4-2514-4c2e-b727-077abb5b79a6.png)

- 我的页面跳转登录页面

```ts
  features/mine/src/main/ets/views/MyView.ets

  Text('立即登录')
    .fontColor($r('[basic].color.black'))
    .fontWeight(500)
    .onClick(() => {
      HMRouterMgr.push({
        pageUrl: PAGE_PATH.LOGIN_PAGE
      })
    })
```



### 1.3.2. 实现登录表单校验

- 声明表单数据类型

```ts
features/mine/src/main/ets/viewmodels/user.ets

export interface LoginForm {
  account: string
  password: string
}

@ObservedV2
export class LoginFormModel implements LoginForm {
  @Trace
  account: string = ''
  @Trace
  password: string = ''

  constructor(model: LoginForm) {
    this.account = model.account
    this.password = model.password
  }
}
```



```typescript
features/mine/src/main/ets/views/LoginView.ets

import { AppSafeArea, HDMNavBar, PAGE_PATH } from 'basic'
import { AppStorageV2, promptAction } from '@kit.ArkUI'

import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'
import { LoginFormModel } from '../viewmodels'

@Preview
@HMRouter({ pageUrl: PAGE_PATH.LOGIN_PAGE })
@ComponentV2
export struct LoginView {
  // @Local account: string = '13200000010' // 13200000010 - 13200000060
  // @Local password: string = '123456'
  loginForm: LoginFormModel = new LoginFormModel({
    account: '13200000005',
    password: '123456'
  })
  @Local agree: boolean = false
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!

  @Monitor("loginForm.account")
  updateAccount(monitor: IMonitor) {
    // promptAction.showToast({ message: monitor.value()?.before as string })
  }

  @Computed
  get btnEnable() {
    return !!(this.loginForm.account && this.loginForm.password)
  }

  aboutToAppear(): void {

  }

  async onSubmit() {
    if (!this.agree) {
      return promptAction.showToast({ message: '请先勾选协议' })
    }
  }

  @Styles
  form() {
    .width('100%')
    .height(42)
    .padding({
      left: 16,
      right: 16,
      top: 0,
      bottom: 0
    })
  }

  build() {
    Column() {
      HDMNavBar({
        title: '惠多美登录',
        onLeftClick: () => {
          HMRouterMgr.pop()
        }
      })
      Column({ space: 16 }) {
        Text('账号密码登录')
          .fontSize(18)
          .fontColor($r('[basic].color.black'))
          .width('100%')
          .fontWeight(500)
          .margin({ bottom: 10 })
        TextInput({ placeholder: '请输入账号', text: $$this.loginForm.account })
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .form()
        TextInput({ placeholder: '请输入密码', text: $$this.loginForm.password })
          .type(InputType.Password)
          .showPasswordIcon(false)
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .form()

        Row({ space: 4 }) {
          Checkbox()
            .select($$this.agree)
            .width(12)
            .aspectRatio(1)
            .selectedColor($r('[basic].color.black'))
            .mark({ size: 10, strokeWidth: 1 })
          Text() {
            Span('查看并同意')
            Span('《隐私条款》')
              .fontColor('#007DFB')
            Span('和')
            Span('《用户协议》')
              .fontColor('#007DFB')
          }
          .width('100%')
          .fontSize(12)
          .fontColor($r('[basic].color.gray'))
        }

        Button('登录')
          .backgroundColor(this.btnEnable ? $r('[basic].color.black') : '#D4D2D9')
          .fontColor(this.btnEnable ? $r('[basic].color.white') : $r('[basic].color.black'))
          .form()
          .enabled(this.btnEnable)
          .onClick(() => {
            this.onSubmit()
          })

        Row() {
          Blank()
          Text('忘记密码')
            .fontColor('#007DFB')
            .fontSize(12)
        }
        .width('100%')

        Column({ space: 16 }) {
          Stack() {
            Text()
              .width(200)
              .height(1)
              .backgroundColor($r('[basic].color.under'))
            Text('其他登录方式')
              .width(100)
              .fontSize(12)
              .backgroundColor($r('[basic].color.white'))
              .fontColor($r('[basic].color.text'))
              .textAlign(TextAlign.Center)
          }

          Row() {
            // 后续放置华为登录
          }
        }
        .margin({ top: 200 })
      }
      .padding(30)
    }
    .width('100%')
    .height('100%')

  }
}
```

### 1.3.3. 封装用户信息管理工具

封装全局用户信息管理的工具，提供用户信息的管理功能

- 将当前用户类型定义

疑问：为什么使用class，因为后续使用AppStorageV2进行全局状态共享

```ts
commons/basic/src/main/ets/viewmodels/common.ets

export interface UserInfo {
  token: string
  avatar: string
  nickname: string
  account: string
}

// 全局用户类型
@ObservedV2
export class HDMUser implements UserInfo {
  @Trace
  token: string = ''
  @Trace
  avatar: string = ''
  @Trace
  nickname: string = ''
  @Trace
  account: string = ''

  constructor(model: UserInfo) {
    this.token = model.token
    this.avatar = model.avatar
    this.nickname = model.nickname
    this.account = model.account
  }
}

// 又嵌套了一层对象 针对user进行整体赋值就简单了！！！
@ObservedV2
export class AppUser {
  @Trace
  user: HDMUser = new HDMUser({} as UserInfo)
}
```

- 封装获取用户-删除用户-保存用户的工具-单例

```ts
commons/basic/src/main/ets/utils/Auth.ets

import { AppStorageV2 } from "@kit.ArkUI"
import { AppUser, HDMUser, UserInfo } from "../viewmodels"

export class Auth {
  setUser(user: HDMUser) {
    let appUser = AppStorageV2.connect(AppUser, () => new AppUser())!
    appUser.user = user
  }

  getUser() {
    const appUser = AppStorageV2.connect(AppUser, () => new AppUser())!
    return appUser.user
  }
}

export const auth = new Auth()
```

- 在utils/index.ets中导出

```ts
commons/basic/src/main/ets/utils/index.ets

export * from './Auth'
```



### 1.3.4. 用户登录

完成用户登录的前后端交互功能

**核心步骤：**

1. 参考文档封装 api
2. 页面中登录调用

1. 1. account：
   2. password: 
   3. 想简化编码的话，可以把这 2 个值直接进行绑定

1. 用户信息获取+保存

- 准备登录的参数类型

```ts
features/mine/src/main/ets/viewmodels/user.ets

export interface LoginForm {
  account: string
  password: string
}

@ObservedV2
export class LoginFormModel implements LoginForm {
  @Trace
  account: string = ''
  @Trace
  password: string = ''

  constructor(model: LoginForm) {
    this.account = model.account
    this.password = model.password
  }
}
```

- 类型需要在index.ets中导出

```arkts
features/mine/src/main/ets/viewmodels/index.ets

export * from './user'
```

- 封装API

```arkts
features/mine/src/main/ets/api/user.ets

import { HDMUser, RequestRcp } from "basic";
import { LoginFormModel } from "../viewmodels";

export const loginAPI = (data: LoginFormModel) =>
RequestRcp.post<HDMUser>("/login", data)
```

- 用户api导出

```typescript
features/mine/src/main/ets/api/index.ets

export * from './user'
```

- 实现登录和跳转

```arkts
features/mine/src/main/ets/views/LoginView.ets

async onSubmit() {
    if (!this.agree) {
      return promptAction.showToast({ message: '请先勾选协议' })
    }
    const user = await loginAPI(this.loginForm)
    auth.setUser(user) // 写入用户
    HMRouterMgr.pop() // 返回上一层
  }
```

- 用户信息渲染

```typescript
features/mine/src/main/ets/views/MineView.ets

import { AppSafeArea, AppUser, HDMGuessGoods, HDMNavCol, HDMUser, PAGE_PATH, UserInfo } from "basic"
import { AppStorageV2 } from "@kit.ArkUI"
import { HMRouterMgr } from "@hadss/hmrouter"


@ComponentV2
export struct MineView {
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  appUser: AppUser = AppStorageV2.connect(AppUser, () => new AppUser())!

  build() {
    Column() {
      Scroll() {
        Column() {
          // header
          Column() {
            Row() {
              Blank()
              if (true) {
                Image($r('[basic].media.ic_public_settings'))
                  .width(24)
                  .aspectRatio(1)
                  .onClick(() => {

                  })
              }


            }
            .width('100%')
            .height(50)

            Row({ space: 16 }) {
              // 头像
              Image(this.appUser.user.avatar || $r('app.media.ic_user_avatar'))
                .width(40)
                .aspectRatio(1)
                .borderRadius(20)
              if (this.appUser.user.token) {
                Text(this.appUser.user.nickname)
                  .fontColor($r('[basic].color.black'))
                  .fontWeight(500)
              } else {
                Text('立即登录')
                  .fontColor($r('[basic].color.black'))
                  .fontWeight(500)
                  .onClick(() => {
                    HMRouterMgr.push({
                      pageUrl: PAGE_PATH.LOGIN_PAGE
                    })
                  })
              }
            }
            .width('100%')
            .height(72)

            Row({ space: 8 }) {
              Image($r('app.media.ic_user_vip'))
                .width(24)
                .aspectRatio(1)
              Text('升级美蔻商城会员，尊享无限免邮')
                .fontSize(12)
                .fontColor('#7E2C1A')
                .layoutWeight(1)
              Button('立即开通')
                .width(64)
                .height(24)
                .fontSize(10)
                .padding(0)
                .backgroundColor('#7E2C1A')
            }
            .padding({ left: 8, right: 8 })
            .width('100%')
            .height(40)
            .borderRadius({ topLeft: 10, topRight: 10 })
            .linearGradient({
              angle: 110,
              colors: [['#F9D8AB', 0], ['#F9E3CC', 1]]
            })

          }
          .padding({ left: 16, right: 16, top: this.safeArea.topHeight })
          .linearGradient({
            angle: 180,
            colors: [['#FFF1E5', 0], [$r('[basic].color.under'), 1]]
          })

          // nav
          Column({ space: 8 }) {
            GridRow({ columns: 3 }) {
              GridCol() {
                HDMNavCol({ icon: $r('app.media.ic_user_collect'), text: '我的收藏', color: $r('[basic].color.text') })
              }

              GridCol() {
                HDMNavCol({ icon: $r('app.media.ic_user_history'), text: '我的足迹', color: $r('[basic].color.text') })
                  .onClick(() => {

                  })
              }

              GridCol() {
                HDMNavCol({ icon: $r('app.media.ic_user_service'), text: '我的客服', color: $r('[basic].color.text') })
              }
            }
            .width('100%')
            .linearGradient({
              angle: 180,
              colors: [['#FFF1E5', 0], [$r('[basic].color.white'), 0.15], [$r('[basic].color.white'), 1]]
            })
            .borderRadius(10)

            Column() {
              Text('我的订单')
                .fontSize(14)
                .width('100%')
                .padding({ left: 8, top: 8 })
                .lineHeight(22)
                .fontWeight(500)
                .fontColor($r('[basic].color.black'))
              GridRow({ columns: 5 }) {
                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_order'), text: '全部订单' })
                    .onClick(() => {
                      // TODO 订单页，无参数
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_obligation'), text: '待付款' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=1
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_unreceived'), text: '待发货' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=2
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_unshipped'), text: '待收货' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=3
                    })
                }

                GridCol() {
                  HDMNavCol({ icon: $r('app.media.ic_user_unevaluated'), text: '待评价' })
                    .onClick(() => {
                      // TODO 订单页，无参数 orderState=4
                    })
                }
              }
              .width('100%')
            }
            .backgroundColor($r('[basic].color.white'))
            .borderRadius(10)
          }
          .padding({ left: 8, right: 8 })

          // guess
          HDMGuessGoods()

        }
      }
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('[basic].color.under'))
  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743250927580-30582bf6-a2d4-49e8-a58e-33ae8b1fbe2c.png)

**git 记录**

My-用户登录

### 1.3.5. 用户持久化

V1的直接使用AppStorage

V2版本使用PersistenceV2， 直接替换原来的AppStorageV2



- 使用PersistenceV2进行持久化

不同于鸿蒙的V1状态，PersistenceV2和AppStorageV2是割裂开的，用法和AppStorageV2基本一致，只不过AppStorageV2是内存态数据，而PersistenceV2是直接存入磁盘的

使用： 只需要将AppStorageV2换成PersistenceV2即可。

```typescript
import { PersistenceV2 } from "@kit.ArkUI"
import { AppUser, HDMUser } from "../viewmodels"

export class Auth {
  setUser(user: HDMUser) {
    let appUser = PersistenceV2.connect(AppUser, () => new AppUser())!
    appUser.user = user
    // PersistenceV2.save("AppUser")
  }

  getUser() {
    const appUser = PersistenceV2.connect(AppUser, () => new AppUser())!
    return appUser.user
  }
}

export const auth = new Auth()
  appUser: AppUser = PersistenceV2.connect(AppUser, () => new AppUser())!
```



坑点-目前持久化，全局状态共享实现了-但?????

待解决！！！

- 解决持久化失效的问题

```typescript
commons/basic/src/main/ets/viewmodels/common.ets

import { Type } from "@kit.ArkUI";

// 全局用户类型
@ObservedV2
export class HDMUser implements UserInfo {
  @Trace
  token: string = ''
  @Trace
  avatar: string = ''
  @Trace
  nickname: string = ''
  @Trace
  account: string = ''
  // constructor(model: UserInfo) {
  //   this.token = model.token
  //   this.avatar = model.avatar
  //   this.nickname = model.nickname
  //   this.account = model.account
  // }
}

@ObservedV2
export class AppUser {
  @Type(HDMUser) // 当缓存的对象为复杂数据类型时 需要用@Type装饰器装饰这个类 保证不丢失
  @Trace
  user: HDMUser = new HDMUser()
}
```

Type装饰器用来配合PersistenceV2使用，当缓存的属性为复杂数据类型即对象时，需要用Type关键字修饰，Type需要引入，并且修饰的类不能有构造函数，所以需要去掉原来的构造函数！！！

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1742396991874-6c3dce2c-05a1-4fe4-b5f4-758420eda854.png)



**git 记录**

Mine模块-用户信息常驻



## 1.4. 我的客服-搭建DeepSeek的页面

```typescript
static readonly AI_CUSTOMER_PAGE: string = "AICustomerView" // 搜索结构页面
import { HDMNavBar, AppSafeArea, PAGE_PATH } from 'basic'
import { AppStorageV2 } from '@kit.ArkUI'
import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'

@Preview
@HMRouter({ pageUrl: PAGE_PATH.AI_CUSTOMER_PAGE })
@ComponentV2
export struct AICustomerView {
  @Local inputText: string = ''
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!

  build() {
    Stack() {
      Column() {
        HDMNavBar({
          title: 'DeepSeekAI客服',
          onLeftClick: () => {
            HMRouterMgr.pop()
          }
        })

        Column() {
          Image('https://www.deepseek.com/images/logo.svg')
            .width(100)
            .aspectRatio(1)
            .margin({ top: 32, bottom: 16 })
            .shadow({
              radius: 8,
              color: '#1A73E8',
              offsetY: 4
            })

          Text('DeepSeekAI智能客服')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 12 })
            .fontColor('#1A73E8')

          Text('您好，我是DeepseekAI智能客服助手，有什么可以帮助您的？')
            .fontSize(16)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 32 })
            .padding({ left: 24, right: 24 })
            .fontColor('#666666')

          // 客服对话区域
          Column() {
            // 模拟对话气泡
            Row() {
              Text('您好，我想咨询一下商品的退换货政策。')
                .fontSize(15)
                .backgroundColor('#1A73E8')
                .fontColor('#FFFFFF')
                .borderRadius(16)
                .padding({
                  left: 16,
                  right: 16,
                  top: 12,
                  bottom: 12
                })
                .margin({ right: 50 })
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
            .margin({ bottom: 20 })

            Row() {
              Image($r('app.media.ic_user_service'))
                .width(36)
                .height(36)
                .borderRadius(18)
                .margin({ right: 12 })
                .shadow({
                  radius: 4,
                  color: '#000000',
                  offsetY: 2,
                })

              Text('您好，根据我们的政策，商品在收到后7天内，如有质量问题可申请退换货。非质量问题的退换货需在收到商品后24小时内提出申请。具体可查看商品详情页的售后说明。')
                .fontSize(15)
                .backgroundColor('#F8F9FA')
                .borderRadius(16)
                .padding({
                  left: 16,
                  right: 16,
                  top: 12,
                  bottom: 12
                })
                .margin({ left: 10, right: 50 })
                .fontColor('#333333')
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 20 })
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
          .layoutWeight(1)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#FFFFFF')
      }
      .width('100%')
      .height('100%')

      // 底部输入框区域
      Column() {
        Divider()
          .color('#F5F5F5')
          .width('100%')
          .strokeWidth(0.5)
          .opacity(0.8)

        Row() {
          TextInput({ text: this.inputText, placeholder: '请输入您的问题...' })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#F8F9FA')
            .borderRadius(24)
            .padding({ left: 20, right: 20 })
            .fontSize(16)
            .fontColor('#333333')

          Button('发送')
            .height(48)
            .backgroundColor('#1A73E8')
            .borderRadius(24)
            .margin({ left: 8 })
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
        }
        .width('100%')
        .padding({
          left: 16,
          right: 16,
          top: 12,
          bottom: 12
        })
        .backgroundColor('#FFFFFF')
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .position({ y: '100%' })
      .translate({ y: -80 })
      .margin({ bottom: this.safeArea.bottomHeight })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743335838198-ba2575df-793b-4a19-9353-dc9704e5c89a.png)

- 搭建DeepRcp工具

  

```typescript
commons/basic/src/main/ets/utils/DeepSeekRcp.ets

// deepseek的数据和我们平时请求的数据有什么区别
import { rcp } from "@kit.RemoteCommunicationKit"

// 推理模型-一个字一个字在推-记录当前的文本属于哪个上下文
// 接口一口气把所有的结果都给用户

export class DeepSeekRcp {
  session: rcp.Session | null = null // rcp的请求实例对象

  initSession() {
    this.session = rcp.createSession({})
  }

  // 发送问题给deepSeek
  postDeepSeek(data: object) {
    if (!this.session) {
      this.initSession()
    }

  }
}

export const deepSeekRcp = new DeepSeekRcp()
```

- 在utils中导出

```typescript
commons/basic/src/main/ets/utils/index.ets

export * from './DeepSeekRcp' // 接入DeepSeek的请求工具
```

## 1.5. 设置界面

### 1.5.1. 搭建页面模板

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718062910397-0ce7c95a-ad94-41eb-a006-1186ace9cbe4.png)![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718062910397-0ce7c95a-ad94-41eb-a006-1186ace9cbe4.png)

- 建立设置模板

- 需要配置name的常量

```arkts
commons/basic/src/main/ets/constants/PagePath.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView" // 搜索页面
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView" // 搜索结构页面
  static readonly LOGIN_PAGE: string = "LoginView" // 搜索结构页面
  static readonly AI_CUSTOMER_PAGE: string = "AICustomerView" // 搜索结构页面
  static readonly SETTING_PAGE: string = "SettingView" // 设置页面
}
```

- 封装HDMCell和HDMCellGroup组件

```typescript
commons/basic/src/main/ets/components/HDMCellGroup.ets

@ComponentV2
export struct HDMCellGroup {
  @BuilderParam
  default: () => void = this.getDefaultBuilder

  @Builder
  getDefaultBuilder() {
  }

  build() {
    Column() {
      if (this.default) {
        this.default() // 调用传入的UI结构
      }
    }
    .alignItems(HorizontalAlign.Start)
    .width("100%")
    .border({
      width: { top: 0.6, bottom: 0.6 },
      color: $r('app.color.under')
    })
    .padding({ left: 16, right: 16 })
    .backgroundColor($r("app.color.white"))
  }
}

```

```
commons/basic/src/main/ets/components/HDMCell.ets

@ComponentV2
export struct HDMCell {
  @Param
  title: string = ""
  @Param
  icon: ResourceStr = $r("app.media.ic_public_right")
  @Param
  value: string = "" // 后侧的文本
  @Param
  showRightIcon: boolean = true // 是否显示右侧图标
  @Event
  onRightClick: () => void = () => {
  }
  @BuilderParam
  customLabel: () => void // 左侧标题的自定义结构
  @BuilderParam
  customIcon: () => void // 右侧标题的自定义结构

  build() {
    Row() {
      if (this.customLabel) {
        this.customLabel()
      } else {
        Text(this.title)
          .fontSize(16)
          .fontColor($r("app.color.black"))
      }

      Row() {
        Text(this.value)
          .fontColor($r("app.color.gray"))
          .fontSize(14)

        if (this.customIcon) {
          this.customIcon()
        } else {
          if (this.showRightIcon) {
            Image(this.icon)
              .fillColor($r("app.color.gray"))
              .width(30)
              .aspectRatio(1)
              .onClick(() => {
                this.onRightClick()
              })
          }
        }
      }
    }
    .width("100%")
    .constraintSize({
      minHeight: 50
    })
    .justifyContent(FlexAlign.SpaceBetween)
  }
}
```

**SettingsView基础模版**

```arkts
features/mine/src/main/ets/views/SettingView.ets

import { HMRouter } from '@hadss/hmrouter'
import { HDMUser, HDMNavBar, HDMCellGroup, HDMCell, PAGE_PATH, AppSafeArea, AppUser } from 'basic'
import { AppStorageV2, PersistenceV2 } from '@kit.ArkUI'


@HMRouter({ pageUrl: PAGE_PATH.SETTING_PAGE })
@ComponentV2
export struct SettingView {
  appUser: AppUser = PersistenceV2.connect(AppUser, () => new AppUser())!
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!

  @Builder
  getProfileBuilder() {
    RelativeContainer() {
      Image($r("[basic].media.ic_public_right"))
        .fillColor($r("[basic].color.gray"))
        .width(30)
        .aspectRatio(1)
        .alignRules({
          center: {
            anchor: '__container__',
            align: VerticalAlign.Center
          },
          right: {
            anchor: '__container__',
            align: HorizontalAlign.End
          }
        })
        .onClick(() => {

        })

      Image(this.appUser.user.avatar)
        .alt($r("app.media.ic_user_avatar"))
        .width(50)
        .aspectRatio(1)
        .borderRadius(25)
        .alignRules({
          center: {
            anchor: '__container__',
            align: VerticalAlign.Center
          }
        })
        .id("avatar")
      Column({ space: 4 }) {
        Text(this.appUser.user.nickname || this.appUser.user.account)
          .fontColor($r('[basic].color.black'))
          .fontWeight(500)
        Text('账号名：' + this.appUser.user.account)
          .fontColor($r('[basic].color.gray'))
          .fontSize(12)
      }

      .alignRules({
        center: {
          anchor: '__container__',
          align: VerticalAlign.Center
        },
        left: {
          anchor: 'avatar',
          align: HorizontalAlign.End
        }
      })
      .alignItems(HorizontalAlign.Start)
      .margin({
        left: 10
      })
    }
    .constraintSize({
      maxHeight: 100
    })
    .padding({ top: 16, bottom: 16 })
  }

  aboutToAppear(): void {
    // 下载混合开发压缩包的工具

  }

  build() {
    Column() {
      HDMNavBar({
        title: '设置',
        onLeftClick: () => {
          // 点击返回

        }
      })
      Column({ space: 8 }) {
        // 头像昵称 还有账号
        HDMCellGroup() {
          this.getProfileBuilder()
        }

        Blank() // 空格
        HDMCellGroup() {
          HDMCell({
            title: '收货地址管理', onRightClick: () => {

            }
          })

          HDMCell({ title: '账号安全' })
          HDMCell({ title: '消息设置' })
          HDMCell({ title: '隐私设置' })
          HDMCell({ title: '通用设置' })
        }

        Blank() // 空格

        HDMCellGroup() {
          HDMCell({ title: '退出登录' })
            .onClick(() => {
              // 弹出层

            })

        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('[basic].color.under'))
  }
}
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743386551588-ff3e3b2d-2cb3-4696-b883-f431baf5ed2b.png)

- 我的页面跳转到设置页面

```arkts
 features/my/src/main/ets/views/MyView.ets

 if (this.appUser.user.token) {
                Image($r('[basic].media.ic_public_settings'))
                  .width(24)
                  .aspectRatio(1)
                  .onClick(() => {
                    HMRouterMgr.push({
                      pageUrl: PAGE_PATH.SETTING_PAGE
                    })
                  })
              }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1742397435310-add6acf7-53e0-4c3b-96d6-7641c04a97a9.png)

**git 记录**

Mine-设置页面整合



### 1.5.2. 退出登录

退出登录是一个比较危险的操作,需要用户进行确认

[AlertDialog](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-methods-alert-dialog-box-V5)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718082409938-475f2646-8969-48ee-a60c-361dc5f9e7d0.png)

最朴素的退出退出登录

```typescript
HDMCell({ title: '退出登录' })
            .onClick(() => {
              // 弹出层
              AlertDialog.show({
                message: '确认退出吗',
                primaryButton: {
                  value: '取消',
                  action: () => {

                  }
                },
                secondaryButton: {
                  value: '确定',
                  action: () => {
                    auth.setUser({} as HDMUser)
                    HMRouterMgr.pop()
                  }
                }
              })

            })
```

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1732524962462-1aedf4e5-f735-40a3-ad63-3e0faec6f42c.png)

- [接入第三方的弹层](https://ohpm.openharmony.cn/#/cn/detail/@pura%2Fharmony-dialog)

- [接入第三方的弹层](https://ohpm.openharmony.cn/#/cn/detail/@pura%2Fharmony-dialog)

```bash
$ ohpm i @pura/harmony-dialog
```

- ability进行初始化

```typescript
import { DialogHelper } from '@pura/harmony-dialog'

 DialogHelper.setDefaultConfig((config) => {
    config.uiAbilityContext = this.context;
 })
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743388333975-49834759-b712-4ed2-b34b-fa5d10574eba.png)

- 使用弹出退出登录

```typescript
features/mine/src/main/ets/views/SettingView.ets

	DialogHelper.showAlertDialog({
                content: "确认退出登录吗？",
                onAction: (action) => {
                  if (action == DialogAction.CANCEL) {

                  } else if (action == DialogAction.SURE) {
                    auth.setUser({} as HDMUser)
                    HMRouterMgr.pop()
                  }
                }
              })
```



![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1742397515831-4ccb2205-3277-4bce-afde-448e1e7887c7.png)

**git**

Mine-退出登录



# 2. rcp注入token, 处理401

```
// rcp的拦截器需要单独去new一个实现了rcp.Interceptor类
// extends(继承) implements(必须实现且继承)
class RcpRequestInterceptor implements rcp.Interceptor {
  // context上下文 -请求上下文
  async intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    // to from next(必须要执行的函数)
    // next传递到下一个
    // throw new Error("Method not implemented.");
    // axios返回类型无法更改！！！
    // 请求拦截器
    if (typeof context.request.content === 'object') {
      context.request.content =
        JSON.parse(JSON.stringify(context.request.content).replace(/__ob_/g, "")) as rcp.RequestContent
    }
    
    //  注入token
    const user = auth.getUser()
    if (user.token) {
      context.request.headers!.authorization = `Bearer ${user.token}`
    }

    return next.handle(context) // 将结构返回下一个执行链

  }
}

class RcpResponseInterceptor implements rcp.Interceptor {
  // context上下文 -请求上下文
  async intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    // to from next(必须要执行的函数)
    // next传递到下一个
    // throw new Error("Method not implemented.");
    // axios返回类型无法更改！！！
    // 请求拦截器
    const res = await next.handle(context) // 将结构返回下一个执行链
    //  处理401异常问题
    if (res.statusCode === 401) {
      auth.setUser({} as HDMUser)
      HMRouterMgr.push({
        pageUrl: PAGE_PATH.LOGIN_PAGE
      })
    }
    return res
  }
}

```

