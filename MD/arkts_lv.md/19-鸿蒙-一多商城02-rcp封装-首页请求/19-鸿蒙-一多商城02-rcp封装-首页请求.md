# 2. 网络数据获取

- 原生http-原生封装-小时达
- axios-封装-面试通项目
- 原生rcp封装-本次项目
- rcp对于http请求的弥补-axios/http 不支持patch请求-极其复杂 不太规范
- [rcp官网指南](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/remote-communication-preparations)

检查网络权限

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743047388563-f9c582d2-04c0-4552-96c7-418e96594e17.png)

## 2.1. rcp的创建实例和拦截器

- 定义一个基本的请求架子

```typescript
commons/basic/src/main/ets/utils/RequestRcp.ets

import { rcp } from "@kit.RemoteCommunicationKit";
import { GlobalVariable } from "../constants";

class RcpInterceptor implements rcp.Interceptor {
  intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    return next.handle(context)
  }
}

const instance = rcp.createSession({
  baseAddress: GlobalVariable.BASE_URL, // 基础地址配置
  interceptors: [], // 多个拦截器 不区分请求和响应
  requestConfiguration: {
    transfer: {
      timeout: {
        connectMs: GlobalVariable.TIME_OUT, // 连接超时
        transferMs: GlobalVariable.TIME_OUT, // 传输超时
        inactivityMs: GlobalVariable.TIME_OUT, // 会话超时
      }
    }
  }
})


export class RequestRcp {
  static get<T>(url: string, params?: object) {
  }

  static post<T>(url: string, data?: object) {
  }

  static delete<T>(url: string, params?: object, data?: object) {
  }

  static put<T>(url: string, data?: object) {
  }

  static patch<T>(url: string, data?: object) {
  }

  static upload<T>() {
  }

  static download<T>() {

  }
}
```



- 在常量中管理一些变量

```arkts
commons/basic/src/main/ets/constants/GlobalVariable.ets

export class GlobalVariable {
  static readonly TIME_OUT: number = 60000 // 超时时间
  
  static readonly BASE_URL: string = "https://meikou-api.itheima.net" // 网络请求基础地址
  static readonly SUCCESS_CODE: string = "1" // 成功标识
}
```

- 在constants/index.ets中统一导出

```typescript
commons/basic/src/main/ets/constants/index.ets

export * from './GlobalVariable'
```

- 定义统一的返回结构体

```typescript
commons/basic/src/main/ets/viewmodels/common.ets

export interface ResponseData<T> {
  code: string
  message: string
  result: T
}
```

- 在viewmodels/index.ets中统一导出

```typescript
commons/basic/src/main/ets/viewmodels/index.ets

export * from './common'
```

- 封装RequestRcp

```ts
commons/basic/src/main/ets/utils/RequestRcp.ets

import { rcp } from "@kit.RemoteCommunicationKit";
import { ResponseData } from "../../../../Index";
import { GlobalVariable } from "../constants";
import { promptAction } from "@kit.ArkUI";

// rcp的拦截器需要单独去new一个实现了rcp.Interceptor类
// extends(继承) implements(必须实现且继承)
class RcpRequestInterceptor implements rcp.Interceptor {
  // context上下文 -请求上下文
  async intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    // to from next(必须要执行的函数)
    // next传递到下一个
    // throw new Error("Method not implemented.");
    // axios返回类型无法更改！！！
    // 请求拦截器
    // TODO 注入token
    return next.handle(context) // 将结构返回下一个执行链

  }
}

class RcpResponseInterceptor implements rcp.Interceptor {
  // context上下文 -请求上下文
  async intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    // to from next(必须要执行的函数)
    // next传递到下一个
    // throw new Error("Method not implemented.");
    // axios返回类型无法更改！！！
    // 请求拦截器
    const res = await next.handle(context) // 将结构返回下一个执行链
    // TODO 处理401异常问题
    // if(res.statusCode === 401) {
    //
    // }
    return res
  }
}

const instance = rcp.createSession({
  baseAddress: GlobalVariable.BASE_URL, // 基础地址配置
  interceptors: [new RcpRequestInterceptor(), new RcpResponseInterceptor()], // 多个拦截器 不区分请求和响应
  requestConfiguration: {
    transfer: {
      timeout: {
        connectMs: GlobalVariable.TIME_OUT, // 连接超时
        transferMs: GlobalVariable.TIME_OUT, // 传输超时
        inactivityMs: GlobalVariable.TIME_OUT, // 会话超时
      }
    }
  }
})


export class RequestRcp {
  static get<T>(url: string, params?: object): Promise<T> {
    // url?id=1&name=2 { id: 1, name: 2 }
    return RequestRcp.toRightData<T>(instance.get(url + "?" + RequestRcp.transJSONToParams(params)))
  }

  static post<T>(url: string, data?: object): Promise<T> {
    return RequestRcp.toRightData<T>(instance.post(url, data))
  }

  // delete 支持传body参数 删除购物车需要传递body参数
  static delete<T>(url: string, params?: object, data?: object): Promise<T> {
    const req = new rcp.Request(url + "?" + RequestRcp.transJSONToParams(params), "DELETE", {}, data)
    return RequestRcp.toRightData<T>(instance.fetch(req))
    // return RequestRcp.toRightData<T>(instance.delete(url + "?" + RequestRcp.transJSONToParams(params)))
  }

  static put<T>(url: string, data?: object): Promise<T> {
    return RequestRcp.toRightData<T>(instance.put(url, data))
  }

  static patch<T>(url: string, data?: object): Promise<T> {
    const req = new rcp.Request(url, "PATCH", {}, data)
    return RequestRcp.toRightData<T>(instance.fetch(req))
  }

  static upload<T>() {
  }

  static download<T>() {

  }

  // 将数据转化成正确的数据类型
  static async toRightData<T>(res: Promise<rcp.Response>) {
    const obj = await res
    const result = obj.toJSON() as ResponseData<T>
    if (result.code === GlobalVariable.SUCCESS_CODE) {
      return result.result
    }
    promptAction.showToast({ message: result.message })
    return Promise.reject(new Error(result.message))

  }

  // 转化json=> url地址参数的方法 { id: 1, name: 2 } => id=1&name=2
  static transJSONToParams(params?: object) {
    if (params) {
      return Object.keys(params).filter(key => !!params[key]).map(key => `${key}=${params[key]}`).join("&")
    }
    return ""
    // ["id","name"] => ["id=1", "name=2"]

  }
}
```

- 工具导出

```ts
commons/basic/src/main/ets/utils/index.ets

export * from './RequestRcp'
```

## 2.2. 首页数据获取

准备工作搞定啦，接下来结合接口获取数据并渲染到页面上

### 2.2.1. 轮播图及分类数据

来获取轮播图和分类数据

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717486917487-0c0e6d16-130f-47c4-a514-c779d21259b9.png)

**需求：**

1. 获取轮播图及分类数据，替换本地Mock 数据

**核心步骤：**

1. 封装业务请求
2. 获取并替换 mock数据即可

- 准备Home首页的嵌套类型

```ts
features/home/src/main/ets/viewmodels/home.ets

// 特惠推荐的接口
export interface HotResult {
  id: string;
  subTypes: SubType[];
  title: string;
}

export interface SubType {
  goodsItems: GoodsItems;
  id: string;
  title: string;
}

export interface GoodsItems {
  counts: number;
  items: HDMGoodsItem[];
  page: number;
  pages: number;
  pageSize: number;
}
```

- 在home模块下的viewmodels/index.ets中统一导出

```typescript
features/home/src/main/ets/viewmodels/index.ets

export * from './home'
```

- 封装获取首页六个频道的数据接口

```ts
features/home/src/main/ets/api/home.ets

import { CategoryItem, HDMGoodsItem, RequestRcp } from 'basic'
import { Banner, HotResult } from '../viewmodels'

// 获取轮播图
// 封装六个接口


export const getBannerAPI = () => {
  return RequestRcp.get<Banner[]>("/home/banner")
}

export const getCategoryAPI = () => {
  return RequestRcp.get<CategoryItem[]>("/home/category/head")
}

// 获取特惠推荐
export const getHotResultAPI = () => {
  return RequestRcp.get<HotResult>("/hot/preference")
}

// 爆款推荐
export const getInVogueAPI = () => {
  return RequestRcp.get<HotResult>("/hot/inVogue")
}

// 一站买全
export const getOneStopAPI = () => {
  return RequestRcp.get<HotResult>("/hot/oneStop")
}

// 获取新鲜好物
export const getHomeNewAPI = () => {
  return RequestRcp.get<HDMGoodsItem[]>("/home/new")
}
```

- 在home模块下的api/index.ets中统一导出

```typescript
features/home/src/main/ets/api/index.ets

export * from './home'
```

- 在首页HomeView组件中，初始化获取数据

```ts
features/home/src/main/ets/views/HomeView/HomeView.ets

 aboutToAppear(): void {
    // mock数据
    this.getHomeData()
  }

  async getHomeData() {
    this.banners = await getBannerAPI()
    this.categories = await getCategoryAPI()
    const result = await getHotResultAPI()
    this.saleGoods = result.subTypes?.[0]?.goodsItems?.items || []
    this.hotGoods = (await getInVogueAPI()).subTypes?.[0]?.goodsItems?.items || []
    this.oneGoods = (await getOneStopAPI()).subTypes?.[0]?.goodsItems?.items || []
    this.newGoods = await getHomeNewAPI()
  }
```





### 2.2.2. 优化数据获取

首屏数据基本获取完毕，用户体验不是很好呢

[Promise 使用](https://www.bilibili.com/video/BV1mH4y1Q7Z7/?spm_id_from=333.999.0.0&vd_source=01f374720bfabb6b6d33c9e1ffaf0a26)、[Promise 文档](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled)

**思考：**

1. 为什么首页的数据会按照，1，2，3，4，5 的顺序逐个替换？
2. 这样用户体验如何？
3. 是否可以获取到这些数据之后一次性替换？

1. 1. Promise.all，全部成功，或者第一个失败
   2. Promise.allSettled，全部的都出结果，哪怕结果是失败的

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717487529185-c4216fe2-612e-4102-a3f3-9bb02ac8d09d.png)



```ts
features/home/src/main/ets/views/HomeView.ets

aboutToAppear(): void {
    // mock数据
    this.getHomeData()

  }

   // 获取首页数据
  async getHomeData() {
    // this.banners = await getBannerAPI()
    // this.categories = await getCategoryAPI()
    // this.saleGoods = (await getHotResultAPI()).subTypes[0].goodsItems.items
    // this.hotGoods = (await getInVogueAPI()).subTypes[0].goodsItems.items
    // this.oneGoods = (await getOneStopAPI()).subTypes[0].goodsItems.items
    // this.newGoods = await getHomeNewAPI()
    // Promise.all 所有的全部执行成功才执行
    // Promise.allSettled- 所有的都走完-不论成功或者失败
    const result =
      await Promise.allSettled([getBannerAPI(), getCategoryAPI(), getHotResultAPI(), getInVogueAPI(), getOneStopAPI(),
        getHomeNewAPI()])
    if (result[0].status === "fulfilled") {
      this.banners = result[0].value
    }
    if (result[1].status === "fulfilled") {
      this.categories = result[1].value
    }
    if (result[2].status === "fulfilled") {
      this.saleGoods = result[2].value?.subTypes?.[0]?.goodsItems?.items || []
      //this.saleGoods = result[2].value
    }
    if (result[3].status === "fulfilled") {
      this.hotGoods = result[3].value?.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[4].status === "fulfilled") {
      this.oneGoods = result[4].value?.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[5].status === "fulfilled") {
      this.newGoods = result[5].value
    }
  }
```

 

### 2.2.3. 首页滚动吸顶

吸顶

- 当搜索组件呗滚动出去的时候，需要一个固定在顶部的组件一直显示搜索，方便用户使用

```ts
import { AppBreakPoint, AppSafeArea, BreakPointEnum, BreakPointType, CategoryItem, HDMGoodsItem } from 'basic'
import { HDMDiscountGoods, HDMGoods } from '../components'
import { Banner, Params, DiscountType } from '../viewmodels'
import { AppStorageV2, promptAction } from '@kit.ArkUI'
import { getBannerAPI, getCategoryAPI, getHomeNewAPI, getHotResultAPI, getInVogueAPI, getOneStopAPI } from '../api'


@ComponentV2
export struct HomeView {
  appSafe: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  breakObj: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  // 轮播图
  // 轮播图
  @Local
  banners: Banner[] = []
  // 分类
  @Local
  categories: CategoryItem[] = []
  // 特惠推荐
  @Local
  saleGoods: HDMGoodsItem[] = []
  // 爆款推荐
  @Local
  hotGoods: HDMGoodsItem[] = []
  // 一站买全
  @Local
  oneGoods: HDMGoodsItem[] = []
  // 新鲜好物
  @Local
  newGoods: HDMGoodsItem[] = []
  @Local
  recommendGoods: HDMGoodsItem[] = []
  @Local
  yOffset: number = 0
  @Local
  searchOpacity: number = 0 // 搜索框的透明度

  aboutToAppear(): void {
    this.getHomeData()
  }

  async getHomeData() {
    // this.banners = await getBannerAPI()
    // this.categories = await getCategoryAPI()
    // const result = await getHotResultAPI()
    // this.saleGoods = result.subTypes?.[0]?.goodsItems?.items || []
    // this.hotGoods = (await getInVogueAPI()).subTypes?.[0]?.goodsItems?.items || []
    // this.oneGoods = (await getOneStopAPI()).subTypes?.[0]?.goodsItems?.items || []
    // this.newGoods = await getHomeNewAPI()
    // Promise.all(所有的都成功)
    // Promise.allSettled(所有的都有结果)
    // pending fulfilled rejected
    const result =
      await Promise.allSettled([getBannerAPI(), getCategoryAPI(), getHotResultAPI(), getInVogueAPI(), getOneStopAPI(),
        getHomeNewAPI()])
    if (result[0].status === "fulfilled") {
      this.banners = result[0].value
    }
    if (result[1].status === "fulfilled") {
      this.categories = result[1].value
    }
    if (result[2].status === "fulfilled") {
      this.saleGoods = result[2].value?.subTypes?.[0]?.goodsItems?.items || []
      //this.saleGoods = result[2].value
    }
    if (result[3].status === "fulfilled") {
      this.hotGoods = result[3].value?.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[4].status === "fulfilled") {
      this.oneGoods = result[4].value?.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[5].status === "fulfilled") {
      this.newGoods = result[5].value
    }
  }

  @Builder
  DiscountBuilder(params: Params) {

    Column() {
      Row({ space: 10 }) {
        Text(params.title)
          .fontColor($r('[basic].color.black'))
          .fontSize(14)
        Text(params.subTitle)
          .fontColor($r('[basic].color.text'))
          .fontSize(11)
      }
      .width('100%')
      .margin({ bottom: 10 })

      List({ space: 10 }) {
        ForEach(params.list, (item: HDMGoodsItem) => {
          ListItem() {
            HDMDiscountGoods({ type: DiscountType.DISCOUNT, goods: item })
          }
        })
      }
      .width('100%')
      .height(116)
      .scrollBar(BarState.Off)
      .listDirection(Axis.Horizontal)
    }
    .height(160)
    .layoutWeight(1)
    .padding(10)
    .backgroundColor(params.bg)
    .borderRadius(8)
  }

  build() {
    RelativeContainer() {
      Scroll() {
        Column() {
          // 轮播图 + 搜索
          Stack({ alignContent: Alignment.Top }) {
            Swiper() {
              ForEach(this.banners, (item: Banner) => {
                Image(item.imgUrl)
              })
            }
            .displayCount(new BreakPointType({
              sm: 1,
              md: 2,
              lg: 3
            }).getValue(this.breakObj.breakPoint))
            .itemSpace(new BreakPointType({
              sm: 0,
              md: 10,
              lg: 20
            }).getValue(this.breakObj.breakPoint))
            .indicator(
              this.breakObj.breakPoint === BreakPointEnum.SM ?
              DotIndicator.dot()
                .itemWidth(8)
                .itemHeight(4)
                .color('#33191919')
                .selectedItemWidth(24)
                .selectedItemHeight(4)
                .selectedColor('#191919') : false
            )

            Row() {
              Row({ space: 4 }) {
                Image($r('[basic].media.ic_public_search'))
                  .width(16)
                  .height(16)
                  .fillColor($r('[basic].color.white'))
                Text('搜索...')
                  .fontSize(14)
                  .fontColor($r('[basic].color.white'))
              }
              .backgroundColor('#33191919')
              .width('100%')
              .height(40)
              .borderRadius(20)
              .padding({ left: 12 })
            }
            .padding({ left: 16, right: 16, top: this.appSafe.topHeight })
          }
          .width('100%')


          // 分类
          Column({ space: 10 }) {
            // 分类
            List({
              space: new BreakPointType({
                sm: 14,
                md: 36,
                lg: 72
              }).getValue(this.breakObj.breakPoint)
            }) {
              ForEach(this.categories, (item: CategoryItem) => {
                ListItem() {
                  Column() {
                    Image(item.picture)
                      .width(56)
                      .aspectRatio(1)
                    Text(item.name)
                      .fontSize(10)
                      .fontColor('#CC191919')
                  }
                  .width(60)
                  .height(80)
                  .borderRadius(30)

                  .clip(true)
                  .backgroundImage(item.picture)
                  .backgroundImageSize(ImageSize.Contain)
                  .backgroundImagePosition(Alignment.Center)
                  .backgroundBlurStyle(
                    BlurStyle.BACKGROUND_ULTRA_THICK,
                    { scale: 0.25 }
                  )
                }
              })
            }
            .width('100%')
            .height(92)
            .scrollBar(BarState.Off)
            .listDirection(Axis.Horizontal)
            .alignListItem(ListItemAlign.Center)

            // 特惠推荐
            Column({ space: 10 }) {
              Image($r('app.media.home_cmd_title'))
                .width(150)
                .height(20)
              Row() {
                Image($r('app.media.home_cmd_inner'))
                  .width(86)
                  .height(116)
                List({ space: 10 }) {
                  ForEach(this.saleGoods, (item: HDMGoodsItem) => {
                    ListItem() {
                      HDMDiscountGoods({ goods: item })
                    }
                  })
                }
                .layoutWeight(1)
                .width('100%')
                .height(116)
                .backgroundColor($r('[basic].color.white'))
                .borderRadius({
                  topRight: 8,
                  bottomRight: 8
                })
                .padding({ right: 10, left: 10 })
                .scrollBar(BarState.Off)
                .listDirection(Axis.Horizontal)
              }
            }
            .width('100%')
            .height(166)
            .backgroundImage($r('app.media.home_cmd_sm'))
            .backgroundImageSize(ImageSize.Cover)
            .borderRadius(8)
            .padding(10)
            .alignItems(HorizontalAlign.Start)

            // 爆款推荐+一站买全
            Row({ space: 10 }) {
              this.DiscountBuilder({
                title: '爆款推荐',
                subTitle: '最受欢迎',
                bg: '#EDF1FB',
                list: this.hotGoods
              })
              this.DiscountBuilder({
                title: '一站买全',
                subTitle: '精心优选',
                bg: '#FCF6EA',
                list: this.oneGoods
              })
            }

            // 新鲜好物
            Column({ space: 10 }) {
              Image($r('app.media.home_new'))
                .width(146)
                .height(19)
              List({
                space: new BreakPointType({
                  sm: 14,
                  md: 36,
                  lg: 72
                }).getValue(this.breakObj.breakPoint)
              }) {
                ForEach(this.newGoods, (item: HDMGoodsItem) => {
                  ListItem() {
                    HDMDiscountGoods({ type: DiscountType.NEW, goods: item })
                  }
                })
              }
              .width('100%')
              .height(116)
              .scrollBar(BarState.Off)
              .listDirection(Axis.Horizontal)
            }
            .width('100%')
            .height(156)
            .padding(10)
            .backgroundColor('#F7EFF5')
            .borderRadius(8)
            .alignItems(HorizontalAlign.Start)

            // 推荐商品
            WaterFlow() {
              ForEach(this.recommendGoods, (item: HDMGoodsItem) => {
                FlowItem() {
                  HDMGoods({ goods: item })
                }
              })
            }
            .columnsTemplate(new BreakPointType({
              sm: "1fr 1fr",
              md: "1fr 1fr 1fr",
              lg: "1fr 1fr 1fr 1fr"
            }).getValue(this.breakObj.breakPoint))
            .columnsGap(8)
            .rowsGap(10)

          }
          .padding({
            left: 8,
            right: 8,
            bottom: 10,
            top: 10
          })
        }
      }
      .scrollBar(BarState.Off)
      .onDidScroll((xOffset: number, yOffset: number) => {
        this.yOffset += yOffset // 计算总共往上移动的距离
        if (this.yOffset < this.appSafe.topHeight) {
          this.searchOpacity = 0
          // 40搜索框的高度
        } else if (this.yOffset > this.appSafe.topHeight && this.yOffset < (this.appSafe.topHeight + 40)) {
          this.searchOpacity = (this.yOffset - this.appSafe.topHeight) / 40
        } else {
          this.searchOpacity = 1
        }

      })

      // 放置一个搜索元素
      Row() {
        Row({ space: 4 }) {
          Image($r('[basic].media.ic_public_search'))
            .width(16)
            .height(16)
            .fillColor($r('[basic].color.white'))
          Text('搜索...')
            .fontSize(14)
            .fontColor($r('[basic].color.white'))
        }
        .backgroundColor('#33999797')
        .width('100%')
        .height(40)
        .borderRadius(20)
        .padding({ left: 12 })
      }
      .opacity(this.searchOpacity)
      .padding({
        left: 16,
        right: 16,
        top: this.appSafe.topHeight,
        bottom: this.appSafe.topHeight,
      })
      .linearGradient({
        direction: GradientDirection.Bottom,
        colors: [["#ff949dec", 0], ["#fff", 1]]
      })

    }

  }
}
```

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1730712325856-60896786-df2c-4d0e-b939-3701386f0af1.png)



### 2.2.4. 推荐列表数据

- 无限滚动

首页底部的推荐列表数据

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717489013055-77b0bbf9-fecd-4ca9-b7f7-3730db221ff5.png)

**需求：**

 **1-初始数据获取：**

1. 抽取请求：确认接口的调用方式

1. 1. limit：给多少，就返回多少，没有分页
   2. 默认要 8 条
   3. 触底之后要 16 条，直接赋值给状态变量
   4. 触底之后要 24 条，
   5. 。。每次触底 +8
   6. 弄一个参数，比如页码，

1. 1. 1. 默认page:1 1*8=8
      2. 触底 page:2 2*8=16

1. 获取数据

**2-触底加载更多：**

#### 2.2.4.1. **初始数据获取**

- 声明一个参数的类型

```ts
features/home/src/main/ets/viewmodels/home.ets

// 推荐列表的请求的参数的类型
export interface RecommendParams {
  limit: number
}
```

- 封装请求api

```ts
features/home/src/main/ets/api/home.ets

// 获取推荐数据
export const getRecommendAPI = (params: RecommendParams) => {
  return RequestRcp.get<HDMGoodsItem[]>("/home/recommend", params)
}
```

- 需要定义对应的变量

```ts
  features/home/src/main/ets/views/HomeView/HomeView.ets

  @Local
  page: number = 1 // 请求的页码
  @Local
  isReachLoad: boolean = false // 是否已经请求完成
  @Local
  isFinished: boolean = false // 是否已经没有数据了
  // 推荐商品
  @Local
  recommendGoods: HDMGoodsItem[] = []
```

- 在首页中获取数据

```ts
 features/home/src/main/ets/views/HomeView.ets

  async getRecommend() {
    this.recommendGoods = await getRecommendAPI({ limit: 8 * this.page })
    if (this.recommendGoods.length === this.page * 8) {
      this.page++
    } else {
      this.isFinished = true
      promptAction.showToast({ message: '没有下一页了' })
    }
    // 我要50条数据 你给50条 认为你还有  我要50条 你给49条，我认为你没了
  }
```



- 监听Scroll的滚动到底部事件

```ts
features/home/src/main/ets/views/HomeView.ets


.onReachEnd(async () => {
  // 获取数据
  if (!this.isReachLoad && !this.isFinished) {
    this.isReachLoad = true // 上车把门焊死
    await this.getRecommend()
    this.isReachLoad = false // 把门打开
  }
})
```





### 2.2.5. LazyForEach 整合

[LazyForEach](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-lazyforeach)

- 声明一个实现了IDataSource的class

```ts
commons/basic/src/main/ets/utils/ListDataSource.ets

export class ListDataSource<T> implements IDataSource {
  private originArr: T[] = []
  private listeners: DataChangeListener[] = []

  totalCount(): number {
    return this.originArr.length
  }

  getData(index: number): T {
    return this.originArr[index]
  }

  registerDataChangeListener(listener: DataChangeListener): void {
    if (this.listeners.indexOf(listener) === -1) {
      this.listeners.push(listener)
    }
  }

  unregisterDataChangeListener(listener: DataChangeListener): void {
    const index = this.listeners.indexOf(listener)
    if (index > -1) {
      this.listeners.splice(index, 1)
    }
  }

  loadData(data: T[]) {
    this.originArr = data
    this.listeners.forEach((listener) => {
      listener.onDataReloaded()
    })
  }
}
```

- 在HomeView中声明DataSource，并且替换ForEach为LazyForEach

  ```
  features/home/src/main/ets/views/HomeView.ets
   
  dataSource: ListDataSource<HDMGoodsItem> = new ListDataSource()
  ```

  

```ts
features/home/src/main/ets/views/HomeView.ets

async getRecommend() {
    const list = await getRecommendAPI({ limit: 8 * this.page })
    // this.dataSource
    if (list.length === this.page * 8) {
      this.page++
    } else {
      this.isFinished = true
      promptAction.showToast({ message: '没有下一页了' })
    }
    // 我要50条数据 你给50条 认为你还有  我要50条 你给49条，我认为你没了
    this.dataSource.loadData(list) // 重新赋值
  }
```

- 页面使用LazyForEach

```ts
features/home/src/main/ets/views/HomeView.ets

WaterFlow() {
                LazyForEach(this.recommendDataSource, (item: HDMGoodsItem) => {
                  FlowItem() {
                    HDMGoods({ goods: item })
                  }
                })
              }
```

### 2.2.6. 使用Repeat替代LazyForEach

LazyForEach-支持V1和V2

V2-Repeat-组件实现懒加载和非懒加载

- Repeat的实现模式并非创建销毁，而是将不用的组件缓存起来，从节点树移除但不删除

[Repeat](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-new-rendering-control-repeat#cachedcount空闲节点缓存列表大小)

```typescript
features/home/src/main/ets/views/HomeView.ets

WaterFlow() {
              // LazyForEach(this.dataSource, (item: HDMGoodsItem) => {
              //   FlowItem() {
              //     HDMGoods({ goods: item })
              //   }
              // })
              Repeat<HDMGoodsItem>(this.recommendGoods).each((obj: RepeatItem<HDMGoodsItem>) => {
                FlowItem() {
                  HDMGoods({ goods: obj.item })
                }
              }).virtualScroll()
                .key((item, index) => `${index}_${JSON.stringify(item)}`)

            }
```

换掉原来的更新

```typescript
features/home/src/main/ets/views/HomeView.ets

async getRecommend() {
    const list = await getRecommendAPI({ limit: 8 * this.page })
    // this.dataSource
    if (list.length === this.page * 8) {
      this.page++
    } else {
      this.isFinished = true
      promptAction.showToast({ message: '没有下一页了' })
    }
    // 我要50条数据 你给50条 认为你还有  我要50条 你给49条，我认为你没了
    this.recommendGoods = list
    // this.dataSource.loadData(list) // 重新赋值
  }
```

### 2.2.7. Loading效果

数据的获取增加 loading 效果

#### 2.2.7.1. 抽取 Loading 组件

**需求：**

1. 数据获取增加 loading 效果
2. 多个页面都可能会用到这个效果

**思考：**

1. 多个图片做动画用什么组件？
2. 这个组件放在哪里？

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717489536901-50646b12-ea58-4f09-be15-6c3dab232ad9.png)

**核心步骤：**

1. 实现组件
2. 导出并使用

创建组件

```ts
commons/basic/src/main/ets/components/HDMLoading.ets

@ComponentV2
export struct HDMLoading {
  @Param
  imgWidth: number = 80

  build() {
    Stack({ alignContent: Alignment.Center }) {
      ImageAnimator()
        .images([
          {
            src: $r("app.media.loading_01")
          },
          {
            src: $r("app.media.loading_02")
          },
          {
            src: $r("app.media.loading_03")
          },
          {
            src: $r("app.media.loading_04")
          }
        ])
        .state(AnimationStatus.Running)
        .iterations(-1)// 无限运行动画
        .width(this.imgWidth)
        .aspectRatio(3)
    }
    .width("100%")
    .height("100%")
  }
}
```

- 在basic/components/index.ets中使用

```ts
commons/basic/src/main/ets/components/index.ets

export * from './HDMLoading'
```

- 在HomeView中使用loading状态

  ```
    @Local
    loading: boolean = false // 是否正在加载
  ```

  

```ts
async getHomeData() {
    this.loading = true // 打开进度
    // this.banners = await getBannerAPI()
    // this.categories = await getCategoryAPI()
    // const result = await getHotResultAPI()
    // this.saleGoods = result.subTypes?.[0]?.goodsItems?.items || []
    // this.hotGoods = (await getInVogueAPI()).subTypes?.[0]?.goodsItems?.items || []
    // this.oneGoods = (await getOneStopAPI()).subTypes?.[0]?.goodsItems?.items || []
    // this.newGoods = await getHomeNewAPI()
    // Promise.all 所有都得成功 它才成功
    // Promise.allSettled() // 所有人都有结果 他就成功
    const result =
      await Promise.allSettled([getBannerAPI(), getCategoryAPI(), getHotResultAPI(), getInVogueAPI(), getOneStopAPI(),
        getHomeNewAPI()])
    if (result[0].status === "fulfilled") {
      this.banners = result[0].value
    }
    if (result[1].status === "fulfilled") {
      this.categories = result[1].value
    }
    if (result[2].status === "fulfilled") {
      this.saleGoods = result[2].value.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[3].status === "fulfilled") {
      this.hotGoods = result[3].value.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[4].status === "fulfilled") {
      this.oneGoods = result[4].value.subTypes?.[0]?.goodsItems?.items || []
    }
    if (result[5].status === "fulfilled") {
      this.newGoods = result[5].value
    }
    this.loading = false // 关闭进度
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/38706227/1747189131864-d7f01d28-c603-4f4b-b726-33cd569866c1.png)



### 2.2.8. 下拉刷新

首页还剩一个下拉刷新效果

[refresh组件](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-container-refresh-V5)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717491742918-713ff429-469b-43fa-bb15-fbff3d0caac6.png)



使用Refresh的组件包裹整个组件

- 定义对应的变量

```ts
  @Local
  isRefreshing: boolean = false // 是否正在刷新
```

- 实现下拉刷新逻辑

```typescript
features/home/src/main/ets/views/HomeView.ets

Refresh({ refreshing: $$this.isRefreshing, builder: this.getRefreshBuilder }) {
          Scroll() {
            Column() {
              // 轮播图 + 搜索
              Stack({ alignContent: Alignment.Top }) {
                Swiper() {
                  ForEach(this.banners, (item: Banner) => {
                    Image(item.imgUrl)
                  })
                }
                .displayCount(new BreakPointType({
                  sm: 1,
                  md: 2,
                  lg: 3
                }).getValue(this.breakObj.breakPoint))
                .itemSpace(new BreakPointType({
                  sm: 0,
                  md: 10,
                  lg: 20
                }).getValue(this.breakObj.breakPoint))
                .indicator(
                  this.breakObj.breakPoint === BreakPointEnum.SM ?
                  DotIndicator.dot()
                    .itemWidth(8)
                    .itemHeight(4)
                    .color('#33191919')
                    .selectedItemWidth(24)
                    .selectedItemHeight(4)
                    .selectedColor('#191919') : false
                )

                Row() {
                  Row({ space: 4 }) {
                    Image($r('[basic].media.ic_public_search'))
                      .width(16)
                      .height(16)
                      .fillColor($r('[basic].color.white'))
                    Text('搜索...')
                      .fontSize(14)
                      .fontColor($r('[basic].color.white'))
                  }
                  .backgroundColor('#33191919')
                  .width('100%')
                  .height(40)
                  .borderRadius(20)
                  .padding({ left: 12 })
                }
                .padding({ left: 16, right: 16, top: this.appSafe.topHeight })
              }
              .width('100%')


              // 分类
              Column({ space: 10 }) {
                // 分类
                List({
                  space: new BreakPointType({
                    sm: 14,
                    md: 36,
                    lg: 72
                  }).getValue(this.breakObj.breakPoint)
                }) {
                  ForEach(this.categories, (item: CategoryItem) => {
                    ListItem() {
                      Column() {
                        Image(item.picture)
                          .width(56)
                          .aspectRatio(1)
                        Text(item.name)
                          .fontSize(10)
                          .fontColor('#CC191919')
                      }
                      .width(60)
                      .height(80)
                      .borderRadius(30)

                      .clip(true)
                      .backgroundImage(item.picture)
                      .backgroundImageSize(ImageSize.Contain)
                      .backgroundImagePosition(Alignment.Center)
                      .backgroundBlurStyle(
                        BlurStyle.BACKGROUND_ULTRA_THICK,
                        { scale: 0.25 }
                      )
                    }
                  })
                }
                .width('100%')
                .height(92)
                .scrollBar(BarState.Off)
                .listDirection(Axis.Horizontal)
                .alignListItem(ListItemAlign.Center)

                // 特惠推荐
                Column({ space: 10 }) {
                  Image($r('app.media.home_cmd_title'))
                    .width(150)
                    .height(20)
                  Row() {
                    Image($r('app.media.home_cmd_inner'))
                      .width(86)
                      .height(116)
                    List({ space: 10 }) {
                      ForEach(this.saleGoods, (item: HDMGoodsItem) => {
                        ListItem() {
                          HDMDiscountGoods({ goods: item })
                        }
                      })
                    }
                    .layoutWeight(1)
                    .width('100%')
                    .height(116)
                    .backgroundColor($r('[basic].color.white'))
                    .borderRadius({
                      topRight: 8,
                      bottomRight: 8
                    })
                    .padding({ right: 10, left: 10 })
                    .scrollBar(BarState.Off)
                    .listDirection(Axis.Horizontal)
                  }
                }
                .width('100%')
                .height(166)
                .backgroundImage($r('app.media.home_cmd_sm'))
                .backgroundImageSize(ImageSize.Cover)
                .borderRadius(8)
                .padding(10)
                .alignItems(HorizontalAlign.Start)

                // 爆款推荐+一站买全
                Row({ space: 10 }) {
                  this.DiscountBuilder({
                    title: '爆款推荐',
                    subTitle: '最受欢迎',
                    bg: '#EDF1FB',
                    list: this.hotGoods
                  })
                  this.DiscountBuilder({
                    title: '一站买全',
                    subTitle: '精心优选',
                    bg: '#FCF6EA',
                    list: this.oneGoods
                  })
                }

                // 新鲜好物
                Column({ space: 10 }) {
                  Image($r('app.media.home_new'))
                    .width(146)
                    .height(19)
                  List({
                    space: new BreakPointType({
                      sm: 14,
                      md: 36,
                      lg: 72
                    }).getValue(this.breakObj.breakPoint)
                  }) {
                    ForEach(this.newGoods, (item: HDMGoodsItem) => {
                      ListItem() {
                        HDMDiscountGoods({ type: DiscountType.NEW, goods: item })
                      }
                    })
                  }
                  .width('100%')
                  .height(116)
                  .scrollBar(BarState.Off)
                  .listDirection(Axis.Horizontal)
                }
                .width('100%')
                .height(156)
                .padding(10)
                .backgroundColor('#F7EFF5')
                .borderRadius(8)
                .alignItems(HorizontalAlign.Start)

                // 推荐商品
                WaterFlow() {
                  // LazyForEach(this.dataSource, (item: HDMGoodsItem) => {
                  //   FlowItem() {
                  //     HDMGoods({ goods: item })
                  //   }
                  // })
                  Repeat<HDMGoodsItem>(this.recommendGoods).each((obj: RepeatItem<HDMGoodsItem>) => {
                    FlowItem() {
                      HDMGoods({ goods: obj.item })
                    }
                  }).virtualScroll()
                    .key((item, index) => `${index}_${JSON.stringify(item)}`)

                }
                .cachedCount(1)
                .columnsTemplate(new BreakPointType({
                  sm: "1fr 1fr",
                  md: "1fr 1fr 1fr",
                  lg: "1fr 1fr 1fr 1fr"
                }).getValue(this.breakObj.breakPoint))
                .columnsGap(8)
                .rowsGap(10)

              }
              .padding({
                left: 8,
                right: 8,
                bottom: 10,
                top: 10
              })
            }
          }
          .scrollBar(BarState.Off)
          .onDidScroll((xOffset: number, yOffset: number) => {
            this.yOffset += yOffset // 计算总共往上移动的距离
            if (this.yOffset < this.appSafe.topHeight) {
              this.searchOpacity = 0
              // 40搜索框的高度
            } else if (this.yOffset > this.appSafe.topHeight && this.yOffset < (this.appSafe.topHeight + 40)) {
              this.searchOpacity = (this.yOffset - this.appSafe.topHeight) / 40
            } else {
              this.searchOpacity = 1
            }

          })
          .onReachEnd(async () => {
            // 当前没有请求 并且还有数据的情况下
            if (!this.isReachLoad && !this.isFinished) {
              this.isReachLoad = true // 先关门
              await this.getRecommend() // 获取数据
              this.isReachLoad = false // 开门
            }
          })

          // 放置一个搜索元素

        }
        .onStateChange(async (state) => {
          this.refreshStatus = state
          if (this.refreshStatus === RefreshStatus.Refresh) {
            // 此时完成下拉刷新
            await this.onRefresh()
            this.isRefreshing = false
            promptAction.showToast({ message: '刷新成功' })
          }
        })
```

- 实现下拉刷新方法

```typescript
 features/home/src/main/ets/views/HomeView.ets

// 下拉刷新的方法
  async onRefresh() {
    this.page = 1
    await this.getHomeData(false)
    await this.getRecommend()
    this.isRefreshing = false // 回归到开始阶段
  }
```

- 首屏加载之后不再显示全屏loading

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743077046107-4175dd00-2625-46d6-9f21-449b362d3b63.png)

- 定制下拉刷新的动画效果
