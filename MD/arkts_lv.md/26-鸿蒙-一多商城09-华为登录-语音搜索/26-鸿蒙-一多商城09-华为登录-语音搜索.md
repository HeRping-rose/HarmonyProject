# åä¸€ã€åä¸ºç™»å½•

# 1. åä¸ºç™»å½•

 

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718320142504-e11cc760-af33-4cbc-ad7e-21f267760cee.png?x-oss-process=image%2Fformat%2Cwebp)

é™¤äº†å¸¸è§„çš„è´¦å·å¯†ç ç™»å½•ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ©åä¸ºè´¦å·å®ç°ä¸‰æ–¹ç™»å½•ï¼ŒAccount Kitï¼ˆåä¸ºå¸å·æœåŠ¡ï¼‰æä¾›ç®€å•ã€å¿«é€Ÿã€å®‰å…¨çš„ç™»å½•å’ŒæˆæƒåŠŸèƒ½ï¼Œè®©ç”¨æˆ·æ— éœ€è¾“å…¥å¸å·ã€å¯†ç å’Œç¹çéªŒè¯ï¼Œé¿å…å› å¿˜è®°å¯†ç è€Œå¸¦æ¥çš„éº»çƒ¦ï¼Œä¸ºæ‚¨åˆ›å»ºå¸å·å¹¶ç™»å½•æ‰€æœ‰HarmonyOSåº”ç”¨ï¼Œå¸¦æ¥æ›´é«˜çš„æ³¨å†Œè½¬åŒ–ï¼ŒåŒæ—¶é€šè¿‡æˆæƒè·å¾—ç”¨æˆ·å¤´åƒæ˜µç§°ã€æ‰‹æœºå·ç ç­‰ä¿¡æ¯ï¼Œæå‡ç”¨æˆ·é»æ€§ã€‚

## 1.1. å¼€å‘å‡†å¤‡

å½“åº”ç”¨éœ€è¦ä½¿ç”¨ä»¥ä¸‹å¼€æ”¾èƒ½åŠ›çš„ä¸€ç§æˆ–å¤šç§æ—¶ï¼Œä¸ºæ­£å¸¸è°ƒè¯•è¿è¡Œåº”ç”¨ï¼Œéœ€è¦é¢„å…ˆ**æ·»åŠ å…¬é’¥æŒ‡çº¹**

- **Account Kitï¼ˆåä¸ºå¸å·æœåŠ¡ï¼‰**
- Call Kitï¼ˆé€šè¯æœåŠ¡ï¼‰
- Game Service Kitï¼ˆæ¸¸æˆæœåŠ¡ï¼‰
- Health Service Kitï¼ˆè¿åŠ¨å¥åº·æœåŠ¡ï¼‰
- IAP Kitï¼ˆåº”ç”¨å†…æ”¯ä»˜æœåŠ¡ï¼‰
- Live View Kitï¼ˆå®å†µçª—æœåŠ¡ï¼Œå½“éœ€è¦ä½¿ç”¨Push Kitæ—¶å¿…é¡»æ‰§è¡Œæ­¤æ­¥éª¤ï¼‰
- **Map Kitï¼ˆåœ°å›¾æœåŠ¡ï¼‰**
- Payment Kitï¼ˆåä¸ºæ”¯ä»˜æœåŠ¡ï¼‰
- **Push Kitï¼ˆæ¨é€æœåŠ¡ï¼‰**
- Scan Kitï¼ˆç»Ÿä¸€æ‰«ç æœåŠ¡ï¼‰

### 1.1.1. é…ç½®åº”ç”¨ç­¾åè¯ä¹¦

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718320177051-5ad4dc4b-e98d-434b-b7b7-0f4928d8e3f6.png)

### 1.1.2. åœ¨DevEco Studioå·¥å…·ä¾§ç”Ÿæˆå¯†é’¥ï¼ˆ.p12ï¼‰å’Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼ˆ.csrï¼‰

åœ¨ä¸»èœå•æ å•å‡»Buildï¼ˆæ„å»ºï¼‰-> Generate Key and CSRï¼ˆç”Ÿæˆç§é’¥å’Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼‰

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713941303455-ac24fc42-714f-46af-8209-29a811e1b123.png)

é€‰æ‹©è¦ç”Ÿæˆçš„æ–‡ä»¶ç›®æ ‡ä½ç½®å¹¶è®¾ç½®å¯†ç ï¼Œå¡«`Aliasåˆ«å`ä»¥åŠ`First and last name`ä¹‹åï¼Œç‚¹å‡»NextæŒ‰é’®

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713941617706-db44e1ba-243d-4f13-85ff-da2a8242673f.png)

å‡ºç°ä¸‹é¢çš„å¼¹æ¡†ä¹‹åï¼Œå¡«å†™`CSR file`æ–‡ä»¶ç›®æ ‡ä½ç½®ä¹‹åï¼Œç‚¹å‡»FinishæŒ‰é’®å®ŒæˆCSRæ–‡ä»¶åˆ›å»º

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713941737396-f94fcf08-be27-44ab-90ab-dacbba5408b4.png)

æ£€æŸ¥æœ¬åœ°ç›®å½•ä¸­ï¼Œæ˜¯å¦æˆåŠŸç”Ÿæˆ`.csr` å’Œ `.p12` æ–‡ä»¶

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713941820291-f92203c4-3ae0-4312-b98b-f6c118459bf4.png)

### 1.1.3. ç”³è¯·è°ƒè¯•è¯ä¹¦

åœ¨AGCå¹³å°ç‚¹å‡»`ç”¨æˆ·ä¸è®¿é—®`, å·¦ä¾§ç‚¹å‡»`è¯ä¹¦ç®¡ç†`ï¼Œå†ç‚¹å‡»è¿˜å³ä¾§æ–°å¢è¯ä¹¦

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713950947849-2e64653f-bb8f-4d49-a11b-1172d47dc156.png)

åœ¨å¼¹æ¡†ä¸­å¡«å†™è¯ä¹¦åç§°ã€é€‰æ‹©è¯ä¹¦ç±»å‹ä¸º`è°ƒè¯•è¯ä¹¦`ï¼Œé€‰å–æˆ‘ä»¬åœ¨ç¬¬ä¸€æ­¥ç”Ÿæˆçš„`Â·csr`æ–‡ä»¶ï¼Œæœ€åç‚¹å‡»æäº¤

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713951826129-a8fbfee5-2107-4da4-927a-ba8fb3b0004e.png)

ä¼šçœ‹åˆ°è¯ä¹¦ç®¡ç†åˆ—è¡¨ä¸­å¤šäº†ä¸€æ¡è®°å½•

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713951785777-43b47513-c53c-4f4c-8b06-b3259b534432.png)

æœ€åæˆ‘ä»¬ç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼ŒæŠŠè°ƒè¯•è¯ä¹¦ä¸‹è½½çš„æœ¬åœ°ï¼Œåæ¥é…ç½®è¦ç”¨

### 1.1.4. ç”³è¯·è°ƒè¯•profile

è¿›å…¥AGCå¹³å°ï¼Œç‚¹å‡»æˆ‘çš„é¡¹ç›®è¿›å…¥åˆ°é¡¹ç›®é¡µï¼Œç‚¹å‡»å·¦ä¾§`HAP Provision Profile`ï¼Œç‚¹å‡»å³ä¾§çš„`æ·»åŠ `æŒ‰é’®

å¼¹å‡ºæ¡†å†…é€‰æ‹©ä¸Šä¸€æ­¥ç”Ÿæˆçš„meikou_preè°ƒè¯•è¯ä¹¦

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713951618656-b19c6981-8742-4ca4-b37f-970785bb0bd9.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718323002129-90cb6b78-1340-41f4-bcba-e4eebecd8585.png)

ç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼ŒæŠŠprofileæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713952003997-96ce7fcc-3f0c-4040-8b9c-215e196edd96.png)



### 1.1.5. DevEco Studioå·¥å…·ä¸­é…ç½®ç­¾åä¿¡æ¯

ç‚¹å‡»`æ–‡ä»¶->é¡¹ç›®ç»“æ„`

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713952147784-f74e4949-b819-43a2-a132-ed8ad80d0aa0.png)

ç‚¹å‡»â€œSigning Configsâ€é¡µç­¾ã€‚å»é™¤å‹¾é€‰çš„â€œAutomatically generate signatureâ€ï¼ˆå¦‚æœæ˜¯API 8å’Œ9å·¥ç¨‹ï¼Œéœ€åŒæ—¶å‹¾é€‰â€œSupport HarmonyOSâ€ï¼‰ï¼Œå¡«å†™ç›¸å…³ä¿¡æ¯åï¼Œç‚¹å‡»â€œOKâ€ã€‚

- **Store Fileï¼šå¯†é’¥åº“æ–‡ä»¶ï¼Œé€‰æ‹©****ç”Ÿæˆå¯†é’¥å’Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶****æ—¶ç”Ÿæˆçš„.p12æ–‡ä»¶**
- Store Passwordï¼šå¯†é’¥åº“å¯†ç ï¼Œéœ€è¦ä¸ç”Ÿæˆå¯†é’¥å’Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶æ—¶è®¾ç½®çš„å¯†é’¥åº“å¯†ç ä¿æŒä¸€è‡´
- Key aliasï¼šå¯†é’¥çš„åˆ«åä¿¡æ¯ï¼Œéœ€è¦ä¸ç”Ÿæˆå¯†é’¥å’Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶æ—¶è®¾ç½®çš„åˆ«åä¿æŒä¸€è‡´
- Key passwordï¼šå¯†é’¥çš„å¯†ç ï¼Œéœ€è¦ä¸ç”Ÿæˆå¯†é’¥å’Œè¯ä¹¦è¯·æ±‚æ–‡ä»¶æ—¶è®¾ç½®çš„å¯†ç ä¿æŒä¸€è‡´
- Sign algï¼šå›ºå®šè®¾ç½®ä¸ºâ€œSHA256withECDSAâ€
- **Profile fileï¼šé€‰æ‹©****ç”³è¯·è°ƒè¯•Profile****æ—¶ä¸‹è½½çš„.p7bæ–‡ä»¶**

- **Certpath fileï¼šé€‰æ‹©****ç”³è¯·è°ƒè¯•è¯ä¹¦****æ—¶ä¸‹è½½çš„.ceræ–‡ä»¶**

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713952489697-609637ba-efd7-4e65-a047-e215ade3b1d9.png)

### 1.1.6. é…ç½®å…¬é’¥æŒ‡çº¹

- ç™»å½•[AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)ï¼Œç‚¹å‡»â€œæˆ‘çš„é¡¹ç›®â€ã€‚
- åœ¨é¡¹ç›®åˆ—è¡¨ä¸­æ‰¾åˆ°æ‚¨çš„é¡¹ç›®ï¼Œåœ¨é¡¹ç›®ä¸­ç‚¹å‡»æ‚¨çš„åº”ç”¨/å…ƒæœåŠ¡ã€‚
- åœ¨â€œé¡¹ç›®è®¾ç½® > å¸¸è§„â€é¡µé¢çš„â€œåº”ç”¨â€åŒºåŸŸï¼Œç‚¹å‡»â€œSHA256è¯ä¹¦/å…¬é’¥æŒ‡çº¹â€åçš„â€œæ·»åŠ å…¬é’¥æŒ‡çº¹ï¼ˆHarmonyOS API 9åŠä»¥ä¸Šï¼‰â€

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718323057285-a6f35dfc-dbee-49d7-98c5-a71ade647a12.png)

é€‰æ‹©å’±ä»¬æ·»åŠ çš„è°ƒè¯•è¯ä¹¦

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1714059045185-99450cdf-a07b-413c-bfdb-eaa3acbcb8f6.png)

- åœ¨â€œé€‰æ‹©SHA256å…¬é’¥æŒ‡çº¹â€çª—å£ï¼Œé€‰æ‹©åº”ç”¨ä½¿ç”¨çš„è¯ä¹¦å¯¹åº”çš„æŒ‡çº¹ï¼Œç‚¹å‡»â€œç¡®è®¤â€

## 1.2. é…ç½®æƒé™

https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/account-client-id-0000001658658849-V5

### 1.2.1. é…ç½®Client ID

æŠŠClientIdåé¢çš„æ•°å­—å¤åˆ¶ä¸€ä¸‹ï¼Œæ”¾åˆ°é¡¹ç›®çš„`module.json5`æ–‡ä»¶ä¸­

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713952868511-0a2cd6b7-9ade-48ba-82f9-a4b941d61bed.png)

```typescript
"module": {
  "name": "xxx",
  "type": "entry",
  "description": "xxx",
  "mainElement": "xxx",
  "deviceTypes": [],
  "pages": "xxx",
  "abilities": [],
  "metadata": [ // é…ç½®ä¿¡æ¯å¦‚ä¸‹
    {
      "name": "client_id",
      "value": "xxx"
    }
  ]
}
```

clientIDï¼š111009537

clientSecret: c084a00eb0f8cc2c6fe97f0c2d344e6a67a934ffdf3d334258268fd5836cc166

### 1.2.2. scopeæƒé™ç”³è¯·

ç™»å½•åä¸ºå¼€å‘è€…è”ç›Ÿï¼Œé€‰æ‹©`ç®¡ç†ä¸­å¿ƒ->APIæœåŠ¡->æˆæƒç®¡ç†` ï¼Œé€‰æ‹©ç›®æ ‡åº”ç”¨çš„åº”ç”¨åç§°ï¼ŒæœåŠ¡é€‰æ‹©â€œåä¸ºå¸å·æœåŠ¡â€ï¼Œé€‰æ‹©â€œæ•æ„Ÿæƒé™â€ï¼Œå†é€‰æ‹©â€œè·å–æ‚¨çš„æ‰‹æœºå·â€æˆ–â€œè·å–å¹¶éªŒè¯æ‚¨çš„æ‰‹æœºå·â€ï¼Œç‚¹å‡»â€œç”³è¯·â€

https://developer.huawei.com/consumer/cn/

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1713954638244-009edfe6-8dcf-4d94-8f1f-d180e27f2f67.png)

æ³¨ï¼šåªè¦.p12 + .cer + .p7bä¸‰ä¸ªæ–‡ä»¶ä¿æŒä¸å˜ï¼ŒåŒ…åä¿æŒä¸€è‡´ï¼Œä»»ä½•æ–°å»ºé¡¹ç›®éƒ½å¯ä»¥å¤ç”¨ä¸‰ä¸ªæ–‡ä»¶è¿›è¡Œæ­£å¸¸ç­¾åç›´æ¥è°ƒè¯•å„ç§æœåŠ¡ï¼Œæ— éœ€é‡æ–°èµ°ä¸€éæµç¨‹

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1724649680224-b3103e24-9424-4ce9-9587-5109cd0feda1.png)

**æ³¨ï¼š**

1. è¿™ä¸€æ­¥ä¹‹å‰éšæ„å¡«å†™å³å¯ç”³è¯·é€šè¿‡ï¼Œç›®å‰ä¸å®¹æ˜“é€šè¿‡ï¼Œéœ€è¦ä¸¥æ ¼æŒ‰ç…§è¦æ±‚å¡«å†™ç”³è¯·ä¿¡æ¯
2. æˆ‘ä»¬æ›¿æ¢ä¹‹å‰ç”³è¯·çš„è¯ä¹¦è¿›è¡Œæµ‹è¯•ï¼Œè®°å¾—ä¿®æ”¹åŒ…å

1. 1. AppScope ä¸‹çš„ AppScope/app.json5ï¼Œæ”¹åŒ…å

[ğŸ“meikou_mall.zip](https://www.yuque.com/attachments/yuque/0/2025/zip/38706227/1748074609614-310aa284-bedf-4c27-b82e-a32830f1e550.zip)

## 1.3. å®ç°åä¸ºæˆæƒç™»å½•

[å¿«é€ŸéªŒè¯](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/account-get-phonenumber-V5)

### 1.3.1. å®ç°æµç¨‹å›¾

![img](https://cdn.nlark.com/yuque/0/2024/png/274425/1716198008120-4d63091d-39aa-4c3b-a640-99963c3a7746.png)

1. é…ç½®è¯ä¹¦åŠæƒé™
2. è°ƒç”¨åä¸ºç™»å½•çš„ api æ‹‰èµ·ç™»å½•ç•Œé¢
3. è·å–ç™»å½•æˆåŠŸä¹‹åçš„ codeï¼ˆç ï¼‰
4. æäº¤ç»™åº”ç”¨çš„åç«¯æ¥å£
5. åç«¯ä¼šå°† code æäº¤ç»™ã€åä¸ºæœåŠ¡å™¨ã€‘éªŒçœŸ
6. æˆåŠŸè¿”å›ç”¨æˆ·ä¿¡æ¯
7. æœ¬åœ°æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ä¿å­˜å³å¯

æ³¨ï¼š

1. win æ¨¡æ‹Ÿå™¨æ— æ³•æµ‹è¯•
2. ç›®å‰éœ€è¦ çœŸæœº æˆ–è€… macï¼ˆm èŠ¯ç‰‡ï¼‰çš„æ¨¡æ‹Ÿå™¨

### 1.3.2. è·å–åä¸ºç™»å½• code

[å‚è€ƒæ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/account-get-phonenumber-V5)

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743406297523-e0eea740-01ca-42fc-a712-05c0f713e12d.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718592642397-b190d724-24e2-4995-991b-04361ff48f7a.png)

1. **å‡†å¤‡ç™»å½•æ¨¡å—**

ä¸ºäº†ç®€åŒ–è°ƒç”¨è¿™é‡Œå°†åä¸ºç™»å½•çš„æ ¸å¿ƒé€»è¾‘è¿›è¡Œå°è£…

```ts
commons/basic/src/main/ets/utils/HuaweiAuthPlugin.ets

import { authentication } from "@kit.AccountKit"
import { util } from "@kit.ArkTS";

export class HuaweiAuthManager {
  // æ‹‰èµ·åä¸ºç™»å½•
  async launchAuth() {
    try {
      // 1.åˆ›å»ºæˆæƒè¯·æ±‚
      const request = new authentication.HuaweiIDProvider().createAuthorizationWithHuaweiIDRequest()
      // 2.ä¼ é€’å‚æ•°
      request.scopes = ['phone'];
      // è·å–codeéœ€ä¼ å¦‚ä¸‹permission
      request.permissions = ['serviceauthcode'];
      //
      request.forceAuthorization = true;

      request.state = util.generateRandomUUID(); // éšæœºUUID - è¿”å›çš„stateè¦å’Œè¿™ä¸ªuuidå¯¹å¾—ä¸Š æ²¡å¯¹ä¸Šå°±è¯´æ˜æœ‰äººç¯¡æ”¹è¯·æ±‚

      // controllerçš„ç›®çš„æ˜¯å‘èµ·è¯·æ±‚
      const controller = new authentication.AuthenticationController(getContext())

      const result = await controller.executeRequest(request) as authentication.AuthorizationWithHuaweiIDResponse
      if (request.state === result.state) {
        // è¯´æ˜è¯·æ±‚æ˜¯æ­£å¸¸çš„
        AlertDialog.show({ message: result.data?.authorizationCode })
        return result.data?.authorizationCode
      } else {
        AlertDialog.show({ message: 'åä¸ºç™»å½•è¯·æ±‚è¢«ç¯¡æ”¹ï¼ï¼ï¼' })
        return Promise.reject(new Error("åä¸ºç™»å½•è¯·æ±‚è¢«ç¯¡æ”¹"))
      }

    } catch (error) {
      AlertDialog.show({ message: error.message })
      return Promise.reject(error)
    }

  }

  // é€€å‡ºåä¸ºç™»å½•
  exitAuth() {

  }
}

export const huaweiAuthManager = new HuaweiAuthManager()
```

### 1.3.3. å®ç°åä¸ºç™»å½•

[æ¥å£æ–‡æ¡£](https://apifox.com/apidoc/shared-b2a05857-d21a-4a59-b3f8-aaf35972c78d/api-180356252)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718594814243-9d73cf54-9d85-4cd6-bcff-8d341383c05f.png)

- å°è£…åä¸ºç™»å½•çš„ç±»å‹

```typescript
features/mine/src/main/ets/viewmodels/user.ets

export interface HuaweiLoginParams {
  clientId: string;

  /**
   * å®¢æˆ·ç«¯ç§˜é’¥
   */
  clientSecret: string;

  /**
   * åä¸ºæˆæƒç 
   */
  code: string;
}
```

- å°è£…API

```typescript
features/mine/src/main/ets/api/user.ets

export const huaweiLoginAPI = (data: HuaweiLoginParams) => RequestRcp.post<HDMUser>("/login/huawei", data)
```

- ç‚¹å‡»åä¸ºå›¾æ ‡è¿›è¡Œç™»å½•

```typescript
features/mine/src/main/ets/views/LoginView.ets

Image($r("app.media.ic_user_huawei"))
    .width(60)
    .height(60)
    .onClick(async () => {
      const code = (await huaweiAuthManager.launchAuth())! // æ‹‰èµ·åä¸ºç™»å½•
      const result = await huaweiLoginAPI({
        code,
        clientId: '111009537',
        clientSecret: '30ac635b8516278c75582b4bdf1a6cf06827d782d5ddc1c3f97a8e31cb1e761e'
      })
      auth.setUser(result)
      HMRouterMgr.pop() // è¿”å›ä¸Šä¸€å±‚

    })
```



### 1.3.4. è°ƒæ•´ç™»å‡ºé€»è¾‘

**éœ€æ±‚ï¼š**

1. ç™»å‡ºæ—¶é¢å¤–è°ƒç”¨åä¸ºç™»å‡º

```typescript
import { authentication } from "@kit.AccountKit"
import { util } from "@kit.ArkTS";

export class HuaweiAuthManager {
  // æ‹‰èµ·åä¸ºç™»å½•
  async launchAuth() {
    try {
      // 1.åˆ›å»ºæˆæƒè¯·æ±‚
      const request = new authentication.HuaweiIDProvider().createAuthorizationWithHuaweiIDRequest()
      // 2.ä¼ é€’å‚æ•°
      request.scopes = ['phone'];
      // è·å–codeéœ€ä¼ å¦‚ä¸‹permission
      request.permissions = ['serviceauthcode'];
      //
      request.forceAuthorization = true;

      request.state = util.generateRandomUUID(); // éšæœºUUID - è¿”å›çš„stateè¦å’Œè¿™ä¸ªuuidå¯¹å¾—ä¸Š æ²¡å¯¹ä¸Šå°±è¯´æ˜æœ‰äººç¯¡æ”¹è¯·æ±‚

      // controllerçš„ç›®çš„æ˜¯å‘èµ·è¯·æ±‚
      const controller = new authentication.AuthenticationController(getContext())

      const result = await controller.executeRequest(request) as authentication.AuthorizationWithHuaweiIDResponse
      if (request.state === result.state) {
        // è¯´æ˜è¯·æ±‚æ˜¯æ­£å¸¸çš„
        return result.data?.authorizationCode
      } else {
        AlertDialog.show({ message: 'åä¸ºç™»å½•è¯·æ±‚è¢«ç¯¡æ”¹ï¼ï¼ï¼' })
        return Promise.reject(new Error("åä¸ºç™»å½•è¯·æ±‚è¢«ç¯¡æ”¹"))
      }

    } catch (error) {
      AlertDialog.show({ message: error.message })
      return Promise.reject(error)
    }

  }

  // é€€å‡ºåä¸ºç™»å½•
  // åˆ·æ–°tokenä¸éœ€è¦åš-å› ä¸ºæœ‰æ•ˆæœŸæ˜¯180å¤©
  async exitAuth() {
    const cancelRequest = new authentication.HuaweiIDProvider().createCancelAuthorizationRequest()
    const controller = new authentication.AuthenticationController()
    await controller.executeRequest(cancelRequest)

  }
}

export const huaweiAuthManager = new HuaweiAuthManager()

```

```ts
features/mine/src/main/ets/views/SettingView.ets

hdmDialogHelper.showConfirmDialog({
    title: 'æ¶ˆæ¯',
    content: 'ç¡®è®¤è¦é€€å‡ºå½“å‰è´¦æˆ·å—?',
    rightAction: () => {
      auth.setUser({} as HDMUser)
      huaweiAuthManager.exitAuth() // é€€å‡ºåä¸ºç™»å½•
      HMRouterMgr.pop()
    }
  })
```





# åäºŒã€è¯­éŸ³æœç´¢

windowsæ¨¡æ‹Ÿå™¨ä¸æ”¯æŒè¯­éŸ³è½¬åŒ–-macä¹Ÿä¸æ”¯æŒç›®å‰åªèƒ½ç”¨æ‰‹æœº

# 1. è¯­éŸ³æœç´¢

å½•éŸ³-æ‹¿åˆ°å½•éŸ³çš„buffer(äºŒè¿›åˆ¶)

buffer - è¯­éŸ³è¯†åˆ«å¼•æ“- (æ–‡å­—)

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718148870337-ca021e53-7f4d-4195-a137-7fa15c206f45.png?x-oss-process=image%2Fformat%2Cwebp)

åœ¨æœç´¢é¡µä¸­ï¼Œå¸¸è§„çš„äº¤äº’æ˜¯ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹ä¹‹åï¼Œç‚¹å‡»æœç´¢æŒ‰é’®è¿›è¡Œæœç´¢ä¸šåŠ¡ï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ã€è¯­éŸ³ã€‘çš„æ–¹å¼è¾“å…¥æƒ³è¦æœç´¢çš„å…³é”®è¯ï¼Œçœå»æ‰“å­—çš„éº»çƒ¦

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718149046525-13ea1de0-640d-4f52-af01-bb0a8d03bb02.png?x-oss-process=image%2Fformat%2Cwebp)

å½•éŸ³æŠŠéŸ³é¢‘bufferä¼ ç»™è¯­éŸ³è½¬åŒ–å¼•æ“ - è¾“å‡ºæ–‡å­—



## 1.1. ç»„ä»¶æ•´åˆ

[é”®ç›˜é¿è®©](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-uicontext-0000001774280798)

![image.png](https://cdn.nlark.com/yuque/0/2024/png/639379/1718149324257-06d403e8-d1ff-4fa5-83c0-d098848dbedd.png?x-oss-process=image%2Fformat%2Cwebp)

**æ ¸å¿ƒæ­¥éª¤ï¼š**

1. åˆ›å»ºç»„ä»¶
2. æ•´åˆå›¾ç‰‡
3. åœ¨ features/home/src/main/ets/views/SearhView.ets é¡µé¢ä¸­å¼•å…¥

```ts
features/home/src/main/ets/components/HDMAudioSearch.ets

export enum VoiceState {
  DEFAULT,
  VOICING,
  VOICEOVER
}

@Preview
@ComponentV2
export struct HDMAudioSearch {
  @Local voiceState: VoiceState = VoiceState.DEFAULT
  @Local keyword: string = ''
  @Event
  onComplete: (keyword: string) => void = () => {
  }

  // å¼€å§‹å½•éŸ³
  async startRecord() {

  }

  // ç»“æŸå½•éŸ³
  async closeRecord() {

  }

  aboutToAppear(): void {

  }

  build() {
    Column() {
      if (this.voiceState !== VoiceState.DEFAULT) {
        Column({ space: 16 }) {
          if (this.voiceState === VoiceState.VOICING) {
            Text('è¯·è¯´ï¼Œæˆ‘åœ¨è†å¬...')
              .fontSize(14)
            Text(this.keyword)
              .fontSize(14)
              .margin({
                top: 20
              })
          } else if (this.voiceState === VoiceState.VOICEOVER && this.keyword === '') {
            Text('æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é•¿æŒ‰æŒ‰é’®é‡è¯•')
              .fontSize(14)
          }
          Text() {
            Span('ä½ å¯ä»¥è¿™æ ·è¯´ï¼š')
            Span('å¤ªé˜³çœ¼é•œ/å†¬æ¬¾è¿è¡£è£™')
              .fontColor($r('[basic].color.gray'))
          }
          .fontSize(12)
        }
        .justifyContent(FlexAlign.Center)
        .height(150)
      }
      Blank()
      Button() {
        Row({ space: 4 }) {
          Image($r('sys.media.ohos_ic_public_voice'))
            .width(16)
            .aspectRatio(1)
            .fillColor($r('[basic].color.white'))
          if (this.voiceState === VoiceState.VOICING) {
            Text('æ¾å¼€ç«‹å³æœç´¢')
              .fontSize(14)
              .fontColor($r('[basic].color.white'))
          } else {
            Text('é•¿æŒ‰è¯­éŸ³æœç´¢')
              .fontSize(14)
              .fontColor($r('[basic].color.white'))
          }
        }
      }
      .padding({ left: 12, right: 12 })
      .height(36)
      .linearGradient({
        angle: 135,
        colors: [[$r('[basic].color.linear_begin'), 0], [$r('[basic].color.linear_end'), 1]]
      })
      .margin({ bottom: 16 })
      .gesture(
        LongPressGesture()
          .onAction(() => {
            // å¼€å§‹å½•éŸ³
            this.startRecord()
          })
          .onActionEnd(() => {
            // ç»“æŸå½•éŸ³
            this.closeRecord()
          })
          .onActionCancel(() => {
            // ç»“æŸå½•éŸ³
            this.closeRecord()
          })
      )

    }
    .layoutWeight(1)
    .width('100%')
    .backgroundImage($r('app.media.search_bg'))
    .backgroundImageSize(ImageSize.Contain)
    .backgroundImagePosition(Alignment.Bottom)
    .onVisibleAreaChange([0, 1], () => {
      this.keyword = ''
      this.voiceState = VoiceState.DEFAULT
    })
  }
}
```

![image.png](https://cdn.nlark.com/yuque/0/2024/png/8435673/1730948503194-79cbc7d6-056a-43a4-b6fc-85abe4420675.png?x-oss-process=image%2Fformat%2Cwebp)

èƒŒæ™¯å›¾æ”¾åœ¨homeæ¨¡å—ä¸‹

![image.png](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743211122164-092c4024-11dc-4dd9-ab73-e8604d247409.png?x-oss-process=image%2Fformat%2Cwebp)

åœ¨æœç´¢é¡µé¢å®ç°é”®ç›˜é¿è®©

```ts
features/home/src/main/ets/views/SearchView.ets

import { AppStorageV2, promptAction, KeyboardAvoidMode } from '@kit.ArkUI'

  aboutToAppear() {
    this.getUIContext().setKeyboardAvoidMode(KeyboardAvoidMode.RESIZE)
  }
```



## 1.2. ç”³è¯·æƒé™

[å£°æ˜æƒé™](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/declare-permissions-V5)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1718149416558-a6c3feb1-6e05-4a07-84d5-fe57684ac95c.png)

- å…ˆçœ‹æœ‰æ²¡æœ‰ 
- æ²¡æœ‰å†ç”³è¯·
- ç”³è¯·é€šè¿‡ä¸€åˆ‡ok
- æ²¡é€šè¿‡å°±æ‹‰èµ·è®¾ç½®é¡µ-settingæ–¹æ³•ç›´æ¥å¯ä»¥è®¾ç½®å³å¯



æ ¸å¿ƒæ­¥éª¤ï¼š

1. module.json5é‡Œé¢ç”³è¯·æƒé™

```ts
products/phone/src/main/module.json5

{
  "module": {
    "name": "phone",
    "type": "entry",
    "description": "$string:module_desc",
    "mainElement": "PhoneAbility",
    "deviceTypes": [
      "phone",
      "tablet",
      "2in1"
    ],
    "requestPermissions": [{
      "name": "ohos.permission.INTERNET"
    }, {
      "name": "ohos.permission.GET_NETWORK_INFO"
    }, {
      "name": "ohos.permission.MICROPHONE",
      "reason": "$string:mic_reason",
      "usedScene": {
        "when": "always",
        "abilities": ["PhoneAbility"]
      }

    }],
    "deliveryWithInstall": true,
    "installationFree": false,
    "pages": "$profile:main_pages",
    "abilities": [
      {
        "name": "PhoneAbility",
        "srcEntry": "./ets/phoneability/PhoneAbility.ets",
        "description": "$string:PhoneAbility_desc",
        "icon": "$media:foreground",
        "label": "$string:PhoneAbility_label",
        "startWindowIcon": "$media:startIcon",
        "startWindowBackground": "$color:start_window_background",
        "exported": true,
        "skills": [
          {
            "entities": [
              "entity.system.home"
            ],
            "actions": [
              "action.system.home"
            ]
          }
        ]
      }
    ],
    "extensionAbilities": [
      {
        "name": "PhoneBackupAbility",
        "srcEntry": "./ets/phonebackupability/PhoneBackupAbility.ets",
        "type": "backup",
        "exported": false,
        "metadata": [
          {
            "name": "ohos.extension.backup",
            "resource": "$profile:backup_config"
          }
        ]
      }
    ]
  }
}
```

å°è£…é‰´æƒå·¥å…·

- å…ˆæ£€æŸ¥-éœ€è¦tokenId
- éœ€è¦bundleManager.getBundleInfoForSelftè·å–tokenId
- å¾—åˆ°æ£€æŸ¥ç»“æœ-æœ‰æƒé™æ­£å¸¸æ‰§è¡Œ, æ²¡æœ‰æƒé™å°è¯•ç”³è¯·
- å°è¯•ç”³è¯·-åªèƒ½å¼¹å‡ºä¸€æ¬¡ï¼Œå¦‚æœæ²¡æœ‰å¼¹å‡ºè¯´æ˜ä¹‹å‰å·²ç»ç”³è¯·è¿‡-åŒæ„/ä¸åŒæ„
- åŒæ„-æ­£å¸¸èµ°
- ä¸åŒæ„- onSetting-å¯ä»¥æ— é™å¼¹

```ts
commons/basic/src/main/ets/utils/AccessManager.ets

import { abilityAccessCtrl, bundleManager, Permissions } from "@kit.AbilityKit";

export class AccessManager {
  async checkPermission(permissions: Permissions[], success: () => void, fail?: () => void) {
    // 1ï¼Œå…ˆçœ‹æœ‰æ²¡æœ‰
    const app = bundleManager.getBundleInfoForSelfSync(bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION)
    const manager = abilityAccessCtrl.createAtManager()
    const listResult = permissions.map(p => manager.checkAccessTokenSync(app.appInfo.accessTokenId, p))
    // æ£€æŸ¥æ‰€æœ‰çš„æƒé™çš„ç»“æœ
    const isOK = listResult.every(res => res === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED)
    if (isOK) {
      success()
    } else {
      // ç¬¬ä¸€æ¬¡ç”³è¯·æƒé™
      const result = await manager.requestPermissionsFromUser(getContext(), permissions)
      const againCheck = result.authResults.every(res => res === 0)
      if (againCheck) {
        success()
      } else {
        const secondCheck = await manager.requestPermissionOnSetting(getContext(), permissions)
        const checkResult = secondCheck.every(res => res === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED)
        if (checkResult) {
          success()
        } else {
          fail?.()
          // fail && fail()
          // if (fail) {
          //   fail()
          // }
        }
      }
    }
    //

  }
}

export const accessManager = new AccessManager()
```

1. é•¿æŒ‰è¯­éŸ³æœç´¢æ—¶ï¼Œè¿›è¡Œé‰´æƒ-åªåœ¨é•¿æŒ‰è¯­éŸ³æ—¶è§¦å‘

```ts
features/home/src/main/ets/components/HDMAudioSearch.ets

// å¼€å§‹å½•éŸ³
  async startRecord() {
    accessManager.checkPermission(["ohos.permission.MICROPHONE"], () => {
      promptAction.showToast({ message: 'å¯ä»¥å¼€å§‹å½•éŸ³äº†' })
    }, () => {
      promptAction.showToast({ message: 'æ‚¨å½“å‰æ²¡æœ‰å¼€å¯æƒé™ï¼Œæ— æ³•ä½¿ç”¨è¯­éŸ³åŠŸèƒ½' })
    })

  }
```



## 1.3. è¯­éŸ³å½•åˆ¶

å½•åˆ¶è¯­éŸ³-AvRecorder-AvPlayer- ç›´æ¥å†™å…¥éŸ³é¢‘æ–‡ä»¶

AudioCapurter-pcméŸ³é¢‘-è¯­éŸ³è¯†åˆ«-åªèƒ½è¯†åˆ«pcméŸ³é¢‘

è¯­éŸ³è½¬æˆæ–‡å­—

[AudioCapturer](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/using-audiocapturer-for-recording-V5)

- å°è£…å½•éŸ³çš„å·¥å…·ç±»

å½•çš„éŸ³é¢‘æ•°æ®è¦å®æ—¶è½¬åŒ–æ–‡å­—-

ä¸éœ€è¦å†™å…¥æ²™ç®±æ–‡ä»¶- éŸ³é¢‘æ•°æ®ä»¥å†…å­˜å½¢å¼å­˜åœ¨

```ts
commons/basic/src/main/ets/utils/AudioCapturerManager.ets

import { audio } from "@kit.AudioKit"

export class AudioCapturerManager {
  capturer: audio.AudioCapturer | null = null

  // åˆ›å»ºå½•éŸ³å¯¹è±¡
  async initCapturer() {

    let audioStreamInfo: audio.AudioStreamInfo = {
      samplingRate: audio.AudioSamplingRate.SAMPLE_RATE_16000, // é‡‡æ ·ç‡ è¯­éŸ³è¯†åˆ«åªèƒ½è¯†åˆ«16000
      channels: audio.AudioChannel.CHANNEL_1, // é€šé“1
      sampleFormat: audio.AudioSampleFormat.SAMPLE_FORMAT_S16LE, // é‡‡æ ·æ ¼å¼
      encodingType: audio.AudioEncodingType.ENCODING_TYPE_RAW // ç¼–ç æ ¼å¼
    };

    let audioCapturerInfo: audio.AudioCapturerInfo = {
      source: audio.SourceType.SOURCE_TYPE_MIC,
      capturerFlags: 0
    };

    let audioCapturerOptions: audio.AudioCapturerOptions = {
      streamInfo: audioStreamInfo,
      capturerInfo: audioCapturerInfo
    };
    this.capturer = await audio.createAudioCapturer(audioCapturerOptions);
  }

  async start(callback: (bf: ArrayBuffer) => void) {
    // 1.åˆ›å»ºé‡‡é›†å™¨
    if (!this.capturer) {
      await this.initCapturer()
    }
    // 2.ç›‘å¬readData
    this.capturer?.on("readData", (bf) => {
      // bf -> æ–‡å­— å®æ—¶çš„
      callback(bf)
    })
    // 3.å¼€å§‹å½•åˆ¶
    this.capturer?.start() // å¼€å§‹å½•éŸ³

  }

  async stop() {
    await this.capturer?.stop()
    this.capturer?.release()
    this.capturer = null
  }
}

export const audioCapturerManager = new AudioCapturerManager()
```

- åœ¨è¯­éŸ³æœç´¢ç»„ä»¶ä¸­è¿›è¡Œå¼€å§‹å’Œç»“æŸ

```typescript
features/home/src/main/ets/components/HDMAudioSearch.ets

// å¼€å§‹å½•éŸ³
  async startRecord() {
    accessManager.checkPermission(["ohos.permission.MICROPHONE"], () => {
      // promptAction.showToast({ message: 'å¯ä»¥å¼€å§‹å½•éŸ³äº†' })
      audioCapturerManager.start((bf) => {
        HDMLog.info("å½•éŸ³ä¸­-" + bf.byteLength)
      })
    }, () => {
      promptAction.showToast({ message: 'æ‚¨å½“å‰æ²¡æœ‰å¼€å¯æƒé™ï¼Œæ— æ³•ä½¿ç”¨è¯­éŸ³åŠŸèƒ½' })
    })

  }

  // ç»“æŸå½•éŸ³
  async closeRecord() {
    audioCapturerManager.stop()
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743215994974-236a1442-aa61-4969-9004-e019effe102f.png)

- çœŸæœºè°ƒè¯•

æ¨¡æ‹Ÿå™¨ä¸éœ€è¦ç­¾åå’Œè¯ä¹¦

çœŸæœºå¿…é¡»å¾—æœ‰ç­¾åå’Œè¯ä¹¦-è‡ªåŠ¨ç­¾åå’Œæ‰‹åŠ¨ç­¾å

è‡ªåŠ¨ç­¾åå’Œè¯ä¹¦-p12-p7b-cer-csr

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1732437259201-c451cec4-571c-4a46-89df-78aedc21ed4a.png)

è‡ªåŠ¨ç­¾å![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1732437298039-6e3a73b7-1d64-4560-8fab-ecba79bd1afa.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1732437315058-821da76a-a25f-45c5-88f8-c600e7dfe5ab.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/8435673/1732437367378-58467a54-7f71-4b36-9dd2-67acf26247f0.png)



[è¯­éŸ³è¯†åˆ«å¼•æ“-core-speechèƒ½åŠ›](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/speechrecognizer-guide-V5)

```ts
commons/basic/src/main/ets/utils/CoreSpeechManger.ets

import { speechRecognizer } from '@kit.CoreSpeechKit';
import { HDMLog } from '.';

export class CoreSpeechManager {
  asrEngine: speechRecognizer.SpeechRecognitionEngine | null = null // è¯­éŸ³è¯†åˆ«å¼•æ“
  // å¼•æ“å¾—æå‰åˆå§‹åŒ– -å½•éŸ³å·²ç»æœ‰buffer ä½ è¯´äº†ä¸€å¥ä½ å¥½ éœ€è¦ä¿è¯æ­¤æ—¶è¯­éŸ³è¯†åˆ«å¼•æ“å·²ç»å‡†å¤‡å¥½äº†
  sessionId: string = Date.now().toString() // å¿…é¡»æ˜¯æ•°å­—å­—ç¬¦ä¸²
  async initEngine() {

    // åˆ›å»ºå¼•æ“ï¼Œé€šè¿‡callbackå½¢å¼è¿”å›
    // è®¾ç½®åˆ›å»ºå¼•æ“å‚æ•°
    let extraParam: Record<string, Object> = { "locate": "CN", "recognizerMode": "short" };
    let initParamsInfo: speechRecognizer.CreateEngineParams = {
      language: 'zh-CN', // æ”¯æŒä¸­æ–‡
      online: 1, // ç¦»çº¿æ¨¡å¼ æ¯”è¾ƒå¼± æ²¡é‚£ä¹ˆå¤§çš„å‡†ç¡®æ€§
      extraParams: extraParam
    };
    // è°ƒç”¨createEngineæ–¹æ³•
    this.asrEngine = await speechRecognizer.createEngine(initParamsInfo);
    this.setListener() // è®¾ç½®ç›‘å¬
    this.startListening() // å¼€å§‹ç›‘å¬
  }

  // è®¾ç½®ç›‘å¬å›è°ƒ
  private setListener() {
    // åˆ›å»ºå›è°ƒå¯¹è±¡
    let setListener: speechRecognizer.RecognitionListener = {
      // å¼€å§‹è¯†åˆ«æˆåŠŸå›è°ƒ
      onStart(sessionId: string, eventMessage: string) {
        console.info(`onStart, sessionId: ${sessionId} eventMessage: ${eventMessage}`);
      },
      // äº‹ä»¶å›è°ƒ
      onEvent(sessionId: string, eventCode: number, eventMessage: string) {
        console.info(`onEvent, sessionId: ${sessionId} eventCode: ${eventCode} eventMessage: ${eventMessage}`);
      },
      // è¯†åˆ«ç»“æœå›è°ƒï¼ŒåŒ…æ‹¬ä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœ
      onResult(sessionId: string, result: speechRecognizer.SpeechRecognitionResult) {
        HDMLog.info(result.result)
        console.info(`onResult, sessionId: ${sessionId} sessionId: ${JSON.stringify(result)}`);
      },
      // è¯†åˆ«å®Œæˆå›è°ƒ
      onComplete(sessionId: string, eventMessage: string) {
        console.info(`onComplete, sessionId: ${sessionId} eventMessage: ${eventMessage}`);
      },
      // é”™è¯¯å›è°ƒï¼Œé”™è¯¯ç é€šè¿‡æœ¬æ–¹æ³•è¿”å›
      // å¦‚ï¼šè¿”å›é”™è¯¯ç 1002200006ï¼Œè¯†åˆ«å¼•æ“æ­£å¿™ï¼Œå¼•æ“æ­£åœ¨è¯†åˆ«ä¸­
      // æ›´å¤šé”™è¯¯ç è¯·å‚è€ƒé”™è¯¯ç å‚è€ƒ
      onError(sessionId: string, errorCode: number, errorMessage: string) {
        console.error(`onError, sessionId: ${sessionId} errorCode: ${errorCode} errorMessage: ${errorMessage}`);
      }
    }
    // è®¾ç½®å›è°ƒ
    this.asrEngine?.setListener(setListener);
  }

  // å¼€å¯ç›‘å¬
  private startListening() {
    let recognizerParams: speechRecognizer.StartParams = {
      sessionId: this.sessionId,
      audioInfo: {
        audioType: 'pcm',
        sampleRate: 16000,
        soundChannel: 1,
        sampleBit: 16
      } //audioInfoå‚æ•°é…ç½®è¯·å‚è€ƒAudioInfo
    }
    // è°ƒç”¨å¼€å§‹è¯†åˆ«æ–¹æ³•
    this.asrEngine?.startListening(recognizerParams);
  }

  // å¼€å§‹åˆ†æ
  startTransVoice(bf: ArrayBuffer) {
    this.asrEngine?.writeAudio(this.sessionId, new Uint8Array(bf)) // å†™å…¥éŸ³é¢‘æµ
  }

  // åœæ­¢åˆ†æ
  stopTransVoice() {
    this.asrEngine?.finish(this.sessionId) // ç»“æŸè¯†åˆ«
    this.asrEngine?.shutdown() // é‡Šæ”¾èµ„æº
    this.asrEngine = null // å†…å­˜æ¸…ç©º
    this.sessionId = Date.now().toString() // é‡æ–°åˆå§‹åŒ–sessionId
  }
}

export const coreSpeechManager = new CoreSpeechManager()
```

- è¯­éŸ³è¯†åˆ«è°ƒç”¨

```ts
 async startRecord() {
    accessManager.checkPermission(["ohos.permission.MICROPHONE"], async () => {
      // promptAction.showToast({ message: 'å¯ä»¥å¼€å§‹å½•éŸ³äº†' })
      await coreSpeechManager.initEngine() // å…ˆåˆå§‹åŒ–å¼•æ“
      audioCapturerManager.start((bf) => {
        // HDMLog.info("å½•éŸ³ä¸­-" + bf.byteLength) // bf -> æ–‡å­—
        coreSpeechManager.startTransVoice(bf) // å°†bufferæºæºä¸æ–­çš„ä¼ é€’ç»™è¯†åˆ«å¼•æ“
      })
    }, () => {
      promptAction.showToast({ message: 'æ‚¨å½“å‰æ²¡æœ‰å¼€å¯æƒé™ï¼Œæ— æ³•ä½¿ç”¨è¯­éŸ³åŠŸèƒ½' })
    })

  }

  // ç»“æŸå½•éŸ³
  async closeRecord() {
    await audioCapturerManager.stop() // åœæ­¢å½•éŸ³
    coreSpeechManager.stopTransVoice() // åœæ­¢è¯­éŸ³åˆ†æ
  }

```

- è¯­éŸ³è¯†åˆ«æ–‡å­—åˆ°é¡µé¢æ˜¾ç¤º

- ç»™è¯­éŸ³è¯†åˆ«å¼•æ“æ·»åŠ å›è°ƒå‡½æ•°

```ts
commons/basic/src/main/ets/utils/CoreSpeechManger.ets

import { speechRecognizer } from '@kit.CoreSpeechKit';
import { HDMLog } from '.';
import { emitter } from '@kit.BasicServicesKit';

export class CoreSpeechManager {
  asrEngine: speechRecognizer.SpeechRecognitionEngine | null = null // è¯­éŸ³è¯†åˆ«å¼•æ“
  // å¼•æ“å¾—æå‰åˆå§‹åŒ– -å½•éŸ³å·²ç»æœ‰buffer ä½ è¯´äº†ä¸€å¥ä½ å¥½ éœ€è¦ä¿è¯æ­¤æ—¶è¯­éŸ³è¯†åˆ«å¼•æ“å·²ç»å‡†å¤‡å¥½äº†
  sessionId: string = Date.now().toString() // å¿…é¡»æ˜¯æ•°å­—å­—ç¬¦ä¸²
  resultCallBack?: (content: string) => void // æœ¬èº«å®šä¹‰ä¸€ä¸ªå‡½æ•°

  async initEngine(callBack: (content: string) => void) {
    this.resultCallBack = callBack // å°†å¤–ç•Œä¼ å…¥çš„å‡½æ•°èµ‹å€¼ç»™æœ¬èº«çš„ä¸€ä¸ªå‡½æ•°
    // åˆ›å»ºå¼•æ“ï¼Œé€šè¿‡callbackå½¢å¼è¿”å›
    // è®¾ç½®åˆ›å»ºå¼•æ“å‚æ•°
    let extraParam: Record<string, Object> = { "locate": "CN", "recognizerMode": "short" };
    let initParamsInfo: speechRecognizer.CreateEngineParams = {
      language: 'zh-CN', // æ”¯æŒä¸­æ–‡
      online: 1, // ç¦»çº¿æ¨¡å¼ æ¯”è¾ƒå¼± æ²¡é‚£ä¹ˆå¤§çš„å‡†ç¡®æ€§
      extraParams: extraParam
    };
    // è°ƒç”¨createEngineæ–¹æ³•
    this.asrEngine = await speechRecognizer.createEngine(initParamsInfo);
    this.setListener() // è®¾ç½®ç›‘å¬
    this.startListening() // å¼€å§‹ç›‘å¬
  }

  // è®¾ç½®ç›‘å¬å›è°ƒ
  private setListener() {
    // åˆ›å»ºå›è°ƒå¯¹è±¡
    let setListener: speechRecognizer.RecognitionListener = {
      // å¼€å§‹è¯†åˆ«æˆåŠŸå›è°ƒ
      onStart(sessionId: string, eventMessage: string) {
        console.info(`onStart, sessionId: ${sessionId} eventMessage: ${eventMessage}`);
      },
      // äº‹ä»¶å›è°ƒ
      onEvent(sessionId: string, eventCode: number, eventMessage: string) {
        console.info(`onEvent, sessionId: ${sessionId} eventCode: ${eventCode} eventMessage: ${eventMessage}`);
      },
      // è¯†åˆ«ç»“æœå›è°ƒï¼ŒåŒ…æ‹¬ä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœ
      onResult: (sessionId: string, result: speechRecognizer.SpeechRecognitionResult) => {
        // HDMLog.info(result.result)
        // emitter
        // eventHub
        // å›è°ƒå‡½æ•°
        this.resultCallBack?.(result.result) // å›è°ƒå‡½æ•°ä¼ å‡ºæ–‡æœ¬
        console.info(`onResult, sessionId: ${sessionId} sessionId: ${JSON.stringify(result)}`);
      },
      // è¯†åˆ«å®Œæˆå›è°ƒ
      onComplete(sessionId: string, eventMessage: string) {
        console.info(`onComplete, sessionId: ${sessionId} eventMessage: ${eventMessage}`);
      },
      // é”™è¯¯å›è°ƒï¼Œé”™è¯¯ç é€šè¿‡æœ¬æ–¹æ³•è¿”å›
      // å¦‚ï¼šè¿”å›é”™è¯¯ç 1002200006ï¼Œè¯†åˆ«å¼•æ“æ­£å¿™ï¼Œå¼•æ“æ­£åœ¨è¯†åˆ«ä¸­
      // æ›´å¤šé”™è¯¯ç è¯·å‚è€ƒé”™è¯¯ç å‚è€ƒ
      onError(sessionId: string, errorCode: number, errorMessage: string) {
        console.error(`onError, sessionId: ${sessionId} errorCode: ${errorCode} errorMessage: ${errorMessage}`);
      }
    }
    // è®¾ç½®å›è°ƒ
    this.asrEngine?.setListener(setListener);
  }

  // å¼€å¯ç›‘å¬
  private startListening() {
    let recognizerParams: speechRecognizer.StartParams = {
      sessionId: this.sessionId,
      audioInfo: {
        audioType: 'pcm',
        sampleRate: 16000,
        soundChannel: 1,
        sampleBit: 16
      } //audioInfoå‚æ•°é…ç½®è¯·å‚è€ƒAudioInfo
    }
    // è°ƒç”¨å¼€å§‹è¯†åˆ«æ–¹æ³•
    this.asrEngine?.startListening(recognizerParams);
  }

  // å¼€å§‹åˆ†æ
  startTransVoice(bf: ArrayBuffer) {
    this.asrEngine?.writeAudio(this.sessionId, new Uint8Array(bf)) // å†™å…¥éŸ³é¢‘æµ
  }

  // åœæ­¢åˆ†æ
  stopTransVoice() {
    this.asrEngine?.finish(this.sessionId) // ç»“æŸè¯†åˆ«
    this.asrEngine?.shutdown() // é‡Šæ”¾èµ„æº
    this.asrEngine = null // å†…å­˜æ¸…ç©º
    this.sessionId = Date.now().toString() // é‡æ–°åˆå§‹åŒ–sessionId
  }
}

export const coreSpeechManager = new CoreSpeechManager()
```

- è¯­éŸ³æœç´¢ç»„ä»¶ä¼ å…¥

```typescript
features/home/src/main/ets/components/HDMAudioSearch.ets

// å¼€å§‹å½•éŸ³
  async startRecord() {
    accessManager.checkPermission(["ohos.permission.MICROPHONE"], async () => {
      this.voiceState = VoiceState.VOICING
      // promptAction.showToast({ message: 'å¯ä»¥å¼€å§‹å½•éŸ³äº†' })
      await coreSpeechManager.initEngine((content) => {
        this.keyword = content
      }) // å…ˆåˆå§‹åŒ–å¼•æ“
      audioCapturerManager.start((bf) => {
        // HDMLog.info("å½•éŸ³ä¸­-" + bf.byteLength) // bf -> æ–‡å­—
        coreSpeechManager.startTransVoice(bf) // å°†bufferæºæºä¸æ–­çš„ä¼ é€’ç»™è¯†åˆ«å¼•æ“
      })
    }, () => {
      promptAction.showToast({ message: 'æ‚¨å½“å‰æ²¡æœ‰å¼€å¯æƒé™ï¼Œæ— æ³•ä½¿ç”¨è¯­éŸ³åŠŸèƒ½' })
    })

  }
// ç»“æŸå½•éŸ³
  async closeRecord() {
    this.keyword = ""
    this.voiceState = VoiceState.DEFAULT
    await audioCapturerManager.stop() // åœæ­¢å½•éŸ³
    coreSpeechManager.stopTransVoice() // åœæ­¢è¯­éŸ³åˆ†æ
  }
 @Computed
  get btnWidth() {
    if (this.voiceState === VoiceState.DEFAULT) {
      return 150
    } else {
      return 200
    }
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743231752532-e841e254-6e78-4b28-9b15-447e33813ae3.png)

## 1.4. è¯­éŸ³æœç´¢è·³è½¬åˆ°æœç´¢ç»“æœ

- æ‹¿åˆ°è¯­éŸ³è¯†åˆ«çš„æ–‡æœ¬-å»æ‰å¤šä½™çš„ç¬¦å·

```typescript
features/home/src/main/ets/components/HDMAudioSearch.ets

// ç»“æŸå½•éŸ³
  async closeRecord() {
    // å°†æ–‡æœ¬æ›¿æ¢ç‰¹æ®Šå­—ç¬¦
    this.onComplete(this.keyword.replace(/[^\p{L}\p{N}\s]/gu, '')) // è¯­éŸ³è¯†åˆ«ç»“æœä¼ åˆ°ä¸‰å±‚ç»„ä»¶
    this.keyword = ""
    this.voiceState = VoiceState.DEFAULT
    await audioCapturerManager.stop() // åœæ­¢å½•éŸ³
    coreSpeechManager.stopTransVoice() // åœæ­¢è¯­éŸ³åˆ†æ
  }
```

- æ¾æ‰‹æ—¶ï¼Œé€šè¿‡onCompleteå‡½æ•°é€šçŸ¥çˆ¶ç»„ä»¶è¿›è¡Œè·³è½¬

```ts
    features/home/src/main/ets/views/SearchView.ets

    // è¯­éŸ³æœç´¢ç»„ä»¶
      HDMAudioSearch({
        onComplete: (keyword) => {
          this.keyword = keyword
          HMRouterMgr.push({
            pageUrl: PAGE_PATH.SEARCH_RESULT_PAGE,
            param: {
              keyword: this.keyword
            }
          })
        }
      })
```

