# 四、普通搜索

# 1. 普通搜索

完成普通搜索功能

[search组件](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-search-0000001815927592)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717781575477-5dab8d28-e643-4e9d-a46b-9e1ca25d696f.png)

Router模式

Navigaiton模式

- 根组件必须Navigaiton包裹
- 子页面必须被NavDestination包裹
- 跳转页面必须使用NavPathStack，必须绑定Navigaiton组件
- 首选通过if/else模式 很多个组件 逐个判断name
- 使用wrapBuilder 所有组件放入到Map对象，get方法获取组件
- json模式-router_map.json-name/buildeFunciton/PageSourceFile

HmRouter-是基于Navigaiton模式的一次升级改造，跳转会更简单！！！

配置比较麻烦

## 1.1. 集成HmRouter的路由模式

- 集成插件
- 使用HMNavigaiton包裹根容器

[HmRouter](https://ohpm.openharmony.cn/#/cn/detail/@hadss%2Fhmrouter)文档

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743131321398-59b64f6f-7af2-448a-9002-157f2752aa52.png)

- 将当前项目换成HmRouter模式

- 全局安装hmrouter依赖

```bash
$ ohpm install @hadss/hmrouter
$ ohpm install @hadss/hmrouter-transitions
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743131477271-c3728bb0-78b9-427e-8bc7-a9b4515f6ef0.png)

- 修改全局的hvigor-config.json5(加入hm-router插件)

```typescript
hvigor/hvigor-config.json5

{
  "modelVersion": "5.0.1",
  "dependencies": {
    "@hadss/hmrouter-plugin": "^1.0.0-rc.10"
  },
  "execution": {
    // "analyze": "normal",                     /* Define the build analyze mode. Value: [ "normal" | "advanced" | false ]. Default: "normal" */
    // "daemon": true,                          /* Enable daemon compilation. Value: [ true | false ]. Default: true */
    // "incremental": true,                     /* Enable incremental compilation. Value: [ true | false ]. Default: true */
    // "parallel": true,                        /* Enable parallel compilation. Value: [ true | false ]. Default: true */
    // "typeCheck": false,                      /* Enable typeCheck. Value: [ true | false ]. Default: false */
  },
  "logging": {
    // "level": "info"                          /* Define the log level. Value: [ "debug" | "info" | "warn" | "error" ]. Default: "info" */
  },
  "debugging": {
    // "stacktrace": false                      /* Disable stacktrace compilation. Value: [ true | false ]. Default: false */
  },
  "nodeOptions": {
    // "maxOldSpaceSize": 8192                  /* Enable nodeOptions maxOldSpaceSize compilation. Unit M. Used for the daemon process. Default: 8192*/
    // "exposeGC": true                         /* Enable to trigger garbage collection explicitly. Default: true*/
  }
}
```

- 在products成加入hap编译插件

需要注意hap/hsp/har对应的编译插件不同

```typescript
products/phone/hvigorfile.ts

import { hapTasks } from '@ohos/hvigor-ohos-plugin';
import { hapPlugin } from "@hadss/hmrouter-plugin";

export default {
  system: hapTasks, /* Built-in plugin of Hvigor. It cannot be modified. */
  plugins: [hapPlugin()] // 使用HM Custom plugin to extend the functionality of Hvigor. */
}
```

- 在features的四个包中加入hsp的编译插件-四个hsp包的hvigorfile.ts插件均一致

```typescript
features/cart/hvigorfile.ts

import { hspTasks } from '@ohos/hvigor-ohos-plugin';
import { hspPlugin } from "@hadss/hmrouter-plugin";

export default {
  system: hspTasks, /* Built-in plugin of Hvigor. It cannot be modified. */
  plugins: [hspPlugin()]         /* Custom plugin to extend the functionality of Hvigor. */
}
```

注意： 以上的插件需要配置四次

- 为了防止底层basic也有可能做一些公共页面，也加入同样的配置

```typescript
commons/basic/hvigorfile.ts

import { hspTasks } from '@ohos/hvigor-ohos-plugin';
import { hspPlugin } from "@hadss/hmrouter-plugin";

export default {
  system: hspTasks, /* Built-in plugin of Hvigor. It cannot be modified. */
  plugins: [hspPlugin()]         /* Custom plugin to extend the functionality of Hvigor. */
}
```

- 在入口Ability中加入HmRouter的初始化上下文

```typescript
products/entry/src/main/ets/entryability/EntryAbility.ets

import { HMRouterMgr } from '@hadss/hmrouter';

export default class EntryAbility extends UIAbility {
  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    // 初始化HmRouter
    HMRouterMgr.init({
      context: this.context,
    });
    this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onCreate');

  }
```

- 定义路由入口

将整个页面的初始化页面作为路由的入口

要求：

- 使用HmNavigation作为根容器，包裹所有子页面
- HmNavigaiton外层必须再包裹一个容器组件
- 实现一个继承类并且实例化，绑定HmNavigaiton的modifer属性

- 使用HmNavigation包裹入口组件

```ts
products/phone/src/main/ets/pages/Index.ets

import { AppBreakPoint, AppSafeArea, BreakPointType, HDMProgressLoading, PAGE_PATH, TabItem } from 'basic'
import { CartView } from 'cart'
import { CategoryView } from 'category'
import { HomeView } from 'home'
import { MineView } from 'mine'
import { AppStorageV2, AttributeUpdater } from '@kit.ArkUI'
import { HMDefaultGlobalAnimator, HMNavigation } from '@hadss/hmrouter'

class MyModifier extends AttributeUpdater<NavigationAttribute> {
  // 重写原来的方法
  initializeModifier(instance: NavigationAttribute): void {
    // instance就是Navigation实例对象
    instance.mode(NavigationMode.Stack) // 分栏模式去掉
    instance.titleMode(NavigationTitleMode.Mini) // 标题模式全屏
    instance.hideTitleBar(true) // 隐藏标题栏
  }
}

@Entry
@ComponentV2
struct Index {
  modifier: MyModifier = new MyModifier() // 专门用来修改Navigation特性对象实例
  appSafe: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  breakObj: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  @Local
  activeIndex: number = 0
  list: TabItem[] = [
    { text: '首页', normal: $r('app.media.ic_public_home_normal'), active: $r('app.media.ic_public_home_active') },
    { text: '分类', normal: $r('app.media.ic_public_pro_normal'), active: $r('app.media.ic_public_pro_active') },
    { text: '购物袋', normal: $r('app.media.ic_public_cart_normal'), active: $r('app.media.ic_public_cart_active') },
    { text: '我的', normal: $r('app.media.ic_public_my_normal'), active: $r('app.media.ic_public_my_active') },
  ]

  @Builder
  getTabItemBuilder(item: TabItem, index: number) {
    Column() {
      Image(this.activeIndex === index ? item.active : item.normal)
        .width(24)
        .aspectRatio(1)
      Text(item.text)// 跨 HSP 访问资源，需要在 oh-package.json5中导入
        .fontColor($r("[basic].color.black"))
        .fontSize(12)
    }
    .justifyContent(FlexAlign.SpaceEvenly)
    .height(50)
  }

  build() {
    Column() {
      // 使用HMNavigation包裹整个根容器 -坑点-HMNavigation外层必须再包一个容器
      // HMNavigation 是对navigation的封装
      // 坑点 子页面绝不能出现NavDestination
      // homePageUrl 是根页面的地址 想要回来直接写整个地址
      // 想要Navigation的特性
      HMNavigation({
        navigationId: PAGE_PATH.MAIN_PAGE_ID, homePageUrl: PAGE_PATH.MAIN_PAGE,
        options: {
          standardAnimator: HMDefaultGlobalAnimator.STANDARD_ANIMATOR,
          dialogAnimator: HMDefaultGlobalAnimator.DIALOG_ANIMATOR,
          modifier: this.modifier, // 修改Navigation的对象实例
          // 想要改一些Navigation的属性
        }

      }) {
        Tabs({
          barPosition: new BreakPointType({
            sm: BarPosition.End,
            md: BarPosition.End,
            lg: BarPosition.Start
          }).getValue(this.breakObj.breakPoint), index: $$this.activeIndex
        }) {
          ForEach(this.list, (item: TabItem, index: number) => {
            TabContent() {
              if (index === 0) {
                HomeView()
              } else if (index === 1) {
                CategoryView()
              } else if (index === 2) {
                CartView()
              } else {
                MineView()
              }
            }
            .tabBar(this.getTabItemBuilder(item, index))
          })
        }
        .barHeight(new BreakPointType({
          sm: 60,
          md: 60,
          lg: 220
        }).getValue(this.breakObj.breakPoint))
        .vertical(new BreakPointType({
          sm: false,
          md: false,
          lg: true
        }).getValue(this.breakObj.breakPoint))
        .scrollable(false)
        .animationDuration(new BreakPointType({
          sm: 300,
          md: 300,
          lg: 0
        }).getValue(this.breakObj.breakPoint))
        .padding({
          bottom: this.appSafe.bottomHeight
        })
      }
    }.height("100%")
  }
}
```

- 常量地址

```typescript
commons/basic/src/main/ets/constants/PAGE_PATH.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
}
```

## 1.2. 定义搜索页面，使用HmRouter声明地址

1. 新建一个组件SearchView, 位于Home模块下

- 定义搜索页面的常量地址

```ts
commons/basic/src/main/ets/constants/PagePath.ets

export class PAGE_PATH {
  static readonly MAIN_PAGE: string = "main_page"
  static readonly MAIN_PAGE_ID: string = "mainNavigation"
  static readonly SEARCH_PAGE: string = "SearchView"
}
```

- 在constants/index.ets中导出

```typescript
commons/basic/src/main/ets/constants/index.ets

export * from './PAGE_PATH'
```

**SearchView的模版**

```ts
features/home/src/main/ets/views/SearchView.ets

import { AppSafeArea, PAGE_PATH } from 'basic'
import { AppStorageV2 } from '@kit.ArkUI'
import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'

@HMRouter({ pageUrl: PAGE_PATH.SEARCH_PAGE })
@ComponentV2
export struct SearchView {
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  @Local keyword: string = ''

  build() {
    Column() {
      // search
      Row() {
        Image($r('[basic].media.ic_public_left'))
          .width(24)
          .aspectRatio(1)
          .fillColor($r('[basic].color.white'))
          .margin(13)
          .onClick(() => {
            HMRouterMgr.pop()
          })
        Search({ placeholder: '商品关键字...', value: this.keyword })
          .searchIcon({ src: $r('[basic].media.ic_public_search'), color: $r('[basic].color.gray') })
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .searchButton('搜索', { fontSize: 14, fontColor: $r('[basic].color.red') })
          .backgroundColor($r('[basic].color.white'))
          .textFont({ size: 14 })
          .layoutWeight(1)
          .padding(0)
          .margin(0)
          .height(36)
          .caretStyle({ color: $r('[basic].color.red') })
          .defaultFocus(true)
          .onSubmit((value) => {

          })


      }
      .padding({ top: this.safeArea.topHeight, right: 16 })
      .linearGradient({
        angle: 135,
        colors: [[$r('[basic].color.linear_begin'), 0], [$r('[basic].color.linear_end'), 1]]
      })

      // 语音搜索组件
    }
  }
}
```



点击搜索跳转-使用HMRouterMgr的push方法

- 默认的搜索区域
- 吸顶的搜索区域

```ts
features/home/src/main/ets/views/HomeView/HomeView.ets

import { HMRouterMgr } from '@hadss/hmrouter'

     Row() {
          Row({ space: 4 }) {
            Image($r('[basic].media.ic_public_search'))
              .width(16)
              .height(16)
              .fillColor($r('[basic].color.white'))
            Text('搜索...')
              .fontSize(14)
              .fontColor($r('[basic].color.white'))
          }
          .backgroundColor('#33999797')
          .width('100%')
          .height(40)
          .borderRadius(20)
          .padding({ left: 12 })
          .onClick(() => {
            HMRouterMgr.push({
              pageUrl: PAGE_PATH.SEARCH_PAGE
            })
          })
        }
```

分类模块也需要跳转

```ts
features/category/src/main/ets/views/CategoryView/CategoryView.ets

HDMNavBar({
        title: '分类',
        showLeftIcon: false,
        showRightIcon: true,
        rightIcon: $r("[basic].media.ic_public_search"),
        onRightClick: () => {
          HMRouterMgr.push({
            pageUrl: PAGE_PATH.SEARCH_PAGE
          })
        }
      }).border({ width: { bottom: 0.5 }, color: $r('[basic].color.under') })
```

搜索页实现返回

```ts
features/home/src/main/ets/views/SearchView/SearchView.ets
 
 Image($r('[basic].media.ic_public_left'))
          .width(24)
          .aspectRatio(1)
          .fillColor($r('[basic].color.white'))
          .margin(13)
          .onClick(() => {
            HMRouterMgr.pop() // 使用pop返回
          })
```





## 1.3. 搜索结果页添加及跳转逻辑

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717781575477-5dab8d28-e643-4e9d-a46b-9e1ca25d696f.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)

搜索页 => 搜索结果页 => 携带参数/键盘输入/语音输入

- 将搜索结果页name配置到basic的常量中

```ts
commons/basic/src/main/ets/constants/PagePath.ets

export class PAGE_PATH {
  static readonly LOGIN_PAGE: string = ""
  static readonly SEARCH_PAGE: string = "SearchView"
  static readonly SEARCH_RESULT_PAGE: string = "SearchResultView"
}
```

1. 新建搜索结果页的页面SearchResultView

- 新建SearchResultView的组件

```ts
features/home/src/main/ets/views/SearchResultView.ets

import { AppBreakPoint, AppSafeArea, BreakPointType, HDMGoodsItem, ListDataSource, PAGE_PATH } from 'basic'
import { SearchParams, SearchRouterParam, SortCompAttr, SortField, SortMethod } from '../viewmodels'
import { SearchSortItem } from './SearchSortItem'
import { HMRouter, HMRouterMgr } from '@hadss/hmrouter'
import { AppStorageV2 } from '@kit.ArkUI'
import { HDMGoods } from '../components'


@HMRouter({ pageUrl: PAGE_PATH.SEARCH_RESULT_PAGE })
@ComponentV2
export struct SearchResultView {
  breakPointClass: AppBreakPoint = AppStorageV2.connect(AppBreakPoint, () => new AppBreakPoint())!
  safeArea: AppSafeArea = AppStorageV2.connect(AppSafeArea, () => new AppSafeArea())!
  // 查询数据源
  lazyDataSource: ListDataSource<HDMGoodsItem> = new ListDataSource()
  // 查询参数
  params: SearchParams = new SearchParams()
  // 筛选条件
  sortList: SortCompAttr[] = [
    { label: '时间', field: 'publishTime' },
    { label: '销量', field: 'orderNum' },
    { label: '价格', field: 'price' }
  ]
  // 控制器
  scroller = new Scroller()

  aboutToAppear(): void {

  }

  build() {
    Column() {
      // 搜索区域
      Row() {
        Image($r('[basic].media.ic_public_left'))
          .width(24)
          .aspectRatio(1)
          .fillColor($r('[basic].color.white'))
          .margin(13)
          .onClick(() => {
            HMRouterMgr.pop()
          })
        Search({ placeholder: '商品关键字...', value: $$this.params.keyword })
          .searchIcon({ src: $r('[basic].media.ic_public_search'), color: $r('[basic].color.gray') })
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .backgroundColor($r('[basic].color.white'))
          .textFont({ size: 14 })
          .layoutWeight(1)
          .padding(0)
          .margin(0)
          .height(36)
          .caretStyle({ color: $r('[basic].color.red') })
          .onSubmit(() => {

          })
      }
      .padding({ top: this.safeArea.topHeight, right: 16 })
      .linearGradient({
        angle: 135,
        colors: [[$r('[basic].color.linear_begin'), 0], [$r('[basic].color.linear_end'), 1]]
      })

      // list
      Row() {
        ForEach(this.sortList, (item: SortCompAttr) => {
          // 筛选组件
          SearchSortItem({
            label: item.label,
            field: item.field,
            sortField: this.params.sortField,
            sortMethod: this.params.sortMethod,
            // onSortChange: (field: SortField, method: SortMethod) => {
            // }
          })
        })
        Text('筛选')
          .fontSize(14)
          .fontColor($r('[basic].color.gray'))
      }
      .padding({ left: 16, right: 16 })
      .height(50)
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .border({ width: { bottom: 0.5 }, color: $r('[basic].color.border') })

      WaterFlow({ scroller: this.scroller }) {
        LazyForEach(this.lazyDataSource, (item: HDMGoodsItem) => {
          FlowItem() {
            HDMGoods({ goods: item, smallImage: true })
          }
        })
      }
      .columnsTemplate(
        new BreakPointType({
          sm: '1fr 1fr',
          md: '1fr 1fr 1fr',
          lg: '1fr 1fr 1fr 1fr'
        })
          .getValue(this.breakPointClass.breakPoint)

      )
      .columnsGap(0.5)
      .rowsGap(0.5)
      .layoutWeight(1)
      .onReachEnd(async () => {

      })
    }
  }
}
```

- 新建search_result.ets的文件

```ts
features/home/src/main/ets/viewmodels/search_result.ets

// 联合类型
export type SortField = 'publishTime' | 'orderNum' | 'price'

export type SortMethod = 'desc' | 'asc'

// 提交给服务器的参数
// 提交给服务器的参数
@ObservedV2
export class SearchParams {
  @Trace
  keyword: string = ""
  @Trace
  sortField: SortField = "publishTime"
  @Trace
  sortMethod: SortMethod = "desc"
  page: number = 1
  pageSize: number = 10
}
// 筛选条件
export interface SortCompAttr {
  field: SortField
  label: string
}


// 路由参数
export interface SearchRouterParam {
  keyword: string
}
```

- 新建SearchSortItem组件

```ts
features/home/src/main/ets/views/SearchSortItem.ets

import { SortField, SortMethod } from '../viewmodels'

@ComponentV2
export struct SearchSortItem {
  // 筛选字段
  @Param
  field: SortField = 'publishTime'
  // 显示的文本
  @Param
  label: string = ''
  // 状态变量，接收父组件的状态属性
  // 父组件的筛选字段
  @Param sortField: SortField = 'publishTime'
  // 父组件的排序方法
  @Param sortMethod: SortMethod = 'desc'
  // 定义子传父的函数
  // @Event
  // onSortChange: (field: SortField, method: SortMethod) => void = () => {
  // }

  build() {
    Row() {
      Text(this.label)
        .fontWeight(500)
        .fontSize(14)
        .fontColor(this.sortField === this.field ? $r('[basic].color.black') : $r('[basic].color.gray'))
      Column() {
        Image($r('[basic].media.ic_public_up'))
          .width(15)
          .height(6)
          .fillColor(this.sortField === this.field && this.sortMethod === 'asc' ? $r('[basic].color.black') :
          $r('[basic].color.gray'))
        Image($r('[basic].media.ic_public_down'))
          .width(15)
          .height(6)
          .fillColor(this.sortField === this.field && this.sortMethod === 'desc' ? $r('[basic].color.black') :
          $r('[basic].color.gray'))
      }
      .justifyContent(FlexAlign.Center)
    }
    .onClick(() => {
      
     
    })
  }
}
```

- 点击搜索或者点击回车实现跳转

```ts
features/home/src/main/ets/views/SearchView.ets
 
 Search({ placeholder: '商品关键字...', value: this.keyword })
          .searchIcon({ src: $r('[basic].media.ic_public_search'), color: $r('[basic].color.gray') })
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .searchButton('搜索', { fontSize: 14, fontColor: $r('[basic].color.red') })
          .backgroundColor($r('[basic].color.white'))
          .textFont({ size: 14 })
          .layoutWeight(1)
          .padding(0)
          .margin(0)
          .height(36)
          .caretStyle({ color: $r('[basic].color.red') })
          .defaultFocus(true)
          .onSubmit((value) => {
            HMRouterMgr.push({
              pageUrl: PAGE_PATH.SEARCH_RESULT_PAGE,
              param: { keyword: value } 
            })
          })
```

1. 在搜索结果页进行数据接收

```ts
features/home/src/main/ets/views/SearchResultView/SearchResultView.ets

aboutToAppear(): void {
    const params = HMRouterMgr.getCurrentParam() as SearchRouterParam
    AlertDialog.show({ message: JSON.stringify(params) })
  }
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743146963971-fc31c37b-6184-4e50-8ec9-9a2b83284de4.png)



## 1.4. 响应式更新特性-ObservedV2和Trace

V2拥有了深度监听

Local只能监测整体赋值，可以监测数组的添加删除和移动

State可以监测整体赋值 和第一层的数据变化

ObservedV2修饰的对象和Trace修饰的对象会加个__ob_

面试吐槽点：

ObservedV2和Trace 必须new才具备响应式！不new不具备响应式！！！！

```typescript
JSON.parse(JSON.stringify(this.params).replace(/__ob_/g, "")) as SearchParams
```



## 1.5. 搜索数据查询-上拉加载-搜索刷新

基于查询参数，获取数据并渲染

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717803165689-36217e4d-e2c0-40b1-ab56-f64076aa3d49.png)

**注意：**

1. 查询有2次：

1. 1. 由 搜索页跳转 到 搜索结果页 时查询
   2. 搜索结果页 中 点击搜索 时查询 (后续处理)

1. 现有的 post 的提交参数类型没有指定，需要指定一下类型
2. 实现接口函数: searchGoodsApi
3. 调用接口函数实现查询

- 在搜索类型文件中定义一个返回类型

```ts
features/home/src/main/ets/viewmodels/search_result.ets

// 定义搜索结果类型
export interface SearchResult {
  // conditions:
  pageData: GoodsItems
}
```

- 封装API

```ts
features/home/src/main/ets/api/search.ets

import { RequestRcp } from "basic";
import { SearchParams, SearchResult } from "../viewmodels";


export const getSearchResultAPI = (data: SearchParams) =>
RequestRcp.post<SearchResult>("/search/all", data)
```



- 在初始化中获取数据

```ts
  features/home/src/main/ets/views/SearchResultView.ets

  @Local
  list: HDMGoodsItem[] = []

  aboutToAppear(): void {
    const params = HMRouterMgr.getCurrentParam() as SearchRouterParam
    this.params.keyword = params.keyword
    this.getSearchResult()
  }

  // 获取搜索结果
  async getSearchResult() {
    // 第一种方案
    // const result = await getSearchResultAPI({
    //   keyword: this.params.keyword,
    //   page: this.params.page,
    //   pageSize: this.params.pageSize,
    //   sortField: this.params.sortField,
    //   sortMethod: this.params.sortMethod
    // }) 
    
    // 第二种方案
    // const result =
    // await getSearchResultAPI(JSON.parse(JSON.stringify(this.params).replaceAll(/__ob_/g, "")) as SearchParams)
    
    // 第三种方案: 拦截器中统一处理
    const result = await getSearchResultAPI(this.params)
    this.list = result.pageData.items
  }
```

- 监听WaterFlow的onReachEnd事件，并实现WaterFlow的适配和底部提示

```typescript
features/home/src/main/ets/views/SearchResultView.ets
 
WaterFlow({ scroller: this.scroller }) {
        Repeat<HDMGoodsItem>(this.list).each((obj: RepeatItem<HDMGoodsItem>) => {
          FlowItem() {
            HDMGoods({ goods: obj.item, smallImage: true })
          }
        })
          .key((item: HDMGoodsItem, index: number) => `${index}_${JSON.stringify(item)}`)
        // LazyForEach(this.lazyDataSource, (item: HDMGoodsItem) => {
        //   FlowItem() {
        //     HDMGoods({ goods: item, smallImage: true })
        //   }
        // })
      }
```

- 统一在rcp中处理ObservedV2字段变更问题

```typescript
commons/basic/src/main/ets/utils/RequestRcp.ets

class RcpRequestInterceptor implements rcp.Interceptor {
  // context上下文 -请求上下文
  async intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    // to from next(必须要执行的函数)
    // next传递到下一个
    // throw new Error("Method not implemented.");
    // axios返回类型无法更改！！！
    // 请求拦截器
    if (typeof context.request.content === 'object') {
      context.request.content =
        JSON.parse(JSON.stringify(context.request.content).replace(/__ob_/g, "")) as rcp.RequestContent
    }

    // TODO 注入token
    return next.handle(context) // 将结构返回下一个执行链

  }
}
```

- 实现上拉加载
- 定义loading 和finished

```typescript
  features/home/src/main/ets/views/SearchResultView.ets

  @Local
  loading: boolean = false // 正在加载
  @Local
  finished: boolean = false // 是否完成
```

- 实现onReachEnd事件

```typescript
 features/home/src/main/ets/views/SearchResultView.ets

  .onReachEnd(async () => {
        if (!this.loading && !this.finished) {
          this.loading = true
          await this.getSearchResult()
          this.loading = false
        }
      })
```

- 改造加载数据的方法

```typescript
features/home/src/main/ets/views/SearchResultView.ets

// 获取搜索结果
  async getSearchResult() {
    // 第一种方案
    // const result = await getSearchResultAPI({
    //   keyword: this.params.keyword,
    //   page: this.params.page,
    //   pageSize: this.params.pageSize,
    //   sortField: this.params.sortField,
    //   sortMethod: this.params.sortMethod
    // }) //
    // 第二种方案
    // const result =
    // await getSearchResultAPI(JSON.parse(JSON.stringify(this.params).replaceAll(/__ob_/g, "")) as SearchParams)
    // 第三种处理
    const result = await getSearchResultAPI(this.params) // 第10页数据
    this.list.push(...result.pageData.items)
    // 10 - 10 一共10页
    if (this.params.page >= result.pageData.pages) {
      this.finished = true
    } else {
      this.params.page++
    }
  }
```

- 底部提示builder

```typescript
features/home/src/main/ets/views/SearchResultView.ets

@Builder
  getFootBuilder() {
    Row({ space: 10 }) {
      if (this.loading) {
        Text("加载中...")
          .fontSize(12)
          .fontColor($r("[basic].color.gray"))
        LoadingProgress()
          .width(20)
          .aspectRatio(1)
      } else {
        if (this.finished) {
          Text("没有更多啦")
            .fontSize(12)
            .fontColor($r("[basic].color.gray"))
        }
      }
    }
    .justifyContent(FlexAlign.Center)
    .width("100%")
    .height(50)
  }
 
```

```
WaterFlow({ scroller: this.scroller, footer: this.getFootBuilder() }) {
    Repeat<HDMGoodsItem>(this.list).each((obj: RepeatItem<HDMGoodsItem>) => {
      FlowItem() {
        HDMGoods({ goods: obj.item, smallImage: true })
      }
    })
      .virtualScroll() // 开启虚拟化
      .key((item: HDMGoodsItem, index: number) => `${index}_${JSON.stringify(item)}`)
 }
```

虚拟滚动是一种优化技术:

- 它只会渲染可视区域内的组件
- 而非一次性渲染全部内容，即便数据源规模很大。

- 在搜索结果页点击搜索

```ts
features/home/src/main/ets/views/SearchResultView/SearchResultView.ets
 
 Search({ placeholder: '商品关键字...', value: $$this.params.keyword })
          .searchIcon({ src: $r('[basic].media.ic_public_search'), color: $r('[basic].color.gray') })
          .placeholderColor($r('[basic].color.gray'))
          .placeholderFont({ size: 14 })
          .backgroundColor($r('[basic].color.white'))
          .textFont({ size: 14 })
          .layoutWeight(1)
          .padding(0)
          .margin(0)
          .height(36)
          .caretStyle({ color: $r('[basic].color.red') })
          .onSubmit(() => {
            this.params.page = 1
            this.list = [] // 重新赋值为空
            this.finished = false
            this.getSearchResult()
          })
```

![img](https://cdn.nlark.com/yuque/0/2025/png/8435673/1743154461574-accc430b-b960-4fcc-9a9c-738ee106f36c.png)



## 1.6. 搜索商品排序

**需求：**

1. 子组件提供回调函数 onClickItem

1. 1. 回传 sortField 和 sortMethod 给父组件

1. 子组件实现点击

1. 1. 排序字段相同, 则修改排序方式(升序->降序, 降序->升序)
   2. 排序字段不同, 采用默认排序方式desc
   3. 调用onClickItem函数

1. 父组件实现回调函数

1. 1. 得到 sortField 和 sortMethod 赋值给查询参数对象
   2. 重新获取数据



![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717804540225-12fca4ce-ab1e-428e-97d4-3bc264884077.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717804517523-c458dbe2-6305-4a8c-bf73-c82f5caa0b1a.png)

![img](https://cdn.nlark.com/yuque/0/2024/png/639379/1717804827838-81cd55a4-e5ac-4f44-bce5-17ac34a8bc85.png)

- 子组件声明一个函数

```ts
  features/home/src/main/ets/views/SearchSortItem.ets

  // 定义子传父的函数
  @Event
  onSortChange: (field: SortField, method: SortMethod) => void = () => {
  }
```

- 子组件的点击事件传出当前的排序字段和排序方式

```ts
build() {
    Row() {
      Text(this.label)
        .fontWeight(500)
        .fontSize(14)
        .fontColor(this.sortField === this.field ? $r('[basic].color.black') : $r('[basic].color.gray'))
      Column() {
        Image($r('[basic].media.ic_public_up'))
          .width(15)
          .height(6)
          .fillColor(this.sortField === this.field && this.sortMethod === 'asc' ? $r('[basic].color.black') :
          $r('[basic].color.gray'))
        Image($r('[basic].media.ic_public_down'))
          .width(15)
          .height(6)
          .fillColor(this.sortField === this.field && this.sortMethod === 'desc' ? $r('[basic].color.black') :
          $r('[basic].color.gray'))
      }
      .justifyContent(FlexAlign.Center)
    }
    .onClick(() => {
        // 排序字段相同,修改排序方式
      if (this.field === this.sortField) {
        this.onSortChange(this.field, this.sortMethod === "asc" ? "desc" : 'asc')
      } else {
         // 排序字段不同，排序方式 desc，修改排序字段
        this.onSortChange(this.field, "desc") // 如果选择不是一个字段 默认按照倒序
      }
    })
  }
```

- 在搜索结果页监听事件

```ts
features/home/src/main/ets/views/SearchResultView.ets
        
         
         SearchSortItem({
            label: item.label,
            field: item.field,
            sortField: this.params.sortField,
            sortMethod: this.params.sortMethod,
            onSortChange: (field: SortField, method: SortMethod) => {
              this.params.sortField = field // 相当于重新加载数据 排序字段
              this.params.sortMethod = method // 排序方式
              this.onRefresh()
            }

          })
```

- 封装onrefesh方法

```typescript
features/home/src/main/ets/views/SearchResultView.ets

onRefresh() {
    this.params.page = 1
    this.list = [] // 重新赋值为空
    this.finished = false
    this.getSearchResult()
  }
```

