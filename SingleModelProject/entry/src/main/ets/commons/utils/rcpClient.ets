import { rcp } from '@kit.RemoteCommunicationKit'
import { Choices, LLMData } from '../../models'
import { util } from '@kit.ArkTS'


// è‡ªå®šä¹‰æ‹¦æˆªå™¨ Interceptor  å¹¶ä¸”è¦å®ç°æ¥å£
//å¤–å±‚çš„ç±»çš„å®šä¹‰ æ‰©å±•
const url='https://maas-cn-southwest-2.modelarts-maas.com/v1/infers/271c9332-4aa6-4ff5-95b3-0cf8bd94c394/v1/chat/completions'
const key='wpWhoozWVZwbF7l0RFcSyhQ_f715RKe4lLX1hv9pVEXowWYqiXzBRYFsR2G5MIO9SUGHYkCDfWMsstNO5p5q3A'

class myInterceptor implements rcp.Interceptor{
  // asyncå»æ‰
   intercept(context: rcp.RequestContext, next: rcp.RequestHandler): Promise<rcp.Response> {
    // throw new Error('Method not implemented.')
    // this.step()
    // this.step2()
    // this.step3()
    context.request.headers!.authorization=`Bearer ${key}`
    // context.header.cookies='xxxx'

    // context.header.authorization='Bearer token 123456789'

    // let response=await next.handle(context)  //å½“å·²ç»æ²¡æœ‰ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨æ—¶ æ­£å¸¸å‘httpè¯·æ±‚
    // if(response.statusCode==401){
    //   // åˆ·æ–°token
    //   return Promise.reject('fail')
    // }
    return next.handle(context)  //å¤šä¸ªæ‹¦æˆªå™¨ä¹‹é—´ä¼ é€’æ•°æ®  context


  }
  // æ­¥éª¤1,2,3
  step(){}
  step2(){}
  step3(){}
}

// const url: string = 'https://maas-cn-southwest-2.modelarts-maas.com/v1/infers/271c9332-4aa6-4ff5-95b3-0cf8bd94c394/v1/chat/completions'
//å°è£… ä¸“é—¨ç”¨äºå¤„ç†å¤§è¯­è¨€æ¨¡å‹çš„ç±»
class RcpClient{
  session:rcp.Session|null = null
  globalFn:(content:string,finish:string|null)=>void = (content: string, finish: string | null)=>{}
  globalRequest:rcp.Request|null = null
  initSession(){
    // åˆ›å»ºä¼šè¯
    let session=rcp.createSession({
      //æŸ¥æ‰¾é€‰æ‹©å™¨å…·ä½“ä»£ç æ—¶ ä¼šè‡ªåŠ¨è°ƒç”¨ç±»çš„intercept()
      interceptors:[
        new myInterceptor(),
      ],
      requestConfiguration:{
        transfer:{
          timeout:{connectMs:10000} //æœ€å¤§è¿æ¥æ—¶é—´
        },
        tracing:{ //è¿½è¸ªhttpå“åº”çš„è¯¦ç»†ä¿¡æ¯
          // ç›‘å¬ æ¯æ¬¡æœåŠ¡å™¨å“åº”çš„æ•°æ® è¯¦ç»†ä¿¡æ¯
          httpEventsHandler:{
            //æ¥æ”¶æ•°æ®
            onDataReceive:(ArrayBuffer)=>{
              //ä¸ºæ”¶åˆ°çš„httpæ•°æ®(äºŒè¿›åˆ¶æ•°æ®)
              //ArrayBufferæ˜¯äºŒè¿›åˆ¶æ•°æ®å®¹å™¨  0,1 æ˜¯ä¸å¯ä»¥ç›´æ¥è½¬æˆå­—ç¬¦ä¸²
              // ç„¶åç”±unit8Arrayè½¬æˆå­—ç¬¦ä¸²
              // è½¬unit8
              let unit8=new Uint8Array(ArrayBuffer)
              //è½¬str
              let decoder=new util.TextDecoder()
              let str =decoder.decodeToString(unit8)
              console.log('str'+ str)   //SSE æµå¼è¿”å›æ•°æ®
              let forMat=str.split("data: ")[1].split("\n")[0]   //å¾—åˆ°åªåŒ…å«sseå¯¹è±¡çš„å­—ç¬¦ä¸²
              if(forMat.includes('choices')){
                //æ£€æŸ¥è¿”å›çš„æ•°æ®ä¸­æ˜¯å¦åŒ…å«choice æˆ‘ä»¬è¦çš„éƒ¨åˆ†
                // console.log('id:'+JSON.parse(forMat).id) //å¾—åˆ°äº†id
                let  choices:Choices=JSON.parse(forMat).choices[0]
                if(choices){
                  console.log(choices.delta.content + '' + choices.finish_reason)
                  this.globalFn(choices.delta.content,choices.finish_reason)  //è°ƒç”¨å‡½æ•°
                }
              }
            }
          }
        }
      }
    })
    this.session=session

  }

  async sendToLLM(data:LLMData, callback:(content: string, finish: string | null)=>void){

    if(!this.session){
      // åˆ›å»ºä¼šè¯  å…¨å±€ä¼šè¯å¦‚æœä¸å­˜åœ¨ä¼šè¯ åˆ™åˆ›å»º åˆå§‹åŒ–ä¸€æ¬¡
      this.initSession()
    }
    this.globalFn=callback
    //å‘è¯·æ±‚

    //é¸¿è’™åŸç”Ÿçš„sessionä¼šè¯å›ç­”httpè¯·æ±‚ä¸­ æœ‰ get put post delete fetch()
    // xhr =new XMLHttpRequest()  ajax->axios æ”¯æŒpromiseå›è°ƒ
    // fetch åŸç”Ÿå°±æ”¯æŒpromiseå›è°ƒ åœ¨é¸¿è’™ä¸­sessionä¸­get put post delete é»˜è®¤å¹¶æ²¡æœ‰å®ç°ä¸­é€”å–æ¶ˆå‘é€è¯·æ±‚
    //fetch åœ¨å‘é€è¯·æ±‚å‰ éœ€è¦åŒ…è£… è¯·æ±‚ ,åœ¨è¿™ä¸ªåŒ…ä¸­ å°±å®ç°ä¸­é—´å–æ¶ˆå‘é€è¯·æ±‚
    //  this.session?.post(url,data) //ä¸ä½¿ç”¨å¼‚æ­¥ å¯ä»¥å¼‚æ­¥è¿”å›æ•°æ®æµ‹è¯•
    this.globalRequest=new rcp.Request(url,'POST',{},data) //åŒ…è£…è¯·æ±‚  (ç±»)
    let res=await this.session?.fetch(this.globalRequest) //æ›´æ¢ä¸ºfetchè¯·æ±‚å®ç°ä¸­é€”å–æ¶ˆå‘é€è¯·æ±‚
    console.log('res:'+ JSON.stringify(res))

    /* {"id":"chat-78a3750ff3bc4a13bf9d41ee4029be04","object":"chat.completion","created":1753953900,"model":"DeepSeek-V3","choices":[{"index":0,"message":{"role":"assistant","content":"ä½ å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼ŸğŸ˜Š","reasoning_content":null,"tool_calls":[]},"logprobs":null,"finish_reason":"stop","stop_reason":null}],"usage":{"prompt_tokens":10,"total_tokens":21,"completion_tokens":11},"prompt_logprobs":null}
     * */
  }

  cancelSend() {
    this.session?.cancel(this.globalRequest)
  }
}

export const rcpClient=new RcpClient()